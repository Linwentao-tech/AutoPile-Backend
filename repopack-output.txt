This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repopack on: 2025-02-20T17:38:32.527Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repopack's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

Additional Info:
----------------

For more information about Repopack, visit: https://github.com/yamadashy/repopack

================================================================
Repository Structure
================================================================
.gitattributes
.github/workflows/develop_autopile.yml
.gitignore
AutoPile.API/appsettings.Development.json
AutoPile.API/appsettings.json
AutoPile.API/AutoPile.API.csproj
AutoPile.API/AutoPile.API.http
AutoPile.API/Controllers/AuthController.cs
AutoPile.API/Controllers/OrderController.cs
AutoPile.API/Controllers/PaymentController.cs
AutoPile.API/Controllers/ProductController.cs
AutoPile.API/Controllers/ReviewController.cs
AutoPile.API/Controllers/ShoppingCartItemController.cs
AutoPile.API/Mapping/MappingProfile.cs
AutoPile.API/Program.cs
AutoPile.API/Properties/launchSettings.json
AutoPile.API/Validators/OrderItemRequestValidator.cs
AutoPile.API/Validators/OrderItemUpdateValidator.cs
AutoPile.API/Validators/OrderRequestValidator.cs
AutoPile.API/Validators/OrderUpdateValidator.cs
AutoPile.API/Validators/ProductMediaRequestValidator.cs
AutoPile.API/Validators/ProductRequestValidator.cs
AutoPile.API/Validators/ReviewRequestValidator.cs
AutoPile.API/Validators/ReviewUpdateValidator.cs
AutoPile.API/Validators/ShoppingCartItemValidator.cs
AutoPile.API/Validators/UserSigninDTOValidator.cs
AutoPile.API/Validators/ValidateTokenRequestValidator.cs
AutoPile.DATA/AutoPile.DATA.csproj
AutoPile.DATA/Cache/CacheKeys.cs
AutoPile.DATA/Cache/CacheRepository/RedisCache.cs
AutoPile.DATA/Cache/OrderCache.cs
AutoPile.DATA/Cache/ProductCache.cs
AutoPile.DATA/Cache/RedisShoppingCartCache.cs
AutoPile.DATA/Cache/ReviewsCache.cs
AutoPile.DATA/Cache/UserInfoCache.cs
AutoPile.DATA/Configurations/OrderConfigurations.cs
AutoPile.DATA/Configurations/OrderItemConfigurations.cs
AutoPile.DATA/Configurations/ProductConfigurations.cs
AutoPile.DATA/Configurations/ShoppingCartItemConfigurations.cs
AutoPile.DATA/Data/AutoPileManagementDbContext.cs
AutoPile.DATA/Data/AutoPileMongoDbContext.cs
AutoPile.DATA/Exceptions/AbstractHTTPexception.cs
AutoPile.DATA/Exceptions/BadRequestException.cs
AutoPile.DATA/Exceptions/NotFoundException.cs
AutoPile.DATA/Exceptions/UnauthorizedException.cs
AutoPile.DATA/Middlewares/ExceptionHandlingMiddleware.cs
AutoPile.DATA/Middlewares/UserIdExtractMiddleware.cs
AutoPile.DATA/Migrations/20241227180443_InitialCreate.cs
AutoPile.DATA/Migrations/20241227180443_InitialCreate.Designer.cs
AutoPile.DATA/Migrations/20241229055646_AddEmailVerifyTokenCreatedAt.cs
AutoPile.DATA/Migrations/20241229055646_AddEmailVerifyTokenCreatedAt.Designer.cs
AutoPile.DATA/Migrations/20250107151641_change.cs
AutoPile.DATA/Migrations/20250107151641_change.Designer.cs
AutoPile.DATA/Migrations/20250122173340_initialCreate2.cs
AutoPile.DATA/Migrations/20250122173340_initialCreate2.Designer.cs
AutoPile.DATA/Migrations/20250207175947_refreshTokenCreate.cs
AutoPile.DATA/Migrations/20250207175947_refreshTokenCreate.Designer.cs
AutoPile.DATA/Migrations/AutoPileManagementDbContextModelSnapshot.cs
AutoPile.DOMAIN/AutoPile.DOMAIN.csproj
AutoPile.DOMAIN/DTOs/Requests/OrderCreateDTO.cs
AutoPile.DOMAIN/DTOs/Requests/OrderItemCreateDTO.cs
AutoPile.DOMAIN/DTOs/Requests/OrderItemUpdateDTO.cs
AutoPile.DOMAIN/DTOs/Requests/OrderUpdateDTO.cs
AutoPile.DOMAIN/DTOs/Requests/PaymentIntentCreate.cs
AutoPile.DOMAIN/DTOs/Requests/ProductCreateDTO.cs
AutoPile.DOMAIN/DTOs/Requests/ProductMediaCreateDTO.cs
AutoPile.DOMAIN/DTOs/Requests/ProductMediaUpdateDTO.cs
AutoPile.DOMAIN/DTOs/Requests/ProductUpdateDTO.cs
AutoPile.DOMAIN/DTOs/Requests/ReviewCreateDTO.cs
AutoPile.DOMAIN/DTOs/Requests/ReviewUpdateDTO.cs
AutoPile.DOMAIN/DTOs/Requests/ShoppingCartItemRequestDTO.cs
AutoPile.DOMAIN/DTOs/Requests/TokenRefreshRequest.cs
AutoPile.DOMAIN/DTOs/Requests/UserResetPasswordDTO.cs
AutoPile.DOMAIN/DTOs/Requests/UserSigninDTO.cs
AutoPile.DOMAIN/DTOs/Requests/UserSignupDTO.cs
AutoPile.DOMAIN/DTOs/Requests/UserUpdateInfoDTO.cs
AutoPile.DOMAIN/DTOs/Requests/ValidateTokenRequest.cs
AutoPile.DOMAIN/DTOs/Responses/OrderItemResponseDTO.cs
AutoPile.DOMAIN/DTOs/Responses/OrderResponseDTO.cs
AutoPile.DOMAIN/DTOs/Responses/ProductMediaResponseDTO.cs
AutoPile.DOMAIN/DTOs/Responses/ProductResponseDTO.cs
AutoPile.DOMAIN/DTOs/Responses/ReviewImageDTO.cs
AutoPile.DOMAIN/DTOs/Responses/ReviewResponseDTO.cs
AutoPile.DOMAIN/DTOs/Responses/ShoppingCartItemResponseDTO.cs
AutoPile.DOMAIN/DTOs/Responses/TokenRefreshResponse .cs
AutoPile.DOMAIN/DTOs/Responses/UserInfoResponseDTO.cs
AutoPile.DOMAIN/DTOs/Responses/UserResponseDTO.cs
AutoPile.DOMAIN/Enum/Category.cs
AutoPile.DOMAIN/Enum/OrderStatus.cs
AutoPile.DOMAIN/Enum/PaymentStatus.cs
AutoPile.DOMAIN/Enum/Ribbon.cs
AutoPile.DOMAIN/Interface/IAuthService.cs
AutoPile.DOMAIN/Interface/IBlobService.cs
AutoPile.DOMAIN/Interface/IEmailQueueService.cs
AutoPile.DOMAIN/Interface/IExceptionHandler.cs
AutoPile.DOMAIN/Interface/IInventoryQueueService.cs
AutoPile.DOMAIN/Interface/IJwtTokenGenerator.cs
AutoPile.DOMAIN/Interface/IOrderCache.cs
AutoPile.DOMAIN/Interface/IOrderItemService.cs
AutoPile.DOMAIN/Interface/IOrderService.cs
AutoPile.DOMAIN/Interface/IPaymentService.cs
AutoPile.DOMAIN/Interface/IProductCache.cs
AutoPile.DOMAIN/Interface/IProductService.cs
AutoPile.DOMAIN/Interface/IRedisCache.cs
AutoPile.DOMAIN/Interface/IRedisShoppingCartCache.cs
AutoPile.DOMAIN/Interface/IReviewsCache.cs
AutoPile.DOMAIN/Interface/IReviewService.cs
AutoPile.DOMAIN/Interface/IShoppingCartItemService.cs
AutoPile.DOMAIN/Interface/IStripeService.cs
AutoPile.DOMAIN/Interface/IUserInfoCache.cs
AutoPile.DOMAIN/Models/ApiResponse.cs
AutoPile.DOMAIN/Models/Entities/ApplicationRole.cs
AutoPile.DOMAIN/Models/Entities/ApplicationUser.cs
AutoPile.DOMAIN/Models/Entities/Order.cs
AutoPile.DOMAIN/Models/Entities/OrderItem.cs
AutoPile.DOMAIN/Models/Entities/Product.cs
AutoPile.DOMAIN/Models/Entities/ProductMedia.cs
AutoPile.DOMAIN/Models/Entities/Review.cs
AutoPile.DOMAIN/Models/Entities/ShoppingCartItem.cs
AutoPile.DOMAIN/Models/MessageQueue/EmailMessage.cs
AutoPile.SERVICE/AutoPile.SERVICE.csproj
AutoPile.SERVICE/Services/AuthService.cs
AutoPile.SERVICE/Services/BlobService.cs
AutoPile.SERVICE/Services/EmailProcessingService.cs
AutoPile.SERVICE/Services/EmailQueueService.cs
AutoPile.SERVICE/Services/InventoryProcessingService.cs
AutoPile.SERVICE/Services/InventoryQueueService.cs
AutoPile.SERVICE/Services/OrderItemService.cs
AutoPile.SERVICE/Services/OrderService.cs
AutoPile.SERVICE/Services/PaymentService.cs
AutoPile.SERVICE/Services/ProductService.cs
AutoPile.SERVICE/Services/ReviewService.cs
AutoPile.SERVICE/Services/ShoppingCartItemService.cs
AutoPile.SERVICE/Services/StripeService.cs
AutoPile.SERVICE/Utilities/EmailConfirmationHtmlTemplates.cs
AutoPile.SERVICE/Utilities/JwtTokenGenerator.cs
AutoPile.SERVICE/Utilities/OrderNumberGenerator.cs
AutoPile.SERVICE/Utilities/RefreshTokenGenerator.cs
AutoPile.sln
AutoPile.UnitTests/AuthServiceTests.cs
AutoPile.UnitTests/AutoPile.UnitTests.csproj
AutoPile.UnitTests/PaymentServiceTests.cs
AutoPile.UnitTests/ReviewServiceTests.cs

================================================================
Repository Files
================================================================

================
File: .gitattributes
================
###############################################################################
# Set default behavior to automatically normalize line endings.
###############################################################################
* text=auto

###############################################################################
# Set default behavior for command prompt diff.
#
# This is need for earlier builds of msysgit that does not have it on by
# default for csharp files.
# Note: This is only used by command line
###############################################################################
#*.cs     diff=csharp

###############################################################################
# Set the merge driver for project and solution files
#
# Merging from the command prompt will add diff markers to the files if there
# are conflicts (Merging from VS is not affected by the settings below, in VS
# the diff markers are never inserted). Diff markers may cause the following 
# file extensions to fail to load in VS. An alternative would be to treat
# these files as binary and thus will always conflict and require user
# intervention with every merge. To do so, just uncomment the entries below
###############################################################################
#*.sln       merge=binary
#*.csproj    merge=binary
#*.vbproj    merge=binary
#*.vcxproj   merge=binary
#*.vcproj    merge=binary
#*.dbproj    merge=binary
#*.fsproj    merge=binary
#*.lsproj    merge=binary
#*.wixproj   merge=binary
#*.modelproj merge=binary
#*.sqlproj   merge=binary
#*.wwaproj   merge=binary

###############################################################################
# behavior for image files
#
# image files are treated as binary by default.
###############################################################################
#*.jpg   binary
#*.png   binary
#*.gif   binary

###############################################################################
# diff behavior for common document formats
# 
# Convert binary document formats to text before diffing them. This feature
# is only available from the command line. Turn it on by uncommenting the 
# entries below.
###############################################################################
#*.doc   diff=astextplain
#*.DOC   diff=astextplain
#*.docx  diff=astextplain
#*.DOCX  diff=astextplain
#*.dot   diff=astextplain
#*.DOT   diff=astextplain
#*.pdf   diff=astextplain
#*.PDF   diff=astextplain
#*.rtf   diff=astextplain
#*.RTF   diff=astextplain

================
File: .github/workflows/develop_autopile.yml
================
# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy ASP.Net Core app to Azure Web App - autopile

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Build with dotnet
        run: dotnet build --configuration Release

      - name: dotnet publish
        run: dotnet publish -c Release -o "${{env.DOTNET_ROOT}}/myapp"

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: .net-app
          path: ${{env.DOTNET_ROOT}}/myapp

  deploy:
    runs-on: windows-latest
    needs: build
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: .net-app
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_3C4C651FF6524979BB965B0354E38839 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_E7E02745BF6745CAB9A2556BC9589083 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_7358A5EDABA14CFC8A46942662980678 }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'autopile'
          slot-name: 'Production'
          package: .

================
File: .gitignore
================
## Ignore Visual Studio temporary files, build results, and
## files generated by popular Visual Studio add-ons.
##
## Get latest from https://github.com/github/gitignore/blob/master/VisualStudio.gitignore

# User-specific files
*.rsuser
*.suo
*.user
*.userosscache
*.sln.docstates

# User-specific files (MonoDevelop/Xamarin Studio)
*.userprefs

# Mono auto generated files
mono_crash.*

# Build results
[Dd]ebug/
[Dd]ebugPublic/
[Rr]elease/
[Rr]eleases/
x64/
x86/
[Ww][Ii][Nn]32/
[Aa][Rr][Mm]/
[Aa][Rr][Mm]64/
bld/
[Bb]in/
[Oo]bj/
[Oo]ut/
[Ll]og/
[Ll]ogs/

# Visual Studio 2015/2017 cache/options directory
.vs/
# Uncomment if you have tasks that create the project's static files in wwwroot
#wwwroot/

# Visual Studio 2017 auto generated files
Generated\ Files/

# MSTest test Results
[Tt]est[Rr]esult*/
[Bb]uild[Ll]og.*

# NUnit
*.VisualState.xml
TestResult.xml
nunit-*.xml

# Build Results of an ATL Project
[Dd]ebugPS/
[Rr]eleasePS/
dlldata.c

# Benchmark Results
BenchmarkDotNet.Artifacts/

# .NET Core
project.lock.json
project.fragment.lock.json
artifacts/

# ASP.NET Scaffolding
ScaffoldingReadMe.txt

# StyleCop
StyleCopReport.xml

# Files built by Visual Studio
*_i.c
*_p.c
*_h.h
*.ilk
*.meta
*.obj
*.iobj
*.pch
*.pdb
*.ipdb
*.pgc
*.pgd
*.rsp
*.sbr
*.tlb
*.tli
*.tlh
*.tmp
*.tmp_proj
*_wpftmp.csproj
*.log
*.vspscc
*.vssscc
.builds
*.pidb
*.svclog
*.scc

# Chutzpah Test files
_Chutzpah*

# Visual C++ cache files
ipch/
*.aps
*.ncb
*.opendb
*.opensdf
*.sdf
*.cachefile
*.VC.db
*.VC.VC.opendb

# Visual Studio profiler
*.psess
*.vsp
*.vspx
*.sap

# Visual Studio Trace Files
*.e2e

# TFS 2012 Local Workspace
$tf/

# Guidance Automation Toolkit
*.gpState

# ReSharper is a .NET coding add-in
_ReSharper*/
*.[Rr]e[Ss]harper
*.DotSettings.user

# TeamCity is a build add-in
_TeamCity*

# DotCover is a Code Coverage Tool
*.dotCover

# AxoCover is a Code Coverage Tool
.axoCover/*
!.axoCover/settings.json

# Coverlet is a free, cross platform Code Coverage Tool
coverage*.json
coverage*.xml
coverage*.info

# Visual Studio code coverage results
*.coverage
*.coveragexml

# NCrunch
_NCrunch_*
.*crunch*.local.xml
nCrunchTemp_*

# MightyMoose
*.mm.*
AutoTest.Net/

# Web workbench (sass)
.sass-cache/

# Installshield output folder
[Ee]xpress/

# DocProject is a documentation generator add-in
DocProject/buildhelp/
DocProject/Help/*.HxT
DocProject/Help/*.HxC
DocProject/Help/*.hhc
DocProject/Help/*.hhk
DocProject/Help/*.hhp
DocProject/Help/Html2
DocProject/Help/html

# Click-Once directory
publish/

# Publish Web Output
*.[Pp]ublish.xml
*.azurePubxml
# Note: Comment the next line if you want to checkin your web deploy settings,
# but database connection strings (with potential passwords) will be unencrypted
*.pubxml
*.publishproj

# Microsoft Azure Web App publish settings. Comment the next line if you want to
# checkin your Azure Web App publish settings, but sensitive information contained
# in these scripts will be unencrypted
PublishScripts/

# NuGet Packages
*.nupkg
# NuGet Symbol Packages
*.snupkg
# The packages folder can be ignored because of Package Restore
**/[Pp]ackages/*
# except build/, which is used as an MSBuild target.
!**/[Pp]ackages/build/
# Uncomment if necessary however generally it will be regenerated when needed
#!**/[Pp]ackages/repositories.config
# NuGet v3's project.json files produces more ignorable files
*.nuget.props
*.nuget.targets

# Microsoft Azure Build Output
csx/
*.build.csdef

# Microsoft Azure Emulator
ecf/
rcf/

# Windows Store app package directories and files
AppPackages/
BundleArtifacts/
Package.StoreAssociation.xml
_pkginfo.txt
*.appx
*.appxbundle
*.appxupload

# Visual Studio cache files
# files ending in .cache can be ignored
*.[Cc]ache
# but keep track of directories ending in .cache
!?*.[Cc]ache/

# Others
ClientBin/
~$*
*~
*.dbmdl
*.dbproj.schemaview
*.jfm
*.pfx
*.publishsettings
orleans.codegen.cs

# Including strong name files can present a security risk
# (https://github.com/github/gitignore/pull/2483#issue-259490424)
#*.snk

# Since there are multiple workflows, uncomment next line to ignore bower_components
# (https://github.com/github/gitignore/pull/1529#issuecomment-104372622)
#bower_components/

# RIA/Silverlight projects
Generated_Code/

# Backup & report files from converting an old project file
# to a newer Visual Studio version. Backup files are not needed,
# because we have git ;-)
_UpgradeReport_Files/
Backup*/
UpgradeLog*.XML
UpgradeLog*.htm
ServiceFabricBackup/
*.rptproj.bak

# SQL Server files
*.mdf
*.ldf
*.ndf

# Business Intelligence projects
*.rdl.data
*.bim.layout
*.bim_*.settings
*.rptproj.rsuser
*- [Bb]ackup.rdl
*- [Bb]ackup ([0-9]).rdl
*- [Bb]ackup ([0-9][0-9]).rdl

# Microsoft Fakes
FakesAssemblies/

# GhostDoc plugin setting file
*.GhostDoc.xml

# Node.js Tools for Visual Studio
.ntvs_analysis.dat
node_modules/

# Visual Studio 6 build log
*.plg

# Visual Studio 6 workspace options file
*.opt

# Visual Studio 6 auto-generated workspace file (contains which files were open etc.)
*.vbw

# Visual Studio LightSwitch build output
**/*.HTMLClient/GeneratedArtifacts
**/*.DesktopClient/GeneratedArtifacts
**/*.DesktopClient/ModelManifest.xml
**/*.Server/GeneratedArtifacts
**/*.Server/ModelManifest.xml
_Pvt_Extensions

# Paket dependency manager
.paket/paket.exe
paket-files/

# FAKE - F# Make
.fake/

# CodeRush personal settings
.cr/personal

# Python Tools for Visual Studio (PTVS)
__pycache__/
*.pyc

# Cake - Uncomment if you are using it
# tools/**
# !tools/packages.config

# Tabs Studio
*.tss

# Telerik's JustMock configuration file
*.jmconfig

# BizTalk build output
*.btp.cs
*.btm.cs
*.odx.cs
*.xsd.cs

# OpenCover UI analysis results
OpenCover/

# Azure Stream Analytics local run output
ASALocalRun/

# MSBuild Binary and Structured Log
*.binlog

# NVidia Nsight GPU debugger configuration file
*.nvuser

# MFractors (Xamarin productivity tool) working folder
.mfractor/

# Local History for Visual Studio
.localhistory/

# BeatPulse healthcheck temp database
healthchecksdb

# Backup folder for Package Reference Convert tool in Visual Studio 2017
MigrationBackup/

# Ionide (cross platform F# VS Code tools) working folder
.ionide/

# Fody - auto-generated XML schema
FodyWeavers.xsd

================
File: AutoPile.API/appsettings.Development.json
================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": { "DefaultConnection": "Server=localhost;Database=autopileDb;Trusted_Connection=True;TrustServerCertificate=True;Encrypt=false;Integrated Security=True;" },
  "MongoDb": {
    "ConnectionStrings": "mongodb+srv://wlin228:134679Zxc...@autopile.aqz1d.mongodb.net/?retryWrites=true&w=majority&appName=autopile",
    "DatabaseName": "AutoPileDb"
  },
  "Jwt": {
    "Key": "52fc3995983c6304f896a7f0f0949364c57fd79445fcfda418b5a5f9ba5e5e9140af52382607fa55af4208fb0c1fbf1976e4426a6ed670cea65141772dafcff125c463f64284dac96e22ef9534a6530a02f0e9d440ff27905f65bdaabfafde1f2ee38ad82c05702e8ff9656c065c6773e6d6ee83c44b20e0e4f09171b139a51b9a65d679ff1f48710f7094cad0aa8c570ca2acd4008725aee0330774f35582d5a44c2291b47ebba9e260e6862e4a82aab82f5dc2b45df4f81b8b8a04fc149d199cb3c9fdb622594dde64d2c560a01a6a42d6e260578180b1a6955a7d950967a67c0c063ce601c250b438c27475045a06f3165ad93083d0a39c156d5959d61e7c",
    "Issuer": "https://localhost:7249",
    "Audience": "https://localhost:7249"
  },
  "Resend": {
    "ApiKey": "re_FFu4XttH_747FDbLnWmRucksFtEWpvteb"
  },
  "Domain": "https://localhost:7249"
}

================
File: AutoPile.API/appsettings.json
================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": "",
    "MongoDb": {
      "ConnectionStrings": "",
      "DatabaseName": "AutoPileDb"
    }
  }
}

================
File: AutoPile.API/AutoPile.API.csproj
================
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <GenerateDocumentationFile>true</GenerateDocumentationFile>
  </PropertyGroup>

  <ItemGroup>
    <Compile Remove="NewFolder\**" />
    <Content Remove="NewFolder\**" />
    <EmbeddedResource Remove="NewFolder\**" />
    <None Remove="NewFolder\**" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="AutoMapper" Version="13.0.1" />
    <PackageReference Include="FluentValidation" Version="11.11.0" />
    <PackageReference Include="FluentValidation.AspNetCore" Version="11.3.0" />
    <PackageReference Include="FluentValidation.DependencyInjectionExtensions" Version="11.11.0" />
    <PackageReference Include="Microsoft.AspNetCore.OpenApi" Version="9.0.0" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.10">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.Extensions.Logging.AzureAppServices" Version="9.0.2" />
    <PackageReference Include="Swashbuckle.AspNetCore" Version="7.2.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\AutoPile.SERVICE\AutoPile.SERVICE.csproj" />
  </ItemGroup>

</Project>

================
File: AutoPile.API/AutoPile.API.http
================
@AutoPile.API_HostAddress = http://localhost:5104

GET {{AutoPile.API_HostAddress}}/weatherforecast/
Accept: application/json

###

================
File: AutoPile.API/Controllers/AuthController.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models;
using AutoPile.DOMAIN.Models.Entities;
using AutoPile.SERVICE.Services;
using AutoPile.SERVICE.Utilities;
using Azure.Core;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;

namespace AutoPile.API.Controllers
{
    /// <summary>
    /// Controller for handling user authentication and account management
    /// </summary>
    [Route("[controller]")]
    [ApiController]
    public class AuthController : ControllerBase
    {
        private readonly IAuthService _authService;

        /// <summary>
        /// Initializes a new instance of the AuthController
        /// </summary>
        /// <param name="authService">The authentication service</param>
        public AuthController(IAuthService authService)
        {
            _authService = authService;
        }

        /// <summary>
        /// Registers a new user
        /// </summary>
        /// <param name="userSignupDTO">The user registration information</param>
        /// <returns>The newly created user information</returns>
        /// <response code="200">Returns the newly created user</response>
        /// <response code="400">If the registration information is invalid</response>
        [HttpPost("SignupUser", Name = "SignupUser")]
        public async Task<IActionResult> SignupUser([FromBody] UserSignupDTO userSignupDTO)
        {
            var (userResponseDTO, accessToken, refreshToken) = await _authService.SignupUserAsync(userSignupDTO);
            var accessTokenCookieOptions = new CookieOptions
            {
                HttpOnly = true,
                Secure = true,
                SameSite = SameSiteMode.None,
                Expires = DateTime.UtcNow.AddMinutes(30),
                Path = "/"
            };

            var refreshTokenCookieOptions = new CookieOptions
            {
                HttpOnly = true,
                Secure = true,
                SameSite = SameSiteMode.None,
                Expires = DateTime.UtcNow.AddDays(7),
                Path = "/"
            };

            Response.Cookies.Append("AuthToken", accessToken, accessTokenCookieOptions);
            Response.Cookies.Append("RefreshToken", refreshToken, refreshTokenCookieOptions);
            return ApiResponse<UserResponseDTO>.OkResult(userResponseDTO);
        }

        /// <summary>
        /// Registers a new admin
        /// </summary>
        /// <param name="userSignupDTO">The admin registration information</param>
        /// <returns>The newly created admin information</returns>
        /// <response code="200">Returns the newly created user</response>
        /// <response code="400">If the registration information is invalid</response>
        [HttpPost("SignupAdmin", Name = "SignupAdmin")]
        public async Task<IActionResult> SignupAdmin([FromBody] UserSignupDTO userSignupDTO)
        {
            var (userResponseDTO, accessToken, refreshToken) = await _authService.SignupAdminAsync(userSignupDTO);
            var accessTokenCookieOptions = new CookieOptions
            {
                HttpOnly = true,
                Secure = true,
                SameSite = SameSiteMode.None,
                Expires = DateTime.UtcNow.AddMinutes(30),
                Path = "/"
            };

            var refreshTokenCookieOptions = new CookieOptions
            {
                HttpOnly = true,
                Secure = true,
                SameSite = SameSiteMode.None,
                Expires = DateTime.UtcNow.AddDays(7),
                Path = "/"
            };

            Response.Cookies.Append("AuthToken", accessToken, accessTokenCookieOptions);
            Response.Cookies.Append("RefreshToken", refreshToken, refreshTokenCookieOptions);
            return ApiResponse<UserResponseDTO>.OkResult(userResponseDTO);
        }

        /// <summary>
        /// Authenticates a user and returns a JWT token
        /// </summary>
        /// <param name="userSigninDTO">The user login credentials</param>
        /// <returns>User information and authentication token</returns>
        /// <response code="200">Returns the user information and token</response>
        /// <response code="400">If the credentials are invalid</response>
        [HttpPost("Signin", Name = "Signin")]
        public async Task<IActionResult> Signin([FromBody] UserSigninDTO userSigninDTO)
        {
            var (userResponseDTO, accessToken, refreshToken) = await _authService.SigninAsync(userSigninDTO);
            var accessTokenCookieOptions = new CookieOptions
            {
                HttpOnly = true,
                Secure = true,
                SameSite = SameSiteMode.None,
                Expires = DateTime.UtcNow.AddMinutes(30),
                Path = "/"
            };

            var refreshTokenCookieOptions = new CookieOptions
            {
                HttpOnly = true,
                Secure = true,
                SameSite = SameSiteMode.None,
                Expires = DateTime.UtcNow.AddDays(7),
                Path = "/"
            };

            Response.Cookies.Append("AuthToken", accessToken, accessTokenCookieOptions);
            Response.Cookies.Append("RefreshToken", refreshToken, refreshTokenCookieOptions);
            return ApiResponse<UserResponseDTO>.OkResult(userResponseDTO);
        }

        /// <summary>
        /// Retrieves the current user's information
        /// </summary>
        /// <returns>Detailed user information</returns>
        /// <response code="200">Returns the user information</response>
        /// <response code="401">If the user is not authorized</response>
        /// <response code="404">If the user is not found</response>
        [HttpGet("GetUserInfoById", Name = "GetUserInfoById")]
        [Authorize(Roles = "Admin,User")]
        public async Task<IActionResult> GetUserInfoById()
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            var userInfoResponseDTO = await _authService.GetUserInfoAsync(userId);
            return ApiResponse<UserInfoResponseDTO>.OkResult(userInfoResponseDTO);
        }

        /// <summary>
        /// Sends an email confirmation link to the specified email address
        /// </summary>
        /// <param name="email">The email address to send the confirmation link to</param>
        /// <returns>A confirmation token</returns>
        /// <response code="200">Returns the confirmation token</response>
        /// <response code="401">If the user is not authorized</response>
        /// <response code="400">If the email is invalid</response>
        [HttpGet("SendEmailConfirmationLink", Name = "SendEmailConfirmationLink")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> SendEmailConfirmationLink([FromQuery] string email)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            var token = await _authService.SendEmailConfirmationTokenAsync(email, userId);
            return ApiResponse<object>.OkResult(new { token });
        }

        /// <summary>
        /// Verifies an email confirmation token
        /// </summary>
        /// <param name="token">The confirmation token</param>
        /// <param name="email">The email address to verify</param>
        /// <returns>HTML response indicating verification status</returns>
        /// <response code="200">Returns HTML confirmation page</response>
        /// <response code="400">If the token or email is invalid</response>
        [HttpGet("VerifyEmailConfirmationLink", Name = "VerifyEmailConfirmationLink")]
        public async Task<IActionResult> VerifyEmailConfirmationLink([FromQuery] string token, [FromQuery] string email)
        {
            var isValid = await _authService.VerifyEmailConfirmationTokenAsync(token, email);
            return Content(EmailConfirmationHtmlTemplates.GetEmailConfirmationHtml(isValid), "text/html");
        }

        /// <summary>
        /// Updates the current user's information
        /// </summary>
        /// <param name="userUpdateInfoDTO">The updated user information</param>
        /// <returns>A success message</returns>
        /// <response code="200">If the update was successful</response>
        /// <response code="401">If the user is not authorized</response>
        /// <response code="400">If the update information is invalid</response>
        [HttpPut("UpdateUserInfo", Name = "UpdateUserInfo")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> UpdateUserInfo([FromBody] UserUpdateInfoDTO userUpdateInfoDTO)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            await _authService.UpdateUserInfoAsync(userUpdateInfoDTO, userId);
            return ApiResponse.OkResult("User info successfully updated");
        }

        /// <summary>
        /// Sends a password reset token to the specified email address
        /// </summary>
        /// <param name="email">The email address to send the reset token to</param>
        /// <returns>A reset token</returns>
        /// <response code="200">Returns the reset token</response>
        /// <response code="401">If the user is not authorized</response>
        /// <response code="400">If the email is invalid</response>
        [HttpGet("SendResetPasswordToken", Name = "SendResetPasswordToken")]
        public async Task<IActionResult> SendResetPasswordToken([FromQuery] string email)
        {
            var token = await _authService.SendResetPasswordTokenAsync(email);
            return ApiResponse<object>.OkResult(new { token });
        }

        /// <summary>
        /// Resets a user's password using a reset token
        /// </summary>
        /// <param name="userResetPasswordDTO">The password reset information including the new password</param>
        /// <returns>A success message</returns>
        /// <response code="200">If the password was successfully reset</response>
        /// <response code="400">If the reset information is invalid</response>
        [HttpPost("ResetPassword", Name = "ResetPassword")]
        public async Task<IActionResult> ResetPassword([FromBody] UserResetPasswordDTO userResetPasswordDTO)
        {
            await _authService.ResetPasswordAsync(userResetPasswordDTO);
            return ApiResponse.OkResult("Password successfully reset");
        }

        /// <summary>
        /// Validates a password reset token
        /// </summary>
        /// <param name="validateTokenRequest">The token validation request containing email and token</param>
        /// <returns>A success message if the token is valid</returns>
        /// <response code="200">If the token is valid</response>
        /// <response code="400">If the token is invalid or expired</response>
        [HttpPost("ValidatePasswordResetToken", Name = "ValidatePasswordResetTokenAsync")]
        public async Task<IActionResult> ValidatePasswordResetToken([FromBody] ValidateTokenRequest validateTokenRequest)
        {
            await _authService.ValidatePasswordResetTokenAsync(validateTokenRequest.Email, validateTokenRequest.Token);
            return ApiResponse.OkResult("Token successfully validate");
        }

        /// <summary>
        /// Signs out the current user by removing their authentication token
        /// </summary>
        /// <returns>A success message indicating the user has been logged out</returns>
        /// <response code="200">If the user was successfully logged out</response>
        /// <response code="401">If the user is not authenticated</response>
        [HttpPost("Signout", Name = "Signout")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> Signout()
        {
            Response.Cookies.Delete("AuthToken", new CookieOptions
            {
                HttpOnly = true,
                Secure = true,
                SameSite = SameSiteMode.None,
                Path = "/"
            });
            return ApiResponse.OkResult("Logged out successfully");
        }

        [HttpPost("refresh-token")]
        public async Task<IActionResult> RefreshToken([FromBody] TokenRefreshRequest tokenRefreshRequest)
        {
            var result = await _authService.RefreshTokenAsync(tokenRefreshRequest.RefreshToken);

            var accessTokenCookieOptions = new CookieOptions
            {
                HttpOnly = true,
                Secure = true,
                SameSite = SameSiteMode.None,
                Expires = DateTime.UtcNow.AddMinutes(30),
                Path = "/"
            };

            var refreshTokenCookieOptions = new CookieOptions
            {
                HttpOnly = true,
                Secure = true,
                SameSite = SameSiteMode.None,
                Expires = DateTime.UtcNow.AddDays(7),
                Path = "/"
            };

            Response.Cookies.Append("AuthToken", result.AccessToken, accessTokenCookieOptions);
            Response.Cookies.Append("RefreshToken", result.RefreshToken, refreshTokenCookieOptions);

            return ApiResponse<TokenRefreshResponse>.OkResult(result);
        }

        [HttpPost("revoke-token")]
        [Authorize]
        public async Task<IActionResult> RevokeToken()
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            await _authService.RevokeRefreshTokenAsync(userId);

            Response.Cookies.Delete("AuthToken");
            Response.Cookies.Delete("RefreshToken");

            return ApiResponse.OkResult("Token revoked successfully");
        }
    }
}

================
File: AutoPile.API/Controllers/OrderController.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models;
using AutoPile.SERVICE.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace AutoPile.API.Controllers
{
    /// <summary>
    /// Controller for managing orders in the AutoPile system
    /// </summary>
    [Route("[controller]")]
    [ApiController]
    public class OrderController : ControllerBase
    {
        private readonly IOrderService _orderService;

        /// <summary>
        /// Initializes a new instance of the OrderController
        /// </summary>
        /// <param name="orderService">The order service dependency</param>
        public OrderController(IOrderService orderService)
        {
            _orderService = orderService;
        }

        /// <summary>
        /// Creates a new order for the authenticated user
        /// </summary>
        /// <param name="orderCreateDTO">The order details to create</param>
        /// <returns>The created order information</returns>
        /// <response code="200">Returns the newly created order</response>
        /// <response code="400">If the order details are invalid</response>
        /// <response code="401">If the user is not authenticated</response>
        [HttpPost("CreateOrder", Name = "CreateOrder")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> CreateOrder([FromBody] OrderCreateDTO orderCreateDTO)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            var orderResponse = await _orderService.CreateOrderAsync(orderCreateDTO, userId);
            return ApiResponse<OrderResponseDTO>.OkResult(orderResponse);
        }

        /// <summary>
        /// Retrieves a specific order by its ID
        /// </summary>
        /// <param name="id">The ID of the order to retrieve</param>
        /// <returns>The requested order information</returns>
        /// <response code="200">Returns the requested order</response>
        /// <response code="404">If the order is not found</response>
        /// <response code="401">If the user is not authenticated</response>
        /// <response code="403">If the user is not authorized to view this order</response>
        [HttpGet("GetOrderById/{id}", Name = "GetOrderById")]
        [Authorize(Roles = "Admin,User")]
        public async Task<IActionResult> GetOrderById(int id)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            var orderResponse = await _orderService.GetOrderByIdAsync(id, userId);
            return ApiResponse<OrderResponseDTO>.OkResult(orderResponse);
        }

        /// <summary>
        /// Retrieves a specific order by its orderID
        /// </summary>
        /// <param name="id">The ID of the order to retrieve</param>
        /// <returns>The requested order information</returns>
        /// <response code="200">Returns the requested order</response>
        /// <response code="404">If the order is not found</response>
        /// <response code="401">If the user is not authenticated</response>
        /// <response code="403">If the user is not authorized to view this order</response>

        [HttpGet("GetOrderByOrderId/{id}", Name = "GetOrderByOrderId")]
        [Authorize(Roles = "Admin,User")]
        public async Task<IActionResult> GetOrderByorderId(string id)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            var orderResponse = await _orderService.GetOrderByOrderIdAsync(id, userId);
            return ApiResponse<OrderResponseDTO>.OkResult(orderResponse);
        }

        /// <summary>
        /// Completes an existing order for the authenticated user
        /// </summary>
        /// <param name="orderId">The unique identifier of the order to complete</param>
        /// <response code="200">Order was successfully completed</response>
        /// <response code="401">User is not authenticated</response>
        /// <response code="404">Order was not found</response>
        /// <response code="400">Invalid order ID or order cannot be completed</response>
        [HttpPost("CompleteOrder", Name = "CompleteOrder")]
        [Authorize]
        public async Task<IActionResult> CompleteOrder([FromBody] int orderId)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            await _orderService.CompleteOrderAsync(userId, orderId);
            return ApiResponse.OkResult();
        }

        /// <summary>
        /// Retrieves all orders for a specific user (Admin only)
        /// </summary>
        /// <param name="userId">The ID of the user whose orders to retrieve</param>
        /// <returns>A collection of orders for the specified user</returns>
        /// <response code="200">Returns the list of orders</response>
        /// <response code="401">If the user is not authenticated</response>
        /// <response code="403">If the user is not an admin</response>
        [HttpGet("GetUserOrdersAdmin/{userId}", Name = "GetUserOrdersAdmin")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> GetUserOrdersAdmin(string userId)
        {
            var orderResponse = await _orderService.GetUserOrdersAsync(userId);
            return ApiResponse<IEnumerable<OrderResponseDTO>>.OkResult(orderResponse);
        }

        /// <summary>
        /// Retrieves all orders for a specific user
        /// </summary>
        /// <returns>A collection of orders for the specified user</returns>
        /// <response code="200">Returns the list of orders</response>
        /// <response code="401">If the user is not authenticated</response>
        /// <response code="403">If the user is not an admin</response>
        [HttpGet("GetUserOrders", Name = "GetUserOrders")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> GetUserOrders()
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            var orderResponse = await _orderService.GetUserOrdersAsync(userId);
            return ApiResponse<IEnumerable<OrderResponseDTO>>.OkResult(orderResponse);
        }

        /// <summary>
        /// Updates an existing order for the authenticated user
        /// </summary>
        /// <param name="orderUpdateDTO">The updated order details</param>
        /// <param name="orderId">The ID of the order to update</param>
        /// <returns>The updated order information</returns>
        /// <response code="200">Returns the updated order</response>
        /// <response code="400">If the update details are invalid</response>
        /// <response code="404">If the order is not found</response>
        /// <response code="403">If the user is not authorized to update this order</response>
        [HttpPatch("UpdateUserOrder/{orderId}", Name = "UpdateUserOrder")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> UpdateUserOrder([FromBody] OrderUpdateDTO orderUpdateDTO, int orderId)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            var orderResponse = await _orderService.UpdateOrderAsync(orderUpdateDTO, orderId, userId);
            return ApiResponse<OrderResponseDTO>.OkResult(orderResponse);
        }

        /// <summary>
        /// Updates an order for any user (Admin only)
        /// </summary>
        /// <param name="orderUpdateDTO">The updated order details</param>
        /// <param name="orderId">The ID of the order to update</param>
        /// <param name="userId">The ID of the user whose order is being updated</param>
        /// <returns>The updated order information</returns>
        /// <response code="200">Returns the updated order</response>
        /// <response code="400">If the update details are invalid</response>
        /// <response code="404">If the order is not found</response>
        /// <response code="403">If the user is not an admin</response>
        [HttpPatch("Admin/UpdateUserOrder", Name = "AdminUpdateUserOrder")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> UpdateUserOrder([FromBody] OrderUpdateDTO orderUpdateDTO, [FromQuery] int orderId, [FromQuery] string userId)
        {
            var orderResponse = await _orderService.UpdateOrderAsync(orderUpdateDTO, orderId, userId);
            return ApiResponse<OrderResponseDTO>.OkResult(orderResponse);
        }

        /// <summary>
        /// Deletes an order for the authenticated user
        /// </summary>
        /// <param name="orderId">The ID of the order to delete</param>
        /// <returns>No content on successful deletion</returns>
        /// <response code="204">If the order was successfully deleted</response>
        /// <response code="404">If the order is not found</response>
        /// <response code="403">If the user is not authorized to delete this order</response>
        [HttpDelete("DeleteOrder/{orderId}", Name = "DeleteOrder")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> DeleteOrder(int orderId)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            await _orderService.DeleteOrderAsync(orderId, userId);
            return NoContent();
        }

        /// <summary>
        /// Deletes an order for any user (Admin only)
        /// </summary>
        /// <param name="orderId">The ID of the order to delete</param>
        /// <param name="userId">The ID of the user whose order is being deleted</param>
        /// <returns>No content on successful deletion</returns>
        /// <response code="204">If the order was successfully deleted</response>
        /// <response code="404">If the order is not found</response>
        /// <response code="403">If the user is not an admin</response>
        [HttpDelete("DeleteOrderAdmin/{orderId}", Name = "DeleteOrderAdmin")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteOrderAdmin(int orderId, string userId)
        {
            await _orderService.DeleteOrderAsync(orderId, userId);
            return NoContent();
        }
    }
}

================
File: AutoPile.API/Controllers/PaymentController.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.Models;
using AutoPile.SERVICE.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace AutoPile.API.Controllers
{
    [Route("[controller]")]
    [ApiController]
    public class PaymentController : ControllerBase
    {
        private readonly IPaymentService _paymentService;

        public PaymentController(IPaymentService paymentService)
        {
            _paymentService = paymentService;
        }

        /// <summary>
        /// Creates a new payment intent
        /// </summary>
        /// <param name="paymentIntentCreate">Payment intent creation details</param>
        /// <returns>Payment intent client secret</returns>
        [HttpPost("CreatePayment", Name = "CreatePayment")]
        [Authorize]
        public async Task<IActionResult> CreatePayment(PaymentIntentCreate paymentIntentCreate)
        {
            var intent = await _paymentService.PaymentIntentCreateAsync(paymentIntentCreate);
            return ApiResponse<object>.OkResult(new { client_secret = intent.ClientSecret });
        }
    }
}

================
File: AutoPile.API/Controllers/ProductController.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models;
using AutoPile.SERVICE.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace AutoPile.API.Controllers
{
    /// <summary>
    /// Controller for managing product operations
    /// </summary>
    [Route("[controller]")]
    [ApiController]
    public class ProductController : ControllerBase
    {
        private readonly IProductService _productService;

        /// <summary>
        /// Initializes a new instance of the ProductController
        /// </summary>
        /// <param name="productService">The product service for handling business logic</param>
        public ProductController(IProductService productService)
        {
            _productService = productService;
        }

        /// <summary>
        /// Creates a new product
        /// </summary>
        /// <param name="productCreateDTO">The product details to create</param>
        /// <returns>The newly created product</returns>
        /// <response code="200">Returns the newly created product</response>
        /// <response code="400">If the product data is invalid or SKU already exists</response>
        [HttpPost("CreateProduct", Name = "CreateProduct")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> CreateProductAsync([FromBody] ProductCreateDTO productCreateDTO)
        {
            var productResponseDTO = await _productService.CreateProductAsync(productCreateDTO);
            return ApiResponse<ProductResponseDTO>.OkResult(productResponseDTO);
        }

        /// <summary>
        /// Retrieves a specific product by its ID
        /// </summary>
        /// <param name="id">The ID of the product to retrieve</param>
        /// <returns>The requested product</returns>
        /// <response code="200">Returns the requested product</response>
        /// <response code="400">If the product ID format is invalid</response>
        /// <response code="404">If the product is not found</response>
        [HttpGet("{id}", Name = "GetProductById")]
        public async Task<IActionResult> GetProductById(string id)
        {
            var product = await _productService.GetProductByIdAsync(id);
            return ApiResponse<ProductResponseDTO>.OkResult(product);
        }

        /// <summary>
        /// Deletes a specific product
        /// </summary>
        /// <param name="id">The ID of the product to delete</param>
        /// <returns>No content</returns>
        /// <response code="204">If the product was successfully deleted</response>
        /// <response code="400">If the product ID format is invalid</response>
        /// <response code="404">If the product is not found</response>
        [HttpDelete("{id}", Name = "DeleteProductById")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteProductById(string id)
        {
            await _productService.DeleteProductByIdAsync(id);
            return NoContent();
        }

        /// <summary>
        /// Updates a specific product
        /// </summary>
        /// <param name="productUpdateDTO">The updated product data</param>
        /// <param name="id">The ID of the product to update</param>
        /// <returns>The updated product</returns>
        /// <remarks>
        /// This is a partial update - only the provided fields will be updated.
        /// Fields that are not included in the request will retain their existing values.
        /// </remarks>
        /// <response code="200">Returns the updated product</response>
        /// <response code="400">If the product ID format is invalid or update data is invalid</response>
        /// <response code="404">If the product is not found</response>
        [HttpPatch("{id}", Name = "UpdateProductById")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> UpdateProductById([FromBody] ProductUpdateDTO productUpdateDTO, string id)
        {
            var product = await _productService.UpdateProductByIdAsync(productUpdateDTO, id);
            return ApiResponse<ProductResponseDTO>.OkResult(product);
        }

        [HttpGet("GetProductsList", Name = "GetProductsList")]
        public async Task<IActionResult> GetProductsList()
        {
            var products = await _productService.GetProductsListAsync();
            return ApiResponse<IEnumerable<ProductResponseDTO>>.OkResult(products);
        }
    }
}

================
File: AutoPile.API/Controllers/ReviewController.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models;
using AutoPile.SERVICE.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using MongoDB.Bson;

namespace AutoPile.API.Controllers
{
    /// <summary>
    /// Controller for managing product reviews
    /// </summary>
    [Route("[controller]")]
    [ApiController]
    public class ReviewController : ControllerBase
    {
        private readonly IReviewService _reviewService;
        private readonly ILogger<ReviewController> _logger;

        /// <summary>
        /// Initializes a new instance of the ReviewController
        /// </summary>
        /// <param name="reviewService">The review service for handling business logic</param>
        /// <param name="logger">The logger for recording operations</param>
        public ReviewController(IReviewService reviewService, ILogger<ReviewController> logger)
        {
            _reviewService = reviewService;
            _logger = logger;
        }

        /// <summary>
        /// Creates a new product review
        /// </summary>
        /// <param name="reviewCreateDTO">The review details to create</param>
        /// <returns>The newly created review</returns>
        /// <response code="200">Returns the newly created review</response>
        /// <response code="400">If the review data is invalid</response>
        /// <response code="401">If the user is not authenticated</response>
        [HttpPost("CreateReview", Name = "CreateReview")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> CreateReview(ReviewCreateDTO reviewCreateDTO)
        {
            try
            {
                var userId = HttpContext.Items["UserId"]?.ToString();
                _logger.LogInformation($"Attempting to create review with userId: {userId}");

                var responseReviewDTO = await _reviewService.CreateReviewAsync(reviewCreateDTO, userId);
                _logger.LogInformation($"Review created successfully with ID {responseReviewDTO.Id}");

                return ApiResponse<ReviewResponseDTO>.OkResult(responseReviewDTO);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating review");
                throw;
            }
        }

        /// <summary>
        /// Retrieves a specific review by its ID
        /// </summary>
        /// <param name="Id">The ID of the review to retrieve</param>
        /// <returns>The requested review</returns>
        /// <response code="200">Returns the requested review</response>
        /// <response code="404">If the review is not found</response>
        [HttpGet("GetReviewById", Name = "GetReviewById")]
        public async Task<IActionResult> GetReviewById(string Id)
        {
            var responseReviewDTO = await _reviewService.GetReviewByIdAsync(Id);
            _logger.LogInformation("Successfully retrieved review {ReviewId}", Id);
            return ApiResponse<ReviewResponseDTO>.OkResult(responseReviewDTO);
        }

        /// <summary>
        /// Retrieves all reviews for a specific product
        /// </summary>
        /// <param name="productId">The ID of the product to get reviews for</param>
        /// <returns>A collection of reviews for the specified product</returns>
        /// <response code="200">Returns the list of reviews</response>
        /// <response code="404">If the product is not found</response>
        [HttpGet("GetReviewByProductId", Name = "GetReviewByProductId")]
        public async Task<IActionResult> GetReviewsByProductId(string productId)
        {
            var responseReviewDTO = await _reviewService.GetReviewsByProductIdAsync(productId);
            _logger.LogInformation("Successfully retrieved {Count} reviews for product {ProductId}",
                   responseReviewDTO?.Count() ?? 0, productId);
            return ApiResponse<IEnumerable<ReviewResponseDTO>>.OkResult(responseReviewDTO);
        }

        /// <summary>
        /// Updates an existing review
        /// </summary>
        /// <param name="reviewUpdateDTO">The updated review data</param>
        /// <param name="id">The ID of the review to update</param>
        /// <returns>The updated review</returns>
        /// <response code="200">Returns the updated review</response>
        /// <response code="400">If the update data is invalid</response>
        /// <response code="401">If the user is not authenticated</response>
        /// <response code="403">If the user is not authorized to update the review</response>
        /// <response code="404">If the review is not found</response>
        [HttpPatch("{id}", Name = "UpdateReviewByReviewId")]
        [Authorize(Roles = "Admin,User")]
        public async Task<IActionResult> UpdateReview(ReviewUpdateDTO reviewUpdateDTO, string id)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            var response = await _reviewService.UpdateReviewAsync(reviewUpdateDTO, id, userId);
            _logger.LogInformation("Successfully updated review {ReviewId}", id);
            return ApiResponse<ReviewResponseDTO>.OkResult(response, "Resource updated successfully");
        }

        /// <summary>
        /// Deletes a specific review
        /// </summary>
        /// <param name="id">The ID of the review to delete</param>
        /// <returns>No content</returns>
        /// <response code="204">If the review was successfully deleted</response>
        /// <response code="401">If the user is not authenticated</response>
        /// <response code="403">If the user is not authorized to delete the review</response>
        /// <response code="404">If the review is not found</response>
        [HttpDelete("{id}", Name = "DeleteReviewByReviewId")]
        [Authorize(Roles = "Admin,User")]
        public async Task<IActionResult> DeleteReview(string id)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            await _reviewService.DeleteReviewAsync(id, userId);
            _logger.LogInformation("Successfully deleted review {ReviewId}", id);
            return NoContent();
        }
    }
}

================
File: AutoPile.API/Controllers/ShoppingCartItemController.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models;
using AutoPile.DOMAIN.Models.Entities;
using AutoPile.SERVICE.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;

namespace AutoPile.API.Controllers
{
    /// <summary>
    /// Controller for managing shopping cart items
    /// </summary>
    [Route("[controller]")]
    [ApiController]
    public class ShoppingCartItemController : ControllerBase
    {
        private readonly IShoppingCartItemService _shoppingCartItemService;
        private readonly ILogger<ShoppingCartItem> _logger;

        /// <summary>
        /// Initializes a new instance of the ShoppingCartItemController
        /// </summary>
        /// <param name="shoppingCartItemService">The shopping cart item service</param>
        /// <param name="logger">The logger instance</param>
        public ShoppingCartItemController(IShoppingCartItemService shoppingCartItemService, ILogger<ShoppingCartItem> logger)
        {
            _logger = logger;
            _shoppingCartItemService = shoppingCartItemService;
        }

        /// <summary>
        /// Retrieves a specific shopping cart item by its ID
        /// </summary>
        /// <param name="id">The ID of the shopping cart item to retrieve</param>
        /// <returns>The shopping cart item details</returns>
        /// <response code="200">Returns the shopping cart item</response>
        /// <response code="404">If the item is not found</response>
        /// <response code="401">If the user is not authorized</response>
        [HttpGet("{id}", Name = "GetShoppingCartItemById")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> GetShoppingCartItemById(int id)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            var shoppingCartItemResponseDTO = await _shoppingCartItemService.GetShoppingCartItemById(id, userId);
            _logger.LogInformation("Shopping Cart Item retrieved successfully:{ShoppingCartItem}", shoppingCartItemResponseDTO);
            return ApiResponse<ShoppingCartItemResponseDTO>.OkResult(shoppingCartItemResponseDTO);
        }

        /// <summary>
        /// Creates a new shopping cart item
        /// </summary>
        /// <param name="shoppingCartItemResponseDTO">The shopping cart item information</param>
        /// <returns>The newly created shopping cart item</returns>
        /// <response code="200">Returns the newly created item</response>
        /// <response code="400">If the item is invalid</response>
        /// <response code="401">If the user is not authorized</response>
        [HttpPost("AddShoppingCartItem", Name = "AddShoppingCartItem")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> CreateShoppingCartItem([FromBody] ShoppingCartItemRequestDto shoppingCartItemResponseDTO)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            var shoppingCartItem = await _shoppingCartItemService.CreateShoppingCartItemAsync(shoppingCartItemResponseDTO, userId);
            _logger.LogInformation("Shopping Cart Item created successfully:{ShoppingCartItem}", shoppingCartItem);
            return ApiResponse<ShoppingCartItemResponseDTO>.OkResult(shoppingCartItem);
        }

        /// <summary>
        /// Deletes a specific shopping cart item
        /// </summary>
        /// <param name="id">The ID of the shopping cart item to delete</param>
        /// <returns>No content</returns>
        /// <response code="204">If the item was successfully deleted</response>
        /// <response code="404">If the item is not found</response>
        /// <response code="401">If the user is not authorized</response>
        [HttpDelete("{id}", Name = "DeleteShoppingCartItem")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> DeleteShoppingCartItem(int id)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            await _shoppingCartItemService.DeleteShoppingCartItemAsync(id, userId);
            _logger.LogInformation("Shopping Cart Item deleted successfully with Id {id}", id);
            return NoContent();
        }

        /// <summary>
        /// Updates a specific shopping cart item
        /// </summary>
        /// <param name="updateShoppingCartItemDto">The updated shopping cart item information</param>
        /// <param name="id">The ID of the shopping cart item to update</param>
        /// <returns>A success message</returns>
        /// <response code="200">If the item was successfully updated</response>
        /// <response code="400">If the update information is invalid</response>
        /// <response code="404">If the item is not found</response>
        /// <response code="401">If the user is not authorized</response>
        [HttpPatch("{id}", Name = "UpdateShoppingCartItem")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> UpdateShoppingCartItem([FromBody] UpdateShoppingCartItemDto updateShoppingCartItemDto, int id)
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            await _shoppingCartItemService.UpdateShoppingCartItemAsync(updateShoppingCartItemDto, id, userId);
            _logger.LogInformation("Shopping Cart Item updated successfully with Id {ShoppingCartItemId}", id);
            return ApiResponse.OkResult("Resource updated successfully");
        }

        /// <summary>
        /// Deletes all shopping cart items for the authenticated user
        /// </summary>
        /// <remarks>
        /// This endpoint removes all items from the user's shopping cart.
        /// The user must be authenticated and have the "User" role to access this endpoint.
        /// </remarks>
        /// <response code="204">All shopping cart items were successfully deleted</response>
        /// <response code="401">User is not authenticated</response>
        /// <response code="403">User does not have the required role</response>
        /// <response code="404">User not found</response>
        /// <response code="500">Internal server error occurred</response>
        [HttpDelete]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> DeleteAllShoppingCartItems()
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            await _shoppingCartItemService.DeleteAllShoppingCartItemsAsync(userId);
            _logger.LogInformation("Whole shopping Cart Item deleted successfully with User Id {userId}", userId);
            return NoContent();
        }

        /// <summary>
        /// Retrieves specific shopping cart item list by User ID
        /// </summary>
        /// <returns>The shopping cart item list details</returns>
        /// <response code="200">Returns the shopping cart item list</response>
        /// <response code="404">If the item is not found</response>
        /// <response code="401">If the user is not authorized</response>
        [HttpGet("ShoppingCartItemList", Name = "ShoppingCartItemList")]
        [Authorize(Roles = "User")]
        public async Task<IActionResult> GetUserShoppingCartItemList()
        {
            var userId = HttpContext.Items["UserId"]?.ToString();
            var shoppingCartItemList = await _shoppingCartItemService.GetShoppingCartItemByUserId(userId);
            return ApiResponse<IEnumerable<ShoppingCartItemResponseDTO>>.OkResult(shoppingCartItemList);
        }
    }
}

================
File: AutoPile.API/Mapping/MappingProfile.cs
================
using AutoMapper;
using AutoPile.API.Validators;
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models.Entities;
using static System.Net.Mime.MediaTypeNames;

namespace AutoPile.API.Mapping
{
    public class MappingProfile : Profile
    {
        public byte[] ConvertFromFiletoArray(IFormFile Image)
        {
            if (Image == null || Image.Length == 0) return null;
            using var ms = new MemoryStream();
            Image.CopyTo(ms);
            return ms.ToArray();
        }

        public MappingProfile()
        {
            CreateMap<ReviewCreateDTO, Review>().ForMember(dest => dest.CreatedAt, opt => opt.MapFrom(src => DateTime.UtcNow));
            //.ForMember(dest => dest.ImageContentType, opt => opt.MapFrom(src => src.Image != null ? src.Image.ContentType : null))
            //.ForMember(dest => dest.Image, opt => opt.MapFrom(src => ConvertFromFiletoArray(src.Image)));
            CreateMap<Review, ReviewResponseDTO>();
            //.ForMember(dest => dest.Image, opt => opt.MapFrom(src =>
            //    src.Image != null ? new ReviewImageDTO
            //    {
            //        Image = src.Image,
            //        ImageContentType = src.ImageContentType,
            //    } : null));
            CreateMap<ProductMediaCreateDTO, ProductMedia>();
            CreateMap<ProductMedia, ProductMediaResponseDTO>();
            CreateMap<ProductCreateDTO, Product>();
            CreateMap<Product, ProductResponseDTO>();
            CreateMap<OrderItemCreateDTO, OrderItem>();
            CreateMap<OrderItem, OrderItemResponseDTO>();
            CreateMap<OrderCreateDTO, Order>();
            CreateMap<Order, OrderResponseDTO>();

            CreateMap<UserSignupDTO, ApplicationUser>();
            CreateMap<UserSigninDTO, ApplicationUser>();

            CreateMap<ApplicationUser, UserResponseDTO>();
            CreateMap<UserUpdateInfoDTO, ApplicationUser>();
            CreateMap<ApplicationUser, UserInfoResponseDTO>();
            CreateMap<ShoppingCartItemRequestDto, ShoppingCartItem>();
            CreateMap<ShoppingCartItem, ShoppingCartItemResponseDTO>();
            CreateMap<UpdateShoppingCartItemDto, ShoppingCartItem>();
            CreateMap<ReviewUpdateDTO, Review>();

            //.ForMember(dest => dest.ImageContentType, opt => opt.MapFrom(src => src.Image != null ? src.Image.ContentType : null))
            //.ForMember(dest => dest.Image, opt => opt.MapFrom(src => ConvertFromFiletoArray(src.Image))); ;
            CreateMap<ProductMediaUpdateDto, ProductMedia>();
            CreateMap<OrderItemUpdateDTO, OrderItem>();
            CreateMap<OrderUpdateValidator, Order>();
        }
    }
}

================
File: AutoPile.API/Program.cs
================
using AutoPile.API;
using AutoPile.API.Validators;
using AutoPile.DATA.Cache;
using AutoPile.DATA.Cache.CacheRepository;
using AutoPile.DATA.Data;
using AutoPile.DATA.Middlewares;
using AutoPile.DOMAIN.Interface;
using AutoPile.DOMAIN.Models;
using AutoPile.DOMAIN.Models.Entities;
using AutoPile.SERVICE.Services;
using AutoPile.SERVICE.Utilities;
using Azure.Storage.Queues;
using FluentValidation;
using FluentValidation.AspNetCore;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Microsoft.IdentityModel.Tokens;
using Microsoft.OpenApi.Models;
using MongoDB.Driver;
using Resend;
using Stripe;
using System.Reflection;
using System.Text;

var builder = WebApplication.CreateBuilder(args);

// Enhanced logging configuration
builder.Logging.ClearProviders();
builder.Logging.AddConsole();
builder.Logging.AddDebug();
builder.Logging.AddAzureWebAppDiagnostics();
builder.Logging.SetMinimumLevel(LogLevel.Debug);
builder.Logging.AddFilter("Microsoft", LogLevel.Warning);
builder.Logging.AddFilter("System", LogLevel.Warning);
builder.Logging.AddFilter("AutoPile", LogLevel.Trace);

// Add services to the container.

builder.Services.AddControllers();
builder.Services.AddProblemDetails();
builder.Services.AddEndpointsApiExplorer();

builder.Services.AddSwaggerGen(c =>
{
    var xmlFile = $"{Assembly.GetExecutingAssembly().GetName().Name}.xml";
    var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile);
    c.IncludeXmlComments(xmlPath);
    c.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        Description =
            "JWT Authorization header using the Bearer scheme. Example: 'Authorization: Bearer {token}'",
        Name = "Authorization",
        In = ParameterLocation.Header,
        Type = SecuritySchemeType.ApiKey,
        Scheme = "Bearer"
    });

    c.AddSecurityRequirement(new OpenApiSecurityRequirement{
        {
            new OpenApiSecurityScheme{
                Reference = new OpenApiReference{
                    Id = "Bearer",
                    Type = ReferenceType.SecurityScheme
                }
            }, new List<string>()
        }
    });
});

builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.RequireHttpsMetadata = false;
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true,
        ValidIssuer = Environment.GetEnvironmentVariable("ISSUER") ?? builder.Configuration["Jwt:Issuer"],
        ValidAudience = Environment.GetEnvironmentVariable("AUDIENCE") ?? builder.Configuration["Jwt:Audience"],
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(Environment.GetEnvironmentVariable("JWTKEY") ?? builder.Configuration["Jwt:Key"]))
    };

    options.Events = new JwtBearerEvents
    {
        OnMessageReceived = context =>
        {
            context.Token = context.Request.Cookies["AuthToken"];
            return Task.CompletedTask;
        }
    };
});
builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminPolicy", policy => policy.RequireClaim("scope", "admin"));
    options.AddPolicy("UserPolicy", policy => policy.RequireClaim("scope", "user"));
});
builder.Services.AddScoped<IShoppingCartItemService, ShoppingCartItemService>();
builder.Services.AddScoped<JwtTokenGenerator>();
builder.Services.AddScoped<IJwtTokenGenerator, JwtTokenGenerator>();
builder.Services.AddScoped<IAuthService, AuthService>();
builder.Services.AddScoped<IReviewService, AutoPile.SERVICE.Services.ReviewService>();
builder.Services.AddScoped<IBlobService, BlobService>();
builder.Services.AddScoped<IProductService, AutoPile.SERVICE.Services.ProductService>();
builder.Services.AddScoped<IOrderService, OrderService>();
builder.Services.AddScoped<IRedisShoppingCartCache, RedisShoppingCartCache>();
builder.Services.AddScoped<IPaymentService, PaymentService>();
builder.Services.AddScoped<IOrderItemService, OrderItemService>();
builder.Services.AddScoped(typeof(IRedisCache<>), typeof(RedisCache<>));
builder.Services.AddScoped<IProductCache, ProductCache>();
builder.Services.AddScoped<IReviewsCache, ReviewsCache>();
builder.Services.AddScoped<IUserInfoCache, UserInfoCache>();
builder.Services.AddScoped<IOrderCache, OrderCache>();
builder.Services.AddScoped<IStripeService, StripeService>();

// Register queue clients as singletons
builder.Services.AddSingleton<QueueClient>(sp =>
{
    var logger = sp.GetRequiredService<ILogger<QueueClient>>();
    var blobConnectionString = Environment.GetEnvironmentVariable("BlobStorage");

    if (string.IsNullOrEmpty(blobConnectionString))
    {
        logger.LogError("BlobStorage connection string is empty");
        throw new InvalidOperationException("BlobStorage environment variable is not set");
    }

    logger.LogInformation("Creating email queue client");
    return new QueueClient(blobConnectionString, "email-queue",
        new QueueClientOptions { MessageEncoding = QueueMessageEncoding.Base64 });
});

builder.Services.AddSingleton<QueueClient>(sp =>
{
    var logger = sp.GetRequiredService<ILogger<QueueClient>>();
    var blobConnectionString = Environment.GetEnvironmentVariable("BlobStorage");

    if (string.IsNullOrEmpty(blobConnectionString))
    {
        logger.LogError("BlobStorage connection string is empty");
        throw new InvalidOperationException("BlobStorage environment variable is not set");
    }

    logger.LogInformation("Creating inventory queue client");
    return new QueueClient(blobConnectionString, "inventory-queue",
        new QueueClientOptions { MessageEncoding = QueueMessageEncoding.Base64 });
});
// Add this to the service configuration section in Program.cs
// Register both QueueClients
// Register QueueClient for Email Queue
builder.Services.AddScoped<IEmailQueueService, EmailQueueService>();
builder.Services.AddScoped<IInventoryQueueService, InventoryQueueService>();

// Register background services
builder.Services.AddHostedService<EmailProcessingService>();
builder.Services.AddHostedService<InventoryProcessingService>();

// Learn more about configuring OpenAPI at https://aka.ms/aspnet/openapi
builder.Services.AddOpenApi();
builder.Services.AddFluentValidationAutoValidation();
builder.Services.AddFluentValidationClientsideAdapters();
builder.Services.AddValidatorsFromAssemblyContaining<UserSignupDTOValidator>();

builder.Services.AddStackExchangeRedisCache(options =>
{
    options.Configuration = Environment.GetEnvironmentVariable("REDIS");
});

builder.Services.Configure<IdentityOptions>(options =>
{
    options.Password.RequiredLength = 8;              // MinimumLength(8)
    options.Password.RequireUppercase = true;         // Matches("[A-Z]")
    options.Password.RequireLowercase = true;         // Matches("[a-z]")
    options.Password.RequireDigit = true;             // Matches("[0-9]")
    options.Password.RequireNonAlphanumeric = true;   // Matches("[^a-zA-Z0-9]")
});

var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");

// Add DbContext
builder.Services.AddDbContext<AutoPileManagementDbContext>(options =>
    options.UseSqlServer(connectionString));

var mongoConnectionString = Environment.GetEnvironmentVariable("MongoDB") ??
                          Environment.GetEnvironmentVariable("MongoDB_ConnectionStrings") ??
                          builder.Configuration.GetSection("MongoDb:ConnectionStrings").Value;
var mongoDbName = "AutoPileDb";

builder.Services.AddSingleton<IMongoClient>(sp =>
{
    var logger = sp.GetRequiredService<ILogger<IMongoClient>>();
    logger.LogInformation("Creating MongoClient with connection string");
    if (string.IsNullOrEmpty(mongoConnectionString))
    {
        logger.LogError("MongoDB connection string is empty");
        throw new InvalidOperationException("MongoDB connection string is not configured");
    }
    return new MongoClient(mongoConnectionString);
});

builder.Services.AddScoped(sp =>
{
    var logger = sp.GetRequiredService<ILogger<AutoPileMongoDbContext>>();
    try
    {
        var client = sp.GetRequiredService<IMongoClient>();
        logger.LogInformation("Getting MongoDB database: {DatabaseName}", mongoDbName);
        var database = client.GetDatabase(mongoDbName);
        logger.LogInformation("Creating MongoDB context");
        return AutoPileMongoDbContext.Create(database);
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to create MongoDB context");
        throw;
    }
});

//builder.Services.AddIdentity<ApplicationUser, ApplicationRole>()
//.AddEntityFrameworkStores<AutoPileManagementDbContext>()
//.AddDefaultTokenProviders();

builder.Services.AddIdentityApiEndpoints<ApplicationUser>()
    .AddRoles<ApplicationRole>()
    .AddEntityFrameworkStores<AutoPileManagementDbContext>()
    .AddSignInManager()
    .AddRoleManager<RoleManager<ApplicationRole>>()
    .AddDefaultTokenProviders();

builder.Services.AddAutoMapper(typeof(Program));
builder.Services.AddOptions();
builder.Services.AddHttpClient<ResendClient>();
builder.Services.Configure<ResendClientOptions>(o =>
{
    var token = Environment.GetEnvironmentVariable("RESEND_APITOKEN");
    if (string.IsNullOrEmpty(token))
    {
        Console.WriteLine("WARNING: RESEND_APITOKEN environment variable is not set!");
    }

    o.ApiToken = token!;
});
builder.Services.AddTransient<IResend, ResendClient>();
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowLocalhost3000",
        builder =>
        {
            builder.WithOrigins("http://localhost:3000", "https://www.autopile.store", "https://autopile-gafnbva6egabe5ap.australiaeast-01.azurewebsites.net")
                   .AllowAnyHeader()
                   .AllowAnyMethod().AllowCredentials();
        });
});
StripeConfiguration.ApiKey = Environment.GetEnvironmentVariable("StripeKey");

var app = builder.Build();

// Get logger for logging app startup
var logger = app.Services.GetRequiredService<ILogger<Program>>();

try
{
    logger.LogInformation("====== Application Starting - {Time} ======", DateTime.UtcNow);

    // Log environment variables (excluding sensitive values)
    logger.LogInformation("Environment: {Environment}", app.Environment.EnvironmentName);
    logger.LogInformation("Checking if key environment variables exist:");
    logger.LogInformation("JWTKEY exists: {Exists}", !string.IsNullOrEmpty(Environment.GetEnvironmentVariable("JWTKEY")));
    logger.LogInformation("MongoDB exists: {Exists}", !string.IsNullOrEmpty(Environment.GetEnvironmentVariable("MongoDB")));
    logger.LogInformation("BlobStorage exists: {Exists}", !string.IsNullOrEmpty(Environment.GetEnvironmentVariable("BlobStorage")));
    logger.LogInformation("REDIS exists: {Exists}", !string.IsNullOrEmpty(Environment.GetEnvironmentVariable("REDIS")));
    logger.LogInformation("StripeKey exists: {Exists}", !string.IsNullOrEmpty(Environment.GetEnvironmentVariable("StripeKey")));
    logger.LogInformation("RESEND_APITOKEN exists: {Exists}", !string.IsNullOrEmpty(Environment.GetEnvironmentVariable("RESEND_APITOKEN")));
    logger.LogInformation("ISSUER exists: {Exists}", !string.IsNullOrEmpty(Environment.GetEnvironmentVariable("ISSUER")));
    logger.LogInformation("AUDIENCE exists: {Exists}", !string.IsNullOrEmpty(Environment.GetEnvironmentVariable("AUDIENCE")));

    // Log middleware configuration
    logger.LogInformation("Core services registered, initializing middleware...");

    logger.LogInformation("Configuring middlewares - Start");

    app.UseMiddleware<UserIdExtractMiddleware>();
    logger.LogInformation("Configured UserIdExtractMiddleware");

    app.UseMiddleware<ExceptionHandlingMiddleware>();
    logger.LogInformation("Configured ExceptionHandlingMiddleware");

    app.UseHsts();
    logger.LogInformation("Configured HSTS");

    if (app.Environment.IsDevelopment())
    {
        app.MapOpenApi();
        app.UseSwagger();
        app.UseSwaggerUI();
        logger.LogInformation("Configured development specific settings");
    }

    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "AutoPile API V1");
        c.RoutePrefix = string.Empty;
        c.DocExpansion(Swashbuckle.AspNetCore.SwaggerUI.DocExpansion.None);
        c.DefaultModelsExpandDepth(-1);
    });
    logger.LogInformation("Configured Swagger");

    app.UseHttpsRedirection();
    logger.LogInformation("Configured HTTPS redirection");

    app.UseRouting();
    logger.LogInformation("Configured routing");

    app.UseCors("AllowLocalhost3000");
    logger.LogInformation("Configured CORS");

    app.UseAuthentication();
    logger.LogInformation("Configured authentication");

    app.UseAuthorization();
    logger.LogInformation("Configured authorization");

    app.MapControllers();
    logger.LogInformation("Configured controller mapping");

    // Initialize roles
    using (var scope = app.Services.CreateScope())
    {
        logger.LogInformation("Checking and initializing roles...");
        try
        {
            var roleManager = scope.ServiceProvider.GetRequiredService<RoleManager<ApplicationRole>>();
            var roles = new[] { "Admin", "User" };

            foreach (var role in roles)
            {
                if (!await roleManager.RoleExistsAsync(role))
                {
                    logger.LogInformation("Creating role: {Role}", role);
                    var newRole = new ApplicationRole
                    {
                        Name = role,
                        NormalizedName = role.ToUpper()
                    };
                    await roleManager.CreateAsync(newRole);
                }
                else
                {
                    logger.LogInformation("Role already exists: {Role}", role);
                }
            }
            logger.LogInformation("Role check completed");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error during role initialization");
            throw;
        }
    }

    logger.LogInformation("====== Application configuration complete, starting to run ======");
    app.Run();
}
catch (Exception ex)
{
    logger.LogCritical(ex, "====== APPLICATION STARTUP FAILED ======");
    throw;
}

================
File: AutoPile.API/Properties/launchSettings.json
================
{
  "$schema": "https://json.schemastore.org/launchsettings.json",
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:5104",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:7249;http://localhost:5104",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development",
        "RESEND_APITOKEN": "re_FFu4XttH_747FDbLnWmRucksFtEWpvteb",
        "BlobStorage": "DefaultEndpointsProtocol=https;AccountName=autopile;AccountKey=Q7F1A4KLdgHVdM5JDeH1rLxrHgebRRNXytyhY1AcfT5Pj0GZyorIbqWQrHCBGUivTgF5VusExpZ3+AStO8a2dQ==;EndpointSuffix=core.windows.net",
        "REDIS": "AutoPileDb.redis.cache.windows.net:6380,password=oa5aSxuqu0qVFpJlAxXCa1i2tZWaeomBGAzCaFFSVgM=,ssl=True,abortConnect=False",
        "StripeKey": "sk_test_51Q8Nu92NEXAeaIGsIcDbUefZK77pTq8jIkJtlsILMctNtuUSyhI5qlCDJugqJHaklc51jtM5pgVpqU839rIqVWeH00BUdNUVvR"
      }
    }
  }
}

================
File: AutoPile.API/Validators/OrderItemRequestValidator.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using FluentValidation;

namespace AutoPile.API.Validators
{
    public class OrderItemRequestValidator : AbstractValidator<OrderItemCreateDTO>
    {
        public OrderItemRequestValidator()
        {
            RuleFor(x => x.ProductId)
            .NotEmpty().WithMessage("Product ID is required")
            .Matches(@"^[0-9a-fA-F]{24}$").WithMessage("Invalid MongoDB ObjectId format for Product ID");

            //RuleFor(x => x.ProductName)
            //    .NotEmpty().WithMessage("Product name is required")
            //    .MaximumLength(200).WithMessage("Product name cannot exceed 200 characters");

            //RuleFor(x => x.ProductPrice)
            //    .GreaterThan(0).WithMessage("Product price must be greater than 0")
            //    .PrecisionScale(18, 2, true).WithMessage("Product price cannot have more than 2 decimal places");

            RuleFor(x => x.Quantity)
                .GreaterThan(0).WithMessage("Quantity must be greater than 0")
                .LessThanOrEqualTo(100).WithMessage("Quantity cannot exceed 100 items");
        }
    }
}

================
File: AutoPile.API/Validators/OrderItemUpdateValidator.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using FluentValidation;

namespace AutoPile.API.Validators
{
    public class OrderItemUpdateValidator : AbstractValidator<OrderItemUpdateDTO>
    {
        public OrderItemUpdateValidator()
        {
            RuleFor(x => x.Quantity)
                .GreaterThan(0).WithMessage("Quantity must be greater than 0")
                .LessThanOrEqualTo(100).WithMessage("Quantity cannot exceed 100 items");
        }
    }
}

================
File: AutoPile.API/Validators/OrderRequestValidator.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using FluentValidation;

namespace AutoPile.API.Validators
{
    public class OrderRequestValidator : AbstractValidator<OrderCreateDTO>
    {
        private bool BeValidPaymentMethod(string paymentMethod)
        {
            var validMethods = new[] { "Credit Card", "PayPal", "Stripe" };
            return validMethods.Contains(paymentMethod);
        }

        public OrderRequestValidator()
        {
            RuleFor(x => x.PaymentMethod)
                .NotEmpty().WithMessage("Payment method is required")
                .MaximumLength(50).WithMessage("Payment method cannot exceed 50 characters")
                .Must(BeValidPaymentMethod).WithMessage("Invalid payment method. Must be one of: Credit Card, PayPal, Stripe");

            RuleFor(x => x.ShippingAddress_Line1)
                .NotEmpty().WithMessage("Shipping address line 1 is required")
                .MaximumLength(100).WithMessage("Address line 1 cannot exceed 100 characters");

            RuleFor(x => x.ShippingAddress_Line2)
                .MaximumLength(100).WithMessage("Address line 2 cannot exceed 100 characters");

            RuleFor(x => x.ShippingAddress_City)
                .NotEmpty().WithMessage("City is required")
                .MaximumLength(100).WithMessage("City cannot exceed 100 characters");

            RuleFor(x => x.ShippingAddress_Country)
                .NotEmpty().WithMessage("Country is required")
                .MaximumLength(100).WithMessage("Country cannot exceed 100 characters");

            RuleFor(x => x.ShippingAddress_State)
                .NotEmpty().WithMessage("State is required")
                .MaximumLength(100).WithMessage("State cannot exceed 100 characters");

            RuleFor(x => x.ShippingAddress_PostalCode)
                .NotEmpty().WithMessage("Postal code is required")
                .MaximumLength(20).WithMessage("Postal code cannot exceed 20 characters")
                .Matches(@"^[A-Za-z0-9\s-]+$").WithMessage("Postal code can only contain letters, numbers, spaces, and hyphens");

            RuleFor(x => x.OrderItems)
                .NotEmpty().WithMessage("Order must contain at least one item")
                .Must(items => items != null && items.Count != 0).WithMessage("Order items cannot be empty");
        }
    }
}

================
File: AutoPile.API/Validators/OrderUpdateValidator.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using FluentValidation;

namespace AutoPile.API.Validators
{
    public class OrderUpdateValidator : AbstractValidator<OrderUpdateDTO>
    {
        private bool BeValidPaymentMethod(string paymentMethod)
        {
            var validMethods = new[] { "Credit Card", "PayPal", "Stripe" };
            return validMethods.Contains(paymentMethod);
        }

        public OrderUpdateValidator()
        {
            RuleFor(x => x.PaymentMethod)
                .NotEmpty().WithMessage("Payment method is required")
                .MaximumLength(50).WithMessage("Payment method cannot exceed 50 characters")
                .Must(BeValidPaymentMethod).WithMessage("Invalid payment method. Must be one of: Credit Card, PayPal, Stripe");

            RuleFor(x => x.ShippingAddress_Line1)
                .NotEmpty().WithMessage("Shipping address line 1 is required")
                .MaximumLength(100).WithMessage("Address line 1 cannot exceed 100 characters");

            RuleFor(x => x.ShippingAddress_Line2)
                .MaximumLength(100).WithMessage("Address line 2 cannot exceed 100 characters");

            RuleFor(x => x.ShippingAddress_City)
                .NotEmpty().WithMessage("City is required")
                .MaximumLength(100).WithMessage("City cannot exceed 100 characters");

            RuleFor(x => x.ShippingAddress_Country)
                .NotEmpty().WithMessage("Country is required")
                .MaximumLength(100).WithMessage("Country cannot exceed 100 characters");

            RuleFor(x => x.ShippingAddress_State)
                .NotEmpty().WithMessage("State is required")
                .MaximumLength(100).WithMessage("State cannot exceed 100 characters");

            RuleFor(x => x.ShippingAddress_PostalCode)
                .NotEmpty().WithMessage("Postal code is required")
                .MaximumLength(20).WithMessage("Postal code cannot exceed 20 characters")
                .Matches(@"^[A-Za-z0-9\s-]+$").WithMessage("Postal code can only contain letters, numbers, spaces, and hyphens");

            RuleFor(x => x.OrderItems)
                .NotEmpty().WithMessage("Order must contain at least one item")
                .Must(items => items != null && items.Count != 0).WithMessage("Order items cannot be empty");
        }
    }
}

================
File: AutoPile.API/Validators/ProductMediaRequestValidator.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using FluentValidation;

namespace AutoPile.API.Validators
{
    public static class Helper
    {
        public static bool BeValidUrl(string url)
        {
            return Uri.TryCreate(url, UriKind.Absolute, out _);
        }

        public static bool BeValidMediaType(string mediaType)
        {
            return mediaType == "PHOTO";
        }
    }

    public class ProductMediaRequestValidator : AbstractValidator<ProductMediaCreateDTO>

    {
        public ProductMediaRequestValidator()
        {
            RuleFor(x => x.Url)
            .NotEmpty().WithMessage("URL is required");

            RuleFor(x => x.FullUrl)
                .NotEmpty().WithMessage("Full URL is required")
                .MaximumLength(2000).WithMessage("Full URL cannot exceed 2000 characters")
                .Must(Helper.BeValidUrl).WithMessage("Full URL must be a valid URL");

            RuleFor(x => x.MediaType)
                .NotEmpty().WithMessage("Media type is required")
                .MaximumLength(50).WithMessage("Media type cannot exceed 50 characters")
                .Must(Helper.BeValidMediaType).WithMessage("Media type must be : PHOTO");

            RuleFor(x => x.AltText)
                .MaximumLength(200).WithMessage("Alt text cannot exceed 200 characters")
                .When(x => !string.IsNullOrEmpty(x.AltText));

            RuleFor(x => x.Title)
                .MaximumLength(200).WithMessage("Title cannot exceed 200 characters")
                .When(x => !string.IsNullOrEmpty(x.Title));

            RuleFor(x => x.Width)
                .GreaterThan(0).WithMessage("Width must be greater than 0")
                .LessThanOrEqualTo(10000).WithMessage("Width cannot exceed 10000 pixels");

            RuleFor(x => x.Height)
                .GreaterThan(0).WithMessage("Height must be greater than 0")
                .LessThanOrEqualTo(10000).WithMessage("Height cannot exceed 10000 pixels");
        }
    }

    public class ProductMediaUpdateDtoValidator : AbstractValidator<ProductMediaUpdateDto>
    {
        public ProductMediaUpdateDtoValidator()
        {
            RuleFor(x => x.Url)
                .NotEmpty().WithMessage("URL is required")
                .MaximumLength(500).WithMessage("URL cannot exceed 500 characters");

            RuleFor(x => x.FullUrl)
                .NotEmpty().WithMessage("Full URL is required")
                .MaximumLength(2000).WithMessage("Full URL cannot exceed 2000 characters")
                .Must(Helper.BeValidUrl).WithMessage("Full URL must be a valid URL");

            RuleFor(x => x.MediaType)
                .NotEmpty().WithMessage("Media type is required")
                .MaximumLength(50).WithMessage("Media type cannot exceed 50 characters")
                .Must(Helper.BeValidMediaType).WithMessage("Media type must be : PHOTO");

            RuleFor(x => x.AltText)
                .MaximumLength(200).WithMessage("Alt text cannot exceed 200 characters")
                .When(x => !string.IsNullOrEmpty(x.AltText));

            RuleFor(x => x.Title)
                .MaximumLength(200).WithMessage("Title cannot exceed 200 characters")
                .When(x => !string.IsNullOrEmpty(x.Title));

            RuleFor(x => x.Width)
                .GreaterThan(0).WithMessage("Width must be greater than 0")
                .LessThanOrEqualTo(10000).WithMessage("Width cannot exceed 10000 pixels");

            RuleFor(x => x.Height)
                .GreaterThan(0).WithMessage("Height must be greater than 0")
                .LessThanOrEqualTo(10000).WithMessage("Height cannot exceed 10000 pixels");
        }
    }
}

================
File: AutoPile.API/Validators/ProductRequestValidator.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using FluentValidation;

namespace AutoPile.API.Validators
{
    public class ProductRequestValidator : AbstractValidator<ProductCreateDTO>
    {
        public ProductRequestValidator()
        {
            RuleFor(x => x.Name)
               .NotEmpty().WithMessage("Product name is required")
               .MaximumLength(200).WithMessage("Product name cannot exceed 200 characters");

            RuleFor(x => x.Description)
                .NotEmpty().WithMessage("Product description is required")
                .MaximumLength(1000).WithMessage("Description cannot exceed 1000 characters");

            RuleFor(x => x.ProductInfo)
                .NotEmpty().WithMessage("Product info is required")
                .MaximumLength(2000).WithMessage("Product info cannot exceed 2000 characters");

            RuleFor(x => x.SKU)
                .NotEmpty().WithMessage("SKU is required")
                .MaximumLength(50).WithMessage("SKU cannot exceed 50 characters")
                .Matches(@"^[A-Za-z0-9-]+$").WithMessage("SKU can only contain letters, numbers, and hyphens");

            RuleFor(x => x.Price)
                .GreaterThanOrEqualTo(0).WithMessage("Price must be greater than or equal to 0")
                .PrecisionScale(18, 2, true).WithMessage("Price cannot have more than 2 decimal places");

            RuleFor(x => x.ComparePrice)
                .GreaterThanOrEqualTo(0).When(x => x.ComparePrice.HasValue)
                .PrecisionScale(18, 2, true).When(x => x.ComparePrice.HasValue)
                .Must((model, comparePrice) => !comparePrice.HasValue || comparePrice.Value < model.Price)
                .WithMessage("Compare price must be less than regular price when specified");

            RuleFor(x => x.StockQuantity)
                .GreaterThanOrEqualTo(0).WithMessage("Stock quantity must be greater than or equal to 0")
                .Must((model, quantity) => !model.IsInStock || quantity > 0)
                .WithMessage("Stock quantity must be greater than 0 when product is in stock");

            RuleFor(x => x.Category)
            .IsInEnum().NotEmpty()
            .WithMessage("Invalid category value");

            RuleFor(x => x.Ribbon)
                .IsInEnum().WithMessage("Invalid ribbon value");

            RuleFor(x => x)
                .Must(x => !x.IsInStock || x.StockQuantity > 0)
                .WithMessage("Cannot mark product as in stock with zero quantity")
                .Must(x => x.IsInStock || x.StockQuantity == 0)
                .WithMessage("Out of stock products should have zero quantity");
        }
    }
}

================
File: AutoPile.API/Validators/ReviewRequestValidator.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.Models.Entities;
using FluentValidation;

namespace AutoPile.API.Validators
{
    public class ReviewRequestValidator : AbstractValidator<ReviewCreateDTO>
    {
        private bool BeValidImage(IFormFile file)
        {
            if (file == null) return true;

            if (file.Length > 5 * 1024 * 1024)
                return false;

            var allowedExtensions = new[] { ".jpg", ".jpeg", ".png" };
            var extension = Path.GetExtension(file.FileName).ToLowerInvariant();

            return allowedExtensions.Contains(extension);
        }

        public ReviewRequestValidator()
        {
            //RuleFor(x => x.UserId)
            //     .NotEmpty().WithMessage("User ID is required")
            //     .MaximumLength(450).WithMessage("User ID cannot exceed 450 characters");

            RuleFor(x => x.ProductId)
            .NotEmpty().WithMessage("Product ID is required")
            .Matches(@"^[0-9a-fA-F]{24}$").WithMessage("Invalid MongoDB ObjectId format for Product ID");

            RuleFor(x => x.Title)
                .NotEmpty().WithMessage("Title is required")
                .MaximumLength(200).WithMessage("Title cannot exceed 200 characters");

            RuleFor(x => x.Subtitle)
                .MaximumLength(500).WithMessage("Subtitle cannot exceed 500 characters");

            RuleFor(x => x.Content)
                .NotEmpty().WithMessage("Content is required")
                .MinimumLength(10).WithMessage("Content must be at least 10 characters long")
                .MaximumLength(5000).WithMessage("Content cannot exceed 5000 characters");

            RuleFor(x => x.Rating)
                .InclusiveBetween(1, 5).WithMessage("Rating must be between 1 and 5");

            RuleFor(x => x.Image)
                .Must(BeValidImage).When(x => x.Image != null)
                .WithMessage("Invalid image format. Only jpg, jpeg, png files are allowed and must be less than 5MB");
        }
    }
}

================
File: AutoPile.API/Validators/ReviewUpdateValidator.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using FluentValidation;

namespace AutoPile.API.Validators
{
    public class ReviewUpdateValidator : AbstractValidator<ReviewUpdateDTO>
    {
        public ReviewUpdateValidator()
        {
            RuleFor(x => x.Title)
                .MaximumLength(200).WithMessage("Title cannot exceed 200 characters");

            RuleFor(x => x.Subtitle)
                .MaximumLength(500).WithMessage("Subtitle cannot exceed 500 characters");

            RuleFor(x => x.Content)
                .MinimumLength(10).WithMessage("Content must be at least 10 characters long")
                .MaximumLength(5000).WithMessage("Content cannot exceed 5000 characters");

            RuleFor(x => x.Rating)
                .InclusiveBetween(1, 5).WithMessage("Rating must be between 1 and 5");

            RuleFor(x => x.Image)
                .Must(BeValidImage).When(x => x.Image != null)
                .WithMessage("Invalid image format. Only jpg, jpeg, png files are allowed and must be less than 5MB");
        }

        private bool BeValidImage(IFormFile file)
        {
            if (file == null) return true;

            if (file.Length > 5 * 1024 * 1024)
                return false;

            var allowedExtensions = new[] { ".jpg", ".jpeg", ".png" };
            var extension = Path.GetExtension(file.FileName).ToLowerInvariant();

            return allowedExtensions.Contains(extension);
        }
    }
}

================
File: AutoPile.API/Validators/ShoppingCartItemValidator.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using FluentValidation;
using MongoDB.Bson;

namespace AutoPile.API.Validators
{
    public class ShoppingCartItemValidator : AbstractValidator<ShoppingCartItemRequestDto>
    {
        public ShoppingCartItemValidator()
        {
            RuleFor(x => x.ProductId)
            .NotEmpty()
            .WithMessage("Product ID is required.")
            .Must(BeValidObjectId)
            .WithMessage("Invalid MongoDB ObjectId format for Product ID");

            RuleFor(x => x.Quantity)
                .NotEmpty()
                .WithMessage("Quantity is required.")
                .LessThanOrEqualTo(100)
                .WithMessage("Quantity cannot exceed 100 items per order.");
        }

        private bool BeValidObjectId(string productId)
        {
            return !string.IsNullOrEmpty(productId) && ObjectId.TryParse(productId, out _);
        }
    }

    public class UpdateShoppingCartItemValidator : AbstractValidator<UpdateShoppingCartItemDto>
    {
        public UpdateShoppingCartItemValidator()
        {
            RuleFor(x => x.Quantity)
                .NotEmpty()
                .WithMessage("Quantity is required.")
                .GreaterThan(0)
                .WithMessage("Quantity must be greater than 0.")
                .LessThanOrEqualTo(100)
                .WithMessage("Quantity cannot exceed 100 items.");
        }
    }
}

================
File: AutoPile.API/Validators/UserSigninDTOValidator.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using FluentValidation;

namespace AutoPile.API.Validators
{
    public class UserSigninDTOValidator : AbstractValidator<UserSigninDTO>
    {
        public UserSigninDTOValidator()
        {
            RuleFor(u => u.Email)
                .NotEmpty().WithMessage("Email is required")
                .EmailAddress().WithMessage("Invalid email format");

            RuleFor(u => u.Password)
                .NotEmpty().WithMessage("Password is required");
        }
    }

    public class UserSignupDTOValidator : AbstractValidator<UserSignupDTO>
    {
        public UserSignupDTOValidator()
        {
            RuleFor(u => u.UserName)
                .NotEmpty().WithMessage("Username is required")
                .MinimumLength(3).WithMessage("Username must be at least 3 characters")
                .MaximumLength(100).WithMessage("Username must not exceed 100 characters")
                .Matches("^[a-zA-Z0-9._-]+$").WithMessage("Username can only contain letters, numbers, dots, underscores, and hyphens");

            RuleFor(u => u.FirstName)
                .NotEmpty().WithMessage("First name is required")
                .MaximumLength(100).WithMessage("First name must not exceed 100 characters")
                .Matches("^[a-zA-Z\\s-']+$").WithMessage("First name can only contain letters, spaces, hyphens, and apostrophes");

            RuleFor(u => u.LastName)
                .NotEmpty().WithMessage("Last name is required")
                .MaximumLength(100).WithMessage("Last name must not exceed 100 characters")
                .Matches("^[a-zA-Z\\s-']+$").WithMessage("Last name can only contain letters, spaces, hyphens, and apostrophes");

            RuleFor(u => u.Email)
                .NotEmpty().WithMessage("Email is required")
                .EmailAddress().WithMessage("Invalid email format")
                .MaximumLength(100).WithMessage("Email must not exceed 100 characters");

            RuleFor(u => u.Password)
                .NotEmpty().WithMessage("Password is required")
                .MinimumLength(8).WithMessage("Password must be at least 8 characters")
                .MaximumLength(100).WithMessage("Password must not exceed 100 characters")
                .Matches("[A-Z]").WithMessage("Password must contain at least one uppercase letter")
                .Matches("[a-z]").WithMessage("Password must contain at least one lowercase letter")
                .Matches("[0-9]").WithMessage("Password must contain at least one number")
                .Matches("[^a-zA-Z0-9]").WithMessage("Password must contain at least one special character");

            RuleFor(u => u.PhoneNumber)
                .NotEmpty().WithMessage("Phone number is required")
                .MaximumLength(20).WithMessage("Phone number must not exceed 20 characters")
                .Matches("^[0-9]{8,20}$").WithMessage("Invalid phone number format. Use a standard numeric format (e.g., 0123456789)");
        }
    }

    public class UserUpdateInfoDTOValidator : AbstractValidator<UserUpdateInfoDTO>
    {
        public UserUpdateInfoDTOValidator()
        {
            RuleFor(u => u.FirstName)
                .MaximumLength(100).WithMessage("First name must not exceed 100 characters")
                .Matches("^[a-zA-Z\\s-']+$").WithMessage("First name can only contain letters, spaces, hyphens, and apostrophes")
                .When(u => !string.IsNullOrEmpty(u.FirstName));

            RuleFor(u => u.LastName)
                .MaximumLength(100).WithMessage("Last name must not exceed 100 characters")
                .Matches("^[a-zA-Z\\s-']+$").WithMessage("Last name can only contain letters, spaces, hyphens, and apostrophes")
                .When(u => !string.IsNullOrEmpty(u.LastName));

            RuleFor(u => u.PhoneNumber)
                .MaximumLength(20).WithMessage("Phone number must not exceed 20 characters")
                .Matches("^\\+?[1-9][0-9]{7,14}$").WithMessage("Invalid phone number format. Use international format (e.g., +1234567890)")
                .When(u => !string.IsNullOrEmpty(u.PhoneNumber));
        }
    }

    public class UserResetPasswordDTOValidator : AbstractValidator<UserResetPasswordDTO>
    {
        public UserResetPasswordDTOValidator()
        {
            RuleFor(u => u.NewPassword)
                .NotEmpty().WithMessage("New password is required")
                .MinimumLength(8).WithMessage("Password must be at least 8 characters")
                .MaximumLength(100).WithMessage("Password must not exceed 100 characters")
                .Matches("[A-Z]").WithMessage("Password must contain at least one uppercase letter")
                .Matches("[a-z]").WithMessage("Password must contain at least one lowercase letter")
                .Matches("[0-9]").WithMessage("Password must contain at least one number")
                .Matches("[^a-zA-Z0-9]").WithMessage("Password must contain at least one special character");

            RuleFor(u => u.Email)
                .NotEmpty().WithMessage("Email is required")
                .EmailAddress().WithMessage("Invalid email format")
                .MaximumLength(100).WithMessage("Email must not exceed 100 characters");

            RuleFor(u => u.EmailVerifyToken)
                .NotEmpty().WithMessage("Email verification token is required")
                .MaximumLength(300).WithMessage("Email verification token must not exceed 300 characters");
        }
    }
}

================
File: AutoPile.API/Validators/ValidateTokenRequestValidator.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using FluentValidation;

namespace AutoPile.API.Validators
{
    public class ValidateTokenRequestValidator : AbstractValidator<ValidateTokenRequest>
    {
        public ValidateTokenRequestValidator()
        {
            RuleFor(x => x.Email)
                .NotEmpty().WithMessage("Email is required")
                .EmailAddress().WithMessage("A valid email address is required")
                .MaximumLength(256).WithMessage("Email must not exceed 256 characters");

            RuleFor(x => x.Token)
                .NotEmpty().WithMessage("Token is required");
        }
    }
}

================
File: AutoPile.DATA/AutoPile.DATA.csproj
================
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <UserSecretsId>6cdf8e20-f1aa-491a-8988-e8f2b94dc7c1</UserSecretsId>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.10" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.10">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.Extensions.Caching.StackExchangeRedis" Version="9.0.0" />
    <PackageReference Include="Microsoft.Extensions.Configuration" Version="9.0.0" />
    <PackageReference Include="Microsoft.Extensions.Configuration.FileExtensions" Version="9.0.0" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="9.0.0" />
    <PackageReference Include="Microsoft.Extensions.Configuration.UserSecrets" Version="6.0.1" />
    <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\AutoPile.DOMAIN\AutoPile.DOMAIN.csproj" />
  </ItemGroup>

</Project>

================
File: AutoPile.DATA/Cache/CacheKeys.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Cache
{
    public static class CacheKeys
    {
        public static string ShoppingCart(string userId) => $"ShoppingCart:{userId}";

        public static string Product(string productId) => $"Product:{productId}";

        public static string Review(string productId) => $"Product:{productId}:Reviews";

        public static string User(string applicationUserId) => $"User:{applicationUserId}";

        public static string Order(string applicationUserId) => $"Order:{applicationUserId}";
    };
}

================
File: AutoPile.DATA/Cache/CacheRepository/RedisCache.cs
================
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.Extensions.Caching.Distributed;
using Microsoft.Extensions.Caching.StackExchangeRedis;
using Microsoft.Extensions.Logging;
using Microsoft.Identity.Client;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;

namespace AutoPile.DATA.Cache.CacheRepository
{
    public class RedisCache<T> : IRedisCache<T> where T : class
    {
        private readonly IDistributedCache _redis;
        private readonly ILogger<RedisCache<T>> _logger; // Add logger

        public RedisCache(IDistributedCache redis, ILogger<RedisCache<T>> logger)
        {
            _redis = redis;
            _logger = logger;
        }

        public async Task<T?> GetAsync(string key)
        {
            var cachedValue = await _redis.GetStringAsync(key);
            _logger.LogInformation("Redis GET for key {Key}: {Value}", key,
                cachedValue ?? "null");
            if (!string.IsNullOrEmpty(cachedValue))
            {
                await _redis.RefreshAsync(key);
                return JsonSerializer.Deserialize<T>(cachedValue);
            }
            return default;
        }

        public async Task<IEnumerable<T>?> GetAsyncToList(string key)
        {
            var cachedValue = await _redis.GetStringAsync(key);
            if (!string.IsNullOrEmpty(cachedValue))
            {
                await _redis.RefreshAsync(key);
                return JsonSerializer.Deserialize<IEnumerable<T>>(cachedValue);
            }
            return default;
        }

        public async Task SetAsync(string key, T item, DistributedCacheEntryOptions cacheOptions)
        {
            var cachedProduct = await GetAsync(key);
            if (cachedProduct != null)
            {
                _logger.LogInformation("Redis SET for key {Key}: {Value}", key, JsonSerializer.Serialize(item));
                await _redis.SetStringAsync(key, JsonSerializer.Serialize(item), cacheOptions);
            }
            else
            {
                await _redis.RemoveAsync(key);
                _logger.LogInformation("Redis SET for key {Key}: {Value}", key, JsonSerializer.Serialize(item));
                await _redis.SetStringAsync(key, JsonSerializer.Serialize(item), cacheOptions);
            }
        }

        public async Task SetAsyncToList(string key, IEnumerable<T> item, DistributedCacheEntryOptions cacheOptions)
        {
            var cachedProduct = await GetAsync(key);
            if (cachedProduct != null)
            {
                await _redis.SetStringAsync(key, JsonSerializer.Serialize(item), cacheOptions);
            }
            else
            {
                await _redis.RemoveAsync(key);
                await _redis.SetStringAsync(key, JsonSerializer.Serialize(item), cacheOptions);
            }
        }

        public async Task RemoveAsync(string key)
        {
            var cachedProduct = await GetAsync(key);
            if (cachedProduct != null)
            {
                await _redis.RemoveAsync(key);
            }
        }

        public async Task RemoveAsyncToList(string key)
        {
            var cachedProduct = await GetAsyncToList(key);
            if (cachedProduct != null)
            {
                await _redis.RemoveAsync(key);
            }
        }
    }
}

================
File: AutoPile.DATA/Cache/OrderCache.cs
================
using AutoPile.DOMAIN.DTOs.Responses;
using Microsoft.Extensions.Caching.Distributed;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Cache
{
    public class OrderCache : IOrderCache
    {
        private readonly IRedisCache<OrderResponseDTO> _redisCache;
        private readonly DistributedCacheEntryOptions _cacheOptions;

        public OrderCache(IRedisCache<OrderResponseDTO> redisCache)
        {
            _redisCache = redisCache;
            _cacheOptions = new DistributedCacheEntryOptions()
            {
                AbsoluteExpirationRelativeToNow = TimeSpan.FromDays(3),
            };
        }

        public async Task<IEnumerable<OrderResponseDTO>?> GetOrderAsync(string applicationUserId)
        {
            return await _redisCache.GetAsyncToList(CacheKeys.Order(applicationUserId));
        }

        public async Task SetOrderAsync(string applicationUserId, IEnumerable<OrderResponseDTO> orderResponseDTOs)
        {
            await _redisCache.SetAsyncToList(CacheKeys.Order(applicationUserId), orderResponseDTOs, _cacheOptions);
        }

        public async Task DeleteOrderAsync(string applicationUserId)
        {
            await _redisCache.RemoveAsyncToList(CacheKeys.Order(applicationUserId));
        }

        public async Task UpdateOrderAsync(OrderResponseDTO orderResponseDTO)
        {
            var orderList = await _redisCache.GetAsyncToList(CacheKeys.Review(orderResponseDTO.UserId));

            if (orderList != null)
            {
                var order = orderList.FirstOrDefault(o => o.Id == orderResponseDTO.Id);
                if (order != null)
                {
                    orderList.ToList().Remove(order);
                    orderList.ToList().Add(orderResponseDTO);
                    await SetOrderAsync(orderResponseDTO.UserId, orderList);
                }
            }
        }
    }
}

================
File: AutoPile.DATA/Cache/ProductCache.cs
================
using AutoPile.DOMAIN.DTOs.Responses;
using Microsoft.Extensions.Caching.Distributed;
using StackExchange.Redis;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Cache
{
    public class ProductCache : IProductCache
    {
        private readonly IRedisCache<ProductResponseDTO> _redisCache;
        private readonly DistributedCacheEntryOptions _cacheOptions;

        public ProductCache(IRedisCache<ProductResponseDTO> redisCache)
        {
            _redisCache = redisCache;
            _cacheOptions = new DistributedCacheEntryOptions()
            {
                AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(30),
            };
        }

        public async Task<ProductResponseDTO?> GetProductAsync(string productId)
        {
            return await _redisCache.GetAsync(CacheKeys.Product(productId));
        }

        public async Task SetProductAsync(string productId, ProductResponseDTO productResponseDTO)
        {
            await _redisCache.SetAsync(CacheKeys.Product(productId), productResponseDTO, _cacheOptions);
        }

        public async Task DeleteProductAsync(string productId)
        {
            await _redisCache.RemoveAsync(CacheKeys.Product(productId));
        }
    }
}

================
File: AutoPile.DATA/Cache/RedisShoppingCartCache.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.Extensions.Caching.Distributed;
using Microsoft.Identity.Client;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;

namespace AutoPile.DATA.Cache
{
    public class RedisShoppingCartCache : IRedisShoppingCartCache
    {
        private readonly IDistributedCache _redis;
        private readonly DistributedCacheEntryOptions _cacheOptions;

        public RedisShoppingCartCache(IDistributedCache redis)
        {
            _redis = redis;
            _cacheOptions = new DistributedCacheEntryOptions
            {
                AbsoluteExpirationRelativeToNow = TimeSpan.FromDays(7),
                SlidingExpiration = TimeSpan.FromHours(24)
            };
        }

        public async Task<ShoppingCartItem?> GetItemAsync(string userId, int itemId)
        {
            var cart = await GetUserCartAsync(userId);
            return cart?.FirstOrDefault(i => i.Id == itemId);
        }

        public async Task<List<ShoppingCartItem>> GetUserCartAsync(string userId)
        {
            var key = CacheKeys.ShoppingCart(userId);
            var cart = await _redis.GetStringAsync(key);

            if (string.IsNullOrEmpty(cart))
                return new List<ShoppingCartItem>();
            await _redis.RefreshAsync(key);
            return JsonSerializer.Deserialize<List<ShoppingCartItem>>(cart);
        }

        public async Task SetItemAsync(ShoppingCartItem shoppingCartItem)
        {
            var cart = await GetUserCartAsync(shoppingCartItem.UserId);
            var existingItem = cart.FirstOrDefault(i => i.Id == shoppingCartItem.Id);
            if (existingItem != null)
            {
                cart.Remove(existingItem);
                cart.Add(shoppingCartItem);
            }
            else
            {
                cart.Add(shoppingCartItem);
            }
            var key = CacheKeys.ShoppingCart(shoppingCartItem.UserId);
            await _redis.SetStringAsync(key, JsonSerializer.Serialize(cart), _cacheOptions);
        }

        public async Task RemoveItemAsync(string userId, int itemId)
        {
            var cart = await GetUserCartAsync(userId);
            var existingItem = cart.FirstOrDefault(i => i.Id == itemId);
            if (existingItem != null)
            {
                cart.Remove(existingItem);
                var key = CacheKeys.ShoppingCart(userId);
                await _redis.SetStringAsync(key, JsonSerializer.Serialize(cart), _cacheOptions);
            }
        }

        public async Task ClearCartAsync(string userId)
        {
            var key = CacheKeys.ShoppingCart(userId);
            await _redis.RemoveAsync(key);
        }
    }
}

================
File: AutoPile.DATA/Cache/ReviewsCache.cs
================
using AutoPile.DATA.Data;
using AutoPile.DATA.Exceptions;
using AutoPile.DOMAIN.DTOs.Responses;
using Microsoft.Extensions.Caching.Distributed;
using MongoDB.Bson;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Cache
{
    public class ReviewsCache : IReviewsCache
    {
        private readonly IRedisCache<ReviewResponseDTO> _redisCache;
        private readonly DistributedCacheEntryOptions _cacheOptions;
        private readonly AutoPileMongoDbContext _mongoContext;

        public ReviewsCache(IRedisCache<ReviewResponseDTO> redisCache, AutoPileMongoDbContext mongoContext)
        {
            _redisCache = redisCache;
            _cacheOptions = new DistributedCacheEntryOptions()
            {
                AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(30),
            };
            _mongoContext = mongoContext;
        }

        public async Task<IEnumerable<ReviewResponseDTO>?> GetReviewAsync(string productId)
        {
            return await _redisCache.GetAsyncToList(CacheKeys.Review(productId));
        }

        public async Task SetReviewAsync(string productId, IEnumerable<ReviewResponseDTO> reviewResponseDTO)
        {
            await _redisCache.SetAsyncToList(CacheKeys.Review(productId), reviewResponseDTO, _cacheOptions);
        }

        public async Task DeleteReviewAsync(string productId, string reviewId)
        {
            var reviewList = await _redisCache.GetAsyncToList(CacheKeys.Review(productId));

            if (reviewList != null)
            {
                var reviews = reviewList.ToList();
                var reviewToRemove = reviews.FirstOrDefault(rv => rv.Id == reviewId);
                if (reviewToRemove != null)
                {
                    reviews.Remove(reviewToRemove);

                    if (!reviews.Any())
                    {
                        await _redisCache.RemoveAsyncToList(CacheKeys.Review(productId));
                    }
                }
            }
        }

        public async Task UpdateReviewAsync(ReviewResponseDTO reviewResponseDTO)
        {
            var reviewList = await _redisCache.GetAsyncToList(CacheKeys.Review(reviewResponseDTO.ProductId));

            if (reviewList != null)
            {
                var review = reviewList.FirstOrDefault(rv => rv.Id == reviewResponseDTO.Id);
                if (review != null)
                {
                    reviewList.ToList().Remove(review);
                    reviewList.ToList().Add(reviewResponseDTO);
                    await SetReviewAsync(reviewResponseDTO.ProductId, reviewList);
                }
            }
        }
    }
}

================
File: AutoPile.DATA/Cache/UserInfoCache.cs
================
using AutoPile.DOMAIN.DTOs.Responses;
using Microsoft.Extensions.Caching.Distributed;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Cache
{
    public class UserInfoCache : IUserInfoCache
    {
        private readonly IRedisCache<UserInfoResponseDTO> _redisCache;
        private readonly DistributedCacheEntryOptions _cacheOptions;

        public UserInfoCache(IRedisCache<UserInfoResponseDTO> redisCache)
        {
            _redisCache = redisCache;
            _redisCache = redisCache;
            _cacheOptions = new DistributedCacheEntryOptions()
            {
                SlidingExpiration = TimeSpan.FromHours(12)
            };
        }

        public async Task SetUserAsync(string applicationUserId, UserInfoResponseDTO userInfoResponseDTO)
        {
            await _redisCache.SetAsync(CacheKeys.User(applicationUserId), userInfoResponseDTO, _cacheOptions);
        }

        public async Task<UserInfoResponseDTO?> GetUserAsync(string applicationUserId)
        {
            return await _redisCache.GetAsync(CacheKeys.User(applicationUserId));
        }
    }
}

================
File: AutoPile.DATA/Configurations/OrderConfigurations.cs
================
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Configurations
{
    public class OrderConfigurations : IEntityTypeConfiguration<Order>
    {
        public void Configure(EntityTypeBuilder<Order> builder)
        {
            builder.Property(e => e.DeliveryFee).HasPrecision(18, 2);
            builder.Property(e => e.SubTotal).HasPrecision(18, 2);
            builder.Property(e => e.TotalAmount).HasPrecision(18, 2);
        }
    }
}

================
File: AutoPile.DATA/Configurations/OrderItemConfigurations.cs
================
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Configurations
{
    public class OrderItemConfigurations : IEntityTypeConfiguration<OrderItem>
    {
        public void Configure(EntityTypeBuilder<OrderItem> builder)
        {
            builder.Property(e => e.ProductPrice).HasPrecision(18, 2);
            builder.Property(e => e.TotalPrice).HasPrecision(18, 2);
            builder.Property(e => e.ProductId).HasMaxLength(24);
        }
    }
}

================
File: AutoPile.DATA/Configurations/ProductConfigurations.cs
================
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Configurations
{
    public class ProductConfigurations : IEntityTypeConfiguration<Product>
    {
        public void Configure(EntityTypeBuilder<Product> builder)
        {
            builder.Property(e => e.Price).HasPrecision(18, 2);
            builder.Property(e => e.ComparePrice).HasPrecision(18, 2);
        }
    }
}

================
File: AutoPile.DATA/Configurations/ShoppingCartItemConfigurations.cs
================
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Configurations
{
    public class ShoppingCartItemConfigurations : IEntityTypeConfiguration<ShoppingCartItem>
    {
        public void Configure(EntityTypeBuilder<ShoppingCartItem> builder)
        {
            builder.Property(s => s.ProductId).HasMaxLength(24);
        }
    }
}

================
File: AutoPile.DATA/Data/AutoPileManagementDbContext.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using AutoPile.DATA.Configurations;
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;

namespace AutoPile.DATA.Data
{
    public class AutoPileManagementDbContext : IdentityDbContext<ApplicationUser, ApplicationRole, string>
    {
        public AutoPileManagementDbContext(DbContextOptions<AutoPileManagementDbContext> options)
            : base(options)
        {
        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);
            modelBuilder.ApplyConfiguration(new OrderConfigurations());
            modelBuilder.ApplyConfiguration(new OrderItemConfigurations());

            modelBuilder.ApplyConfiguration(new ShoppingCartItemConfigurations());

            modelBuilder.Entity<Order>().HasMany(o => o.OrderItems).WithOne(o => o.Order).HasForeignKey(o => o.OrderId);

            modelBuilder.Entity<ApplicationUser>().HasMany(u => u.Orders).WithOne(u => u.User).HasForeignKey(u => u.UserId);

            modelBuilder.Entity<ApplicationUser>().HasMany(u => u.ShoppingCartItems).WithOne(u => u.User).HasForeignKey(u => u.UserId);
        }

        public DbSet<ApplicationUser> ApplicationUsers { get; set; }
        public DbSet<ApplicationRole> ApplicationRoles { get; set; }
        public DbSet<OrderItem> OrderItems { get; set; }
        public DbSet<Order> Orders { get; set; }

        public DbSet<ShoppingCartItem> ShoppingCartItems { get; set; }
    }
}

================
File: AutoPile.DATA/Data/AutoPileMongoDbContext.cs
================
using AutoPile.DATA.Configurations;
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.EntityFrameworkCore;
using MongoDB.Driver;
using MongoDB.EntityFrameworkCore.Extensions;
using MongoDB.EntityFrameworkCore.Infrastructure;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Data
{
    public class AutoPileMongoDbContext : DbContext
    {
        public virtual DbSet<Product> Products { get; set; }
        public virtual DbSet<Review> Reviews { get; set; }

        public static AutoPileMongoDbContext Create(IMongoDatabase database) =>
            new(new DbContextOptionsBuilder<AutoPileMongoDbContext>()
                .UseMongoDB(database.Client, database.DatabaseNamespace.DatabaseName)
                .Options);

        public AutoPileMongoDbContext(DbContextOptions options) : base(options)
        {
        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            modelBuilder.ApplyConfiguration(new ProductConfigurations());
            base.OnModelCreating(modelBuilder);

            modelBuilder.Entity<Product>().ToCollection("products");
            modelBuilder.Entity<Review>().ToCollection("reviews");
        }
    }
}

================
File: AutoPile.DATA/Exceptions/AbstractHTTPexception.cs
================
using AutoPile.DOMAIN.Interface;
using Microsoft.AspNetCore.Http;
using Newtonsoft.Json;

namespace AutoPile.DATA.Exceptions
{
    public abstract class AbstractHTTPexception : Exception, IExceptionHandler
    {
        public int StatusCode { get; set; }
        public Guid Id { get; } = Guid.NewGuid();
        public DateTime DateTime { get; } = DateTime.Now;

        protected AbstractHTTPexception(int statusCode, string message) : base(message)
        {
            StatusCode = statusCode;
        }

        public Task HandleExceptionAsync(HttpContext context)
        {
            context.Response.StatusCode = StatusCode;
            context.Response.ContentType = "application/json";

            var response = new
            {
                code = StatusCode,
                success = false,
                message = base.Message,
            };
            return context.Response.WriteAsync(JsonConvert.SerializeObject(response));
        }
    }
}

================
File: AutoPile.DATA/Exceptions/BadRequestException.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Exceptions
{
    public class BadRequestException : AbstractHTTPexception
    {
        public BadRequestException() : base(400, "Bad Request")
        {
        }

        public BadRequestException(string message) : base(400, message)
        {
        }
    }
}

================
File: AutoPile.DATA/Exceptions/NotFoundException.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Exceptions
{
    public class NotFoundException : AbstractHTTPexception
    {
        public NotFoundException() : base(404, "Not Found")
        {
        }

        public NotFoundException(string message) : base(404, message)
        {
        }
    }
}

================
File: AutoPile.DATA/Exceptions/UnauthorizedException.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Exceptions
{
    public class ForbiddenException : AbstractHTTPexception
    {
        public ForbiddenException() : base(403, "Forbidden")
        {
        }

        public ForbiddenException(string message) : base(403, message)
        {
        }
    }
}

================
File: AutoPile.DATA/Middlewares/ExceptionHandlingMiddleware.cs
================
using AutoPile.DATA.Exceptions;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Middlewares
{
    public class ExceptionHandlingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<ExceptionHandlingMiddleware> _logger;

        public ExceptionHandlingMiddleware(RequestDelegate next, ILogger<ExceptionHandlingMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext httpContext)
        {
            try
            {
                await _next(httpContext);
            }
            catch (AbstractHTTPexception ex)
            {
                _logger.LogError(ex, $"Http status: {ex.StatusCode}, Error Id: {ex.Id}, Error Time: {ex.DateTime}");
                await ex.HandleExceptionAsync(httpContext);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Http status: {500}, Error Id: {Guid.NewGuid()}, Error Time: {DateTime.Now}");
                await HandleGeneralExceptionAsync(httpContext, ex);
            }
        }

        private Task HandleGeneralExceptionAsync(HttpContext context, Exception ex)
        {
            context.Response.ContentType = "application/json";
            context.Response.StatusCode = (int)HttpStatusCode.InternalServerError;
            var response = new
            {
                code = (int)HttpStatusCode.InternalServerError,
                message = "Internal Server Error",
                success = false,
                detailed = ex.Message
            };
            return context.Response.WriteAsync(JsonConvert.SerializeObject(response));
        }
    }
}

================
File: AutoPile.DATA/Middlewares/UserIdExtractMiddleware.cs
================
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using Microsoft.IdentityModel.Tokens;
using System;
using System.Diagnostics;
using System.IdentityModel.Tokens.Jwt;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DATA.Middlewares
{
    public class UserIdExtractMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly IConfiguration _configuration;
        private readonly ILogger<UserIdExtractMiddleware> _logger;

        public UserIdExtractMiddleware(RequestDelegate next, IConfiguration configuration, ILogger<UserIdExtractMiddleware> logger)
        {
            _next = next;
            _configuration = configuration;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext httpcontext)
        {
            try
            {
                var requestId = Activity.Current?.Id ?? httpcontext.TraceIdentifier;
                _logger.LogInformation("Request {RequestId} - Begin processing request for path: {Path}",
                    requestId, httpcontext.Request.Path);

                var token = httpcontext.Request.Cookies["AuthToken"];
                if (token != null)
                {
                    _logger.LogInformation("Request {RequestId} - Found auth token in cookies", requestId);
                    _logger.LogInformation("Token value: {TokenPrefix}...",
                        token.Substring(0, Math.Min(6, token.Length)));

                    try
                    {
                        var handler = new JwtSecurityTokenHandler();
                        var jwtToken = handler.ReadJwtToken(token);

                        // Log token details before validation
                        _logger.LogInformation("Token Issuer: {Issuer}, Expires: {Expires}",
                            jwtToken.Issuer,
                            jwtToken.ValidTo);

                        ValidateToken(token);
                        _logger.LogInformation("Token validation successful");

                        var userId = jwtToken.Claims.FirstOrDefault(c =>
                               c.Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value;
                        if (userId != null)
                        {
                            httpcontext.Items["UserId"] = userId;
                            _logger.LogInformation("Request {RequestId} - User ID {UserId} extracted and set in context",
                                requestId, userId);
                        }
                    }
                    catch (SecurityTokenExpiredException ex)
                    {
                        _logger.LogWarning("Token expired: {Message}", ex.Message);
                        throw;
                    }
                    catch (SecurityTokenInvalidIssuerException ex)
                    {
                        _logger.LogWarning("Invalid issuer: {Message}, Expected: {Expected}, Received: {Received}",
                            ex.Message,
                            Environment.GetEnvironmentVariable("ISSUER") ?? _configuration["Jwt:Issuer"],
                            ex.InvalidIssuer);
                        throw;
                    }
                    catch (SecurityTokenInvalidAudienceException ex)
                    {
                        _logger.LogWarning("Invalid audience: {Message}, Expected: {Expected}, Received: {Received}",
                            ex.Message,
                            Environment.GetEnvironmentVariable("AUDIENCE") ?? _configuration["Jwt:Audience"],
                            ex.InvalidAudience);
                        throw;
                    }
                }
                else
                {
                    _logger.LogInformation("Request {RequestId} - No auth token found in request cookies", requestId);
                }
            }
            catch (SecurityTokenException ex)
            {
                _logger.LogError(ex, "Request {RequestId} - Security token validation failed: {Message}",
                    httpcontext.TraceIdentifier, ex.Message);
                httpcontext.Response.StatusCode = 401;
                await httpcontext.Response.WriteAsync($"Invalid token: {ex.Message}");
                return;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Request {RequestId} - Unexpected error processing token: {Message}",
                    httpcontext.TraceIdentifier, ex.Message);
                httpcontext.Response.StatusCode = 500;
                await httpcontext.Response.WriteAsync($"An error occurred while processing the token: {ex.Message}");
                return;
            }

            await _next(httpcontext);
        }

        private void ValidateToken(string token)
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(Environment.GetEnvironmentVariable("JWTKEY") ?? _configuration["Jwt:Key"]);

            // Log validation parameters
            _logger.LogInformation("Validation Parameters: Issuer: {Issuer}, Audience: {Audience}",
                Environment.GetEnvironmentVariable("ISSUER") ?? _configuration["Jwt:Issuer"],
                Environment.GetEnvironmentVariable("AUDIENCE") ?? _configuration["Jwt:Audience"]);

            tokenHandler.ValidateToken(token, new TokenValidationParameters
            {
                ValidateIssuerSigningKey = true,
                IssuerSigningKey = new SymmetricSecurityKey(key),
                ValidateIssuer = true,
                ValidIssuer = Environment.GetEnvironmentVariable("ISSUER") ?? _configuration["Jwt:Issuer"],
                ValidateAudience = true,
                ValidAudience = Environment.GetEnvironmentVariable("AUDIENCE") ?? _configuration["Jwt:Audience"],
                ClockSkew = TimeSpan.Zero,
                ValidateLifetime = true
            }, out SecurityToken validatedToken);
        }
    }
}

================
File: AutoPile.DATA/Migrations/20241227180443_InitialCreate.cs
================
using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace AutoPile.DATA.Migrations
{
    /// <inheritdoc />
    public partial class InitialCreate : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.CreateTable(
                name: "AspNetRoles",
                columns: table => new
                {
                    Id = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    Name = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                    NormalizedName = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                    ConcurrencyStamp = table.Column<string>(type: "nvarchar(max)", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetRoles", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUsers",
                columns: table => new
                {
                    Id = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    EmailVerifyToken = table.Column<string>(type: "nvarchar(max)", nullable: true),
                    FirstName = table.Column<string>(type: "nvarchar(max)", nullable: true),
                    LastName = table.Column<string>(type: "nvarchar(max)", nullable: true),
                    UserName = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                    NormalizedUserName = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                    Email = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                    NormalizedEmail = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                    EmailConfirmed = table.Column<bool>(type: "bit", nullable: false),
                    PasswordHash = table.Column<string>(type: "nvarchar(max)", nullable: true),
                    SecurityStamp = table.Column<string>(type: "nvarchar(max)", nullable: true),
                    ConcurrencyStamp = table.Column<string>(type: "nvarchar(max)", nullable: true),
                    PhoneNumber = table.Column<string>(type: "nvarchar(max)", nullable: true),
                    PhoneNumberConfirmed = table.Column<bool>(type: "bit", nullable: false),
                    TwoFactorEnabled = table.Column<bool>(type: "bit", nullable: false),
                    LockoutEnd = table.Column<DateTimeOffset>(type: "datetimeoffset", nullable: true),
                    LockoutEnabled = table.Column<bool>(type: "bit", nullable: false),
                    AccessFailedCount = table.Column<int>(type: "int", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUsers", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "AspNetRoleClaims",
                columns: table => new
                {
                    Id = table.Column<int>(type: "int", nullable: false)
                        .Annotation("SqlServer:Identity", "1, 1"),
                    RoleId = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    ClaimType = table.Column<string>(type: "nvarchar(max)", nullable: true),
                    ClaimValue = table.Column<string>(type: "nvarchar(max)", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetRoleClaims", x => x.Id);
                    table.ForeignKey(
                        name: "FK_AspNetRoleClaims_AspNetRoles_RoleId",
                        column: x => x.RoleId,
                        principalTable: "AspNetRoles",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserClaims",
                columns: table => new
                {
                    Id = table.Column<int>(type: "int", nullable: false)
                        .Annotation("SqlServer:Identity", "1, 1"),
                    UserId = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    ClaimType = table.Column<string>(type: "nvarchar(max)", nullable: true),
                    ClaimValue = table.Column<string>(type: "nvarchar(max)", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserClaims", x => x.Id);
                    table.ForeignKey(
                        name: "FK_AspNetUserClaims_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserLogins",
                columns: table => new
                {
                    LoginProvider = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    ProviderKey = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    ProviderDisplayName = table.Column<string>(type: "nvarchar(max)", nullable: true),
                    UserId = table.Column<string>(type: "nvarchar(450)", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserLogins", x => new { x.LoginProvider, x.ProviderKey });
                    table.ForeignKey(
                        name: "FK_AspNetUserLogins_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserRoles",
                columns: table => new
                {
                    UserId = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    RoleId = table.Column<string>(type: "nvarchar(450)", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserRoles", x => new { x.UserId, x.RoleId });
                    table.ForeignKey(
                        name: "FK_AspNetUserRoles_AspNetRoles_RoleId",
                        column: x => x.RoleId,
                        principalTable: "AspNetRoles",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_AspNetUserRoles_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserTokens",
                columns: table => new
                {
                    UserId = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    LoginProvider = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    Name = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    Value = table.Column<string>(type: "nvarchar(max)", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserTokens", x => new { x.UserId, x.LoginProvider, x.Name });
                    table.ForeignKey(
                        name: "FK_AspNetUserTokens_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "Orders",
                columns: table => new
                {
                    Id = table.Column<int>(type: "int", nullable: false)
                        .Annotation("SqlServer:Identity", "1, 1"),
                    UserId = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    OrderNumber = table.Column<string>(type: "nvarchar(max)", nullable: false),
                    OrderDate = table.Column<DateTime>(type: "datetime2", nullable: false),
                    Status = table.Column<string>(type: "nvarchar(max)", nullable: false),
                    SubTotal = table.Column<decimal>(type: "decimal(18,2)", precision: 18, scale: 2, nullable: false),
                    DeliveryFee = table.Column<decimal>(type: "decimal(18,2)", precision: 18, scale: 2, nullable: false),
                    TotalAmount = table.Column<decimal>(type: "decimal(18,2)", precision: 18, scale: 2, nullable: false),
                    PaymentStatus = table.Column<string>(type: "nvarchar(max)", nullable: false),
                    PaymentMethod = table.Column<string>(type: "nvarchar(max)", nullable: false),
                    StripeSessionId = table.Column<string>(type: "nvarchar(max)", nullable: false),
                    ShippingAddress_Line1 = table.Column<string>(type: "nvarchar(max)", nullable: false),
                    ShippingAddress_Line2 = table.Column<string>(type: "nvarchar(max)", nullable: false),
                    ShippingAddress_City = table.Column<string>(type: "nvarchar(max)", nullable: false),
                    ShippingAddress_Country = table.Column<string>(type: "nvarchar(max)", nullable: false),
                    ShippingAddress_State = table.Column<string>(type: "nvarchar(max)", nullable: false),
                    ShippingAddress_PostalCode = table.Column<string>(type: "nvarchar(max)", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Orders", x => x.Id);
                    table.ForeignKey(
                        name: "FK_Orders_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "ShoppingCartItems",
                columns: table => new
                {
                    Id = table.Column<int>(type: "int", nullable: false)
                        .Annotation("SqlServer:Identity", "1, 1"),
                    UserId = table.Column<string>(type: "nvarchar(450)", nullable: false),
                    ProductId = table.Column<string>(type: "nvarchar(24)", maxLength: 24, nullable: false),
                    Quantity = table.Column<int>(type: "int", nullable: false),
                    CreatedAt = table.Column<DateTime>(type: "datetime2", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_ShoppingCartItems", x => x.Id);
                    table.ForeignKey(
                        name: "FK_ShoppingCartItems_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "OrderItems",
                columns: table => new
                {
                    Id = table.Column<int>(type: "int", nullable: false)
                        .Annotation("SqlServer:Identity", "1, 1"),
                    OrderId = table.Column<int>(type: "int", nullable: false),
                    ProductId = table.Column<string>(type: "nvarchar(24)", maxLength: 24, nullable: false),
                    ProductName = table.Column<string>(type: "nvarchar(max)", nullable: false),
                    ProductPrice = table.Column<decimal>(type: "decimal(18,2)", precision: 18, scale: 2, nullable: false),
                    Quantity = table.Column<int>(type: "int", nullable: false),
                    TotalPrice = table.Column<decimal>(type: "decimal(18,2)", precision: 18, scale: 2, nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_OrderItems", x => x.Id);
                    table.ForeignKey(
                        name: "FK_OrderItems_Orders_OrderId",
                        column: x => x.OrderId,
                        principalTable: "Orders",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateIndex(
                name: "IX_AspNetRoleClaims_RoleId",
                table: "AspNetRoleClaims",
                column: "RoleId");

            migrationBuilder.CreateIndex(
                name: "RoleNameIndex",
                table: "AspNetRoles",
                column: "NormalizedName",
                unique: true,
                filter: "[NormalizedName] IS NOT NULL");

            migrationBuilder.CreateIndex(
                name: "IX_AspNetUserClaims_UserId",
                table: "AspNetUserClaims",
                column: "UserId");

            migrationBuilder.CreateIndex(
                name: "IX_AspNetUserLogins_UserId",
                table: "AspNetUserLogins",
                column: "UserId");

            migrationBuilder.CreateIndex(
                name: "IX_AspNetUserRoles_RoleId",
                table: "AspNetUserRoles",
                column: "RoleId");

            migrationBuilder.CreateIndex(
                name: "EmailIndex",
                table: "AspNetUsers",
                column: "NormalizedEmail");

            migrationBuilder.CreateIndex(
                name: "UserNameIndex",
                table: "AspNetUsers",
                column: "NormalizedUserName",
                unique: true,
                filter: "[NormalizedUserName] IS NOT NULL");

            migrationBuilder.CreateIndex(
                name: "IX_OrderItems_OrderId",
                table: "OrderItems",
                column: "OrderId");

            migrationBuilder.CreateIndex(
                name: "IX_Orders_UserId",
                table: "Orders",
                column: "UserId");

            migrationBuilder.CreateIndex(
                name: "IX_ShoppingCartItems_UserId",
                table: "ShoppingCartItems",
                column: "UserId");
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropTable(
                name: "AspNetRoleClaims");

            migrationBuilder.DropTable(
                name: "AspNetUserClaims");

            migrationBuilder.DropTable(
                name: "AspNetUserLogins");

            migrationBuilder.DropTable(
                name: "AspNetUserRoles");

            migrationBuilder.DropTable(
                name: "AspNetUserTokens");

            migrationBuilder.DropTable(
                name: "OrderItems");

            migrationBuilder.DropTable(
                name: "ShoppingCartItems");

            migrationBuilder.DropTable(
                name: "AspNetRoles");

            migrationBuilder.DropTable(
                name: "Orders");

            migrationBuilder.DropTable(
                name: "AspNetUsers");
        }
    }
}

================
File: AutoPile.DATA/Migrations/20241227180443_InitialCreate.Designer.cs
================
// <auto-generated />
using System;
using AutoPile.DATA.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

#nullable disable

namespace AutoPile.DATA.Migrations
{
    [DbContext(typeof(AutoPileManagementDbContext))]
    [Migration("20241227180443_InitialCreate")]
    partial class InitialCreate
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.10")
                .HasAnnotation("Relational:MaxIdentifierLength", 128);

            SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationRole", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex")
                        .HasFilter("[NormalizedName] IS NOT NULL");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("int");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("EmailVerifyToken")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("FirstName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("LastName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("bit");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("datetimeoffset");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("bit");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex")
                        .HasFilter("[NormalizedUserName] IS NOT NULL");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<decimal>("DeliveryFee")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<DateTime>("OrderDate")
                        .HasColumnType("datetime2");

                    b.Property<string>("OrderNumber")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PaymentMethod")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PaymentStatus")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_City")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Country")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line1")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line2")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_PostalCode")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_State")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("StripeSessionId")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("SubTotal")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<decimal>("TotalAmount")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("Orders");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<int>("OrderId")
                        .HasColumnType("int");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<string>("ProductName")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("ProductPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<decimal>("TotalPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.HasIndex("OrderId");

                    b.ToTable("OrderItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("ShoppingCartItems");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("RoleId")
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Name")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Value")
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("Orders")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.Order", "Order")
                        .WithMany("OrderItems")
                        .HasForeignKey("OrderId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Order");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("ShoppingCartItems")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Navigation("Orders");

                    b.Navigation("ShoppingCartItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Navigation("OrderItems");
                });
#pragma warning restore 612, 618
        }
    }
}

================
File: AutoPile.DATA/Migrations/20241229055646_AddEmailVerifyTokenCreatedAt.cs
================
using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace AutoPile.DATA.Migrations
{
    /// <inheritdoc />
    public partial class AddEmailVerifyTokenCreatedAt : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.AddColumn<DateTime>(
                name: "EmailVerifyTokenCreatedAt",
                table: "AspNetUsers",
                type: "datetime2",
                nullable: true);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropColumn(
                name: "EmailVerifyTokenCreatedAt",
                table: "AspNetUsers");
        }
    }
}

================
File: AutoPile.DATA/Migrations/20241229055646_AddEmailVerifyTokenCreatedAt.Designer.cs
================
// <auto-generated />
using System;
using AutoPile.DATA.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

#nullable disable

namespace AutoPile.DATA.Migrations
{
    [DbContext(typeof(AutoPileManagementDbContext))]
    [Migration("20241229055646_AddEmailVerifyTokenCreatedAt")]
    partial class AddEmailVerifyTokenCreatedAt
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.10")
                .HasAnnotation("Relational:MaxIdentifierLength", 128);

            SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationRole", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex")
                        .HasFilter("[NormalizedName] IS NOT NULL");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("int");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("EmailVerifyToken")
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime?>("EmailVerifyTokenCreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("FirstName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("LastName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("bit");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("datetimeoffset");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("bit");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex")
                        .HasFilter("[NormalizedUserName] IS NOT NULL");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<decimal>("DeliveryFee")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<DateTime>("OrderDate")
                        .HasColumnType("datetime2");

                    b.Property<string>("OrderNumber")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PaymentMethod")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PaymentStatus")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_City")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Country")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line1")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line2")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_PostalCode")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_State")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("StripeSessionId")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("SubTotal")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<decimal>("TotalAmount")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("Orders");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<int>("OrderId")
                        .HasColumnType("int");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<string>("ProductName")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("ProductPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<decimal>("TotalPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.HasIndex("OrderId");

                    b.ToTable("OrderItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("ShoppingCartItems");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("RoleId")
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Name")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Value")
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("Orders")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.Order", "Order")
                        .WithMany("OrderItems")
                        .HasForeignKey("OrderId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Order");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("ShoppingCartItems")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Navigation("Orders");

                    b.Navigation("ShoppingCartItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Navigation("OrderItems");
                });
#pragma warning restore 612, 618
        }
    }
}

================
File: AutoPile.DATA/Migrations/20250107151641_change.cs
================
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace AutoPile.DATA.Migrations
{
    /// <inheritdoc />
    public partial class change : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.AlterColumn<string>(
                name: "StripeSessionId",
                table: "Orders",
                type: "nvarchar(max)",
                nullable: true,
                oldClrType: typeof(string),
                oldType: "nvarchar(max)");

            migrationBuilder.AlterColumn<int>(
                name: "Status",
                table: "Orders",
                type: "int",
                nullable: false,
                oldClrType: typeof(string),
                oldType: "nvarchar(max)");

            migrationBuilder.AlterColumn<int>(
                name: "PaymentStatus",
                table: "Orders",
                type: "int",
                nullable: false,
                oldClrType: typeof(string),
                oldType: "nvarchar(max)");
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.AlterColumn<string>(
                name: "StripeSessionId",
                table: "Orders",
                type: "nvarchar(max)",
                nullable: false,
                defaultValue: "",
                oldClrType: typeof(string),
                oldType: "nvarchar(max)",
                oldNullable: true);

            migrationBuilder.AlterColumn<string>(
                name: "Status",
                table: "Orders",
                type: "nvarchar(max)",
                nullable: false,
                oldClrType: typeof(int),
                oldType: "int");

            migrationBuilder.AlterColumn<string>(
                name: "PaymentStatus",
                table: "Orders",
                type: "nvarchar(max)",
                nullable: false,
                oldClrType: typeof(int),
                oldType: "int");
        }
    }
}

================
File: AutoPile.DATA/Migrations/20250107151641_change.Designer.cs
================
// <auto-generated />
using System;
using AutoPile.DATA.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

#nullable disable

namespace AutoPile.DATA.Migrations
{
    [DbContext(typeof(AutoPileManagementDbContext))]
    [Migration("20250107151641_change")]
    partial class change
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.10")
                .HasAnnotation("Relational:MaxIdentifierLength", 128);

            SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationRole", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex")
                        .HasFilter("[NormalizedName] IS NOT NULL");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("int");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("EmailVerifyToken")
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime?>("EmailVerifyTokenCreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("FirstName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("LastName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("bit");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("datetimeoffset");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("bit");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex")
                        .HasFilter("[NormalizedUserName] IS NOT NULL");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<decimal>("DeliveryFee")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<DateTime>("OrderDate")
                        .HasColumnType("datetime2");

                    b.Property<string>("OrderNumber")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PaymentMethod")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("PaymentStatus")
                        .HasColumnType("int");

                    b.Property<string>("ShippingAddress_City")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Country")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line1")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line2")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_PostalCode")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_State")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("Status")
                        .HasColumnType("int");

                    b.Property<string>("StripeSessionId")
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("SubTotal")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<decimal>("TotalAmount")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("Orders");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<int>("OrderId")
                        .HasColumnType("int");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<string>("ProductName")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("ProductPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<decimal>("TotalPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.HasIndex("OrderId");

                    b.ToTable("OrderItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("ShoppingCartItems");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("RoleId")
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Name")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Value")
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("Orders")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.Order", "Order")
                        .WithMany("OrderItems")
                        .HasForeignKey("OrderId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Order");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("ShoppingCartItems")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Navigation("Orders");

                    b.Navigation("ShoppingCartItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Navigation("OrderItems");
                });
#pragma warning restore 612, 618
        }
    }
}

================
File: AutoPile.DATA/Migrations/20250122173340_initialCreate2.cs
================
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace AutoPile.DATA.Migrations
{
    /// <inheritdoc />
    public partial class initialCreate2 : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {

        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {

        }
    }
}

================
File: AutoPile.DATA/Migrations/20250122173340_initialCreate2.Designer.cs
================
// <auto-generated />
using System;
using AutoPile.DATA.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

#nullable disable

namespace AutoPile.DATA.Migrations
{
    [DbContext(typeof(AutoPileManagementDbContext))]
    [Migration("20250122173340_initialCreate2")]
    partial class initialCreate2
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.10")
                .HasAnnotation("Relational:MaxIdentifierLength", 128);

            SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationRole", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex")
                        .HasFilter("[NormalizedName] IS NOT NULL");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("int");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("EmailVerifyToken")
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime?>("EmailVerifyTokenCreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("FirstName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("LastName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("bit");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("datetimeoffset");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("bit");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex")
                        .HasFilter("[NormalizedUserName] IS NOT NULL");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<decimal>("DeliveryFee")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<DateTime>("OrderDate")
                        .HasColumnType("datetime2");

                    b.Property<string>("OrderNumber")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PaymentMethod")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("PaymentStatus")
                        .HasColumnType("int");

                    b.Property<string>("ShippingAddress_City")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Country")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line1")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line2")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_PostalCode")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_State")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("Status")
                        .HasColumnType("int");

                    b.Property<string>("StripeSessionId")
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("SubTotal")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<decimal>("TotalAmount")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("Orders");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<int>("OrderId")
                        .HasColumnType("int");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<string>("ProductName")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("ProductPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<decimal>("TotalPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.HasIndex("OrderId");

                    b.ToTable("OrderItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("ShoppingCartItems");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("RoleId")
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Name")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Value")
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("Orders")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.Order", "Order")
                        .WithMany("OrderItems")
                        .HasForeignKey("OrderId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Order");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("ShoppingCartItems")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Navigation("Orders");

                    b.Navigation("ShoppingCartItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Navigation("OrderItems");
                });
#pragma warning restore 612, 618
        }
    }
}

================
File: AutoPile.DATA/Migrations/20250207175947_refreshTokenCreate.cs
================
using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace AutoPile.DATA.Migrations
{
    /// <inheritdoc />
    public partial class refreshTokenCreate : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.AddColumn<string>(
                name: "RefreshToken",
                table: "AspNetUsers",
                type: "nvarchar(max)",
                nullable: true);

            migrationBuilder.AddColumn<DateTime>(
                name: "RefreshTokenExpiryTime",
                table: "AspNetUsers",
                type: "datetime2",
                nullable: true);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropColumn(
                name: "RefreshToken",
                table: "AspNetUsers");

            migrationBuilder.DropColumn(
                name: "RefreshTokenExpiryTime",
                table: "AspNetUsers");
        }
    }
}

================
File: AutoPile.DATA/Migrations/20250207175947_refreshTokenCreate.Designer.cs
================
// <auto-generated />
using System;
using AutoPile.DATA.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

#nullable disable

namespace AutoPile.DATA.Migrations
{
    [DbContext(typeof(AutoPileManagementDbContext))]
    [Migration("20250207175947_refreshTokenCreate")]
    partial class refreshTokenCreate
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.10")
                .HasAnnotation("Relational:MaxIdentifierLength", 128);

            SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationRole", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex")
                        .HasFilter("[NormalizedName] IS NOT NULL");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("int");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("EmailVerifyToken")
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime?>("EmailVerifyTokenCreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("FirstName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("LastName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("bit");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("datetimeoffset");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("RefreshToken")
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime?>("RefreshTokenExpiryTime")
                        .HasColumnType("datetime2");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("bit");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex")
                        .HasFilter("[NormalizedUserName] IS NOT NULL");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<decimal>("DeliveryFee")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<DateTime>("OrderDate")
                        .HasColumnType("datetime2");

                    b.Property<string>("OrderNumber")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PaymentMethod")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("PaymentStatus")
                        .HasColumnType("int");

                    b.Property<string>("ShippingAddress_City")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Country")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line1")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line2")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_PostalCode")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_State")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("Status")
                        .HasColumnType("int");

                    b.Property<string>("StripeSessionId")
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("SubTotal")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<decimal>("TotalAmount")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("Orders");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<int>("OrderId")
                        .HasColumnType("int");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<string>("ProductName")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("ProductPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<decimal>("TotalPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.HasIndex("OrderId");

                    b.ToTable("OrderItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("ShoppingCartItems");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("RoleId")
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Name")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Value")
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("Orders")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.Order", "Order")
                        .WithMany("OrderItems")
                        .HasForeignKey("OrderId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Order");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("ShoppingCartItems")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Navigation("Orders");

                    b.Navigation("ShoppingCartItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Navigation("OrderItems");
                });
#pragma warning restore 612, 618
        }
    }
}

================
File: AutoPile.DATA/Migrations/AutoPileManagementDbContextModelSnapshot.cs
================
// <auto-generated />
using System;
using AutoPile.DATA.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

#nullable disable

namespace AutoPile.DATA.Migrations
{
    [DbContext(typeof(AutoPileManagementDbContext))]
    partial class AutoPileManagementDbContextModelSnapshot : ModelSnapshot
    {
        protected override void BuildModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.10")
                .HasAnnotation("Relational:MaxIdentifierLength", 128);

            SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationRole", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex")
                        .HasFilter("[NormalizedName] IS NOT NULL");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("int");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("EmailVerifyToken")
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime?>("EmailVerifyTokenCreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("FirstName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("LastName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("bit");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("datetimeoffset");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("RefreshToken")
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime?>("RefreshTokenExpiryTime")
                        .HasColumnType("datetime2");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("bit");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex")
                        .HasFilter("[NormalizedUserName] IS NOT NULL");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<decimal>("DeliveryFee")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<DateTime>("OrderDate")
                        .HasColumnType("datetime2");

                    b.Property<string>("OrderNumber")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PaymentMethod")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("PaymentStatus")
                        .HasColumnType("int");

                    b.Property<string>("ShippingAddress_City")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Country")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line1")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_Line2")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_PostalCode")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ShippingAddress_State")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("Status")
                        .HasColumnType("int");

                    b.Property<string>("StripeSessionId")
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("SubTotal")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<decimal>("TotalAmount")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("Orders");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<int>("OrderId")
                        .HasColumnType("int");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<string>("ProductName")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("ProductPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<decimal>("TotalPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.HasIndex("OrderId");

                    b.ToTable("OrderItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("ProductId")
                        .IsRequired()
                        .HasMaxLength(24)
                        .HasColumnType("nvarchar(24)");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("ShoppingCartItems");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("RoleId")
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Name")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Value")
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("Orders")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.OrderItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.Order", "Order")
                        .WithMany("OrderItems")
                        .HasForeignKey("OrderId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Order");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ShoppingCartItem", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", "User")
                        .WithMany("ShoppingCartItems")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("AutoPile.DOMAIN.Models.Entities.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.ApplicationUser", b =>
                {
                    b.Navigation("Orders");

                    b.Navigation("ShoppingCartItems");
                });

            modelBuilder.Entity("AutoPile.DOMAIN.Models.Entities.Order", b =>
                {
                    b.Navigation("OrderItems");
                });
#pragma warning restore 612, 618
        }
    }
}

================
File: AutoPile.DOMAIN/AutoPile.DOMAIN.csproj
================
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="8.0.10" />
    <PackageReference Include="Microsoft.AspNetCore.Http.Abstractions" Version="2.2.0" />
    <PackageReference Include="Microsoft.AspNetCore.Http.Features" Version="5.0.17" />
    <PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="8.0.10" />
    <PackageReference Include="Microsoft.EntityFrameworkCore" Version="8.0.10" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.10">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="MongoDB.EntityFrameworkCore" Version="8.2.1" />
    <PackageReference Include="Stripe.net" Version="47.2.0" />
  </ItemGroup>

</Project>

================
File: AutoPile.DOMAIN/DTOs/Requests/OrderCreateDTO.cs
================
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models.Entities;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class OrderCreateDTO
    {
        public string PaymentMethod { get; set; }
        public string ShippingAddress_Line1 { get; set; }
        public string ShippingAddress_Line2 { get; set; }
        public string ShippingAddress_City { get; set; }
        public string ShippingAddress_Country { get; set; }
        public string ShippingAddress_State { get; set; }
        public string ShippingAddress_PostalCode { get; set; }

        public decimal DeliveryFee { get; set; }
        public ICollection<OrderItemCreateDTO> OrderItems { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/OrderItemCreateDTO.cs
================
using AutoPile.DOMAIN.Models.Entities;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class OrderItemCreateDTO
    {
        //public int OrderId { get; set; }
        public string ProductId { get; set; }

        public int Quantity { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/OrderItemUpdateDTO.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class OrderItemUpdateDTO
    {
        public int Quantity { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/OrderUpdateDTO.cs
================
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Enum;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class OrderUpdateDTO
    {
        public OrderStatus? Status { get; set; }
        public string? PaymentMethod { get; set; }
        public string? ShippingAddress_Line1 { get; set; }
        public string? ShippingAddress_Line2 { get; set; }
        public string? ShippingAddress_City { get; set; }
        public string? ShippingAddress_Country { get; set; }
        public string? ShippingAddress_State { get; set; }
        public string? ShippingAddress_PostalCode { get; set; }
        public ICollection<OrderItemCreateDTO>? OrderItems { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/PaymentIntentCreate.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class PaymentIntentCreate
    {
        public Item[] Items { get; set; }
    }

    public class Item
    {
        public string ProductId { get; set; }
        public int Quantity { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/ProductCreateDTO.cs
================
using AutoPile.DOMAIN.Enum;
using AutoPile.DOMAIN.Models.Entities;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class ProductCreateDTO
    {
        public string Name { get; set; }
        public string Description { get; set; }
        public string ProductInfo { get; set; }
        public string SKU { get; set; }
        public decimal Price { get; set; }
        public decimal? ComparePrice { get; set; }
        public bool IsInStock { get; set; }
        public int StockQuantity { get; set; }
        public Ribbon Ribbon { get; set; }
        public Category Category { get; set; }

        public List<ProductMediaCreateDTO> ProductMedias { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/ProductMediaCreateDTO.cs
================
using AutoPile.DOMAIN.Models.Entities;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class ProductMediaCreateDTO
    {
        public string Url { get; set; }
        public string FullUrl { get; set; }
        public string MediaType { get; set; }
        public string AltText { get; set; }
        public string Title { get; set; }
        public int Width { get; set; }
        public int Height { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/ProductMediaUpdateDTO.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class ProductMediaUpdateDto
    {
        public string Url { get; set; }
        public string FullUrl { get; set; }
        public string MediaType { get; set; }
        public string AltText { get; set; }
        public string Title { get; set; }
        public int Width { get; set; }
        public int Height { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/ProductUpdateDTO.cs
================
using AutoPile.DOMAIN.Enum;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class ProductUpdateDTO
    {
        public string? Name { get; set; }
        public string? Description { get; set; }
        public string? ProductInfo { get; set; }
        public string? SKU { get; set; }
        public decimal? Price { get; set; }
        public decimal? ComparePrice { get; set; }
        public bool? IsInStock { get; set; }
        public int? StockQuantity { get; set; }
        public Ribbon? Ribbon { get; set; }
        public Category? Category { get; set; }

        public List<ProductMediaCreateDTO>? ProductMedias { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/ReviewCreateDTO.cs
================
using Microsoft.AspNetCore.Http;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class ReviewCreateDTO
    {
        public string ProductId { get; set; }
        public string Title { get; set; }
        public string Subtitle { get; set; }
        public string Content { get; set; }
        public int Rating { get; set; }
        public IFormFile? Image { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/ReviewUpdateDTO.cs
================
using Microsoft.AspNetCore.Http;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class ReviewUpdateDTO
    {
        public string? Title { get; set; }
        public string? Subtitle { get; set; }
        public string? Content { get; set; }
        public int? Rating { get; set; }
        public IFormFile? Image { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/ShoppingCartItemRequestDTO.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class ShoppingCartItemRequestDto
    {
        public string ProductId { get; set; }
        public int Quantity { get; set; }
    }

    public class UpdateShoppingCartItemDto
    {
        public int Quantity { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/TokenRefreshRequest.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class TokenRefreshRequest
    {
        public string RefreshToken { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/UserResetPasswordDTO.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class UserResetPasswordDTO
    {
        public string Email { get; set; }
        public string NewPassword { get; set; }
        public string EmailVerifyToken { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/UserSigninDTO.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class UserSigninDTO
    {
        public string Email { get; set; }
        public string Password { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/UserSignupDTO.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class UserSignupDTO
    {
        public string FirstName { get; set; }
        public string LastName { get; set; }
        public string UserName { get; set; }
        public string? PhoneNumber { get; set; }
        public string Email { get; set; }
        public string Password { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/UserUpdateInfoDTO.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class UserUpdateInfoDTO
    {
        public string FirstName { get; set; }
        public string LastName { get; set; }
        public string PhoneNumber { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Requests/ValidateTokenRequest.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Requests
{
    public class ValidateTokenRequest
    {
        public string Email { get; set; }
        public string Token { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Responses/OrderItemResponseDTO.cs
================
using AutoPile.DOMAIN.Models.Entities;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Responses
{
    public class OrderItemResponseDTO
    {
        public int Id { get; set; }
        public int OrderId { get; set; }
        public string ProductId { get; set; }
        public string ProductName { get; set; }
        public decimal ProductPrice { get; set; }
        public int Quantity { get; set; }
        public decimal TotalPrice { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Responses/OrderResponseDTO.cs
================
using AutoPile.DOMAIN.Enum;
using AutoPile.DOMAIN.Models.Entities;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Responses
{
    public class OrderResponseDTO
    {
        public int Id { get; set; }
        public string UserId { get; set; }
        public string OrderNumber { get; set; }
        public DateTime OrderDate { get; set; }
        public OrderStatus Status { get; set; }
        public decimal SubTotal { get; set; }
        public decimal DeliveryFee { get; set; }
        public decimal TotalAmount { get; set; }
        public string PaymentStatus { get; set; }
        public string PaymentMethod { get; set; }
        public string StripeSessionId { get; set; }
        public string ShippingAddress_Line1 { get; set; }
        public string ShippingAddress_Line2 { get; set; }
        public string ShippingAddress_City { get; set; }
        public string ShippingAddress_Country { get; set; }
        public string ShippingAddress_State { get; set; }
        public string ShippingAddress_PostalCode { get; set; }
        public ICollection<OrderItemResponseDTO> OrderItems { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Responses/ProductMediaResponseDTO.cs
================
using AutoPile.DOMAIN.Models.Entities;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Responses
{
    public class ProductMediaResponseDTO
    {
        public string Url { get; set; }
        public string FullUrl { get; set; }
        public string MediaType { get; set; }
        public string AltText { get; set; }
        public string Title { get; set; }
        public int Width { get; set; }
        public int Height { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Responses/ProductResponseDTO.cs
================
using AutoPile.DOMAIN.Enum;
using AutoPile.DOMAIN.Models.Entities;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Responses
{
    public class ProductResponseDTO
    {
        public string Id { get; set; }
        public string Name { get; set; }
        public string productDescription { get; set; }
        public string ProductInfo { get; set; }
        public string SKU { get; set; }
        public decimal Price { get; set; }
        public decimal ComparePrice { get; set; }
        public bool IsInStock { get; set; }
        public int StockQuantity { get; set; }
        public Ribbon Ribbon { get; set; }
        public DateTime CreatedAt { get; set; }

        public DateTime UpdatedAt { get; set; }
        public Category Category { get; set; }
        public List<ProductMediaResponseDTO> ProductMedias { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Responses/ReviewImageDTO.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Responses
{
    public class ReviewImageDTO
    {
        public byte[] Image { get; init; }
        public string ImageContentType { get; init; }

        public string Base64Image => Image != null && ImageContentType != null
            ? $"data:{ImageContentType};base64,{Convert.ToBase64String(Image)}"
            : null;
    }
}

================
File: AutoPile.DOMAIN/DTOs/Responses/ReviewResponseDTO.cs
================
using AutoPile.DOMAIN.Models.Entities;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Responses
{
    public class ReviewResponseDTO
    {
        public string Id { get; set; }
        public string ProductId { get; set; }
        public string Title { get; set; }
        public string Subtitle { get; set; }
        public string Content { get; set; }
        public int Rating { get; set; }
        public string ImageUrl { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime UpdatedAt { get; set; }

        public string UserId { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Responses/ShoppingCartItemResponseDTO.cs
================
using AutoPile.DOMAIN.Models.Entities;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Responses
{
    public class ShoppingCartItemResponseDTO
    {
        public int Id { get; set; }
        public string UserId { get; set; }
        public string ProductId { get; set; }
        public int Quantity { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Responses/TokenRefreshResponse .cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Responses
{
    public class TokenRefreshResponse
    {
        public string AccessToken { get; set; }
        public string RefreshToken { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Responses/UserInfoResponseDTO.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Responses
{
    public class UserInfoResponseDTO
    {
        public UserInfoResponseDTO()
        {
            Roles = new List<string>();
        }

        public string LastName { get; set; }
        public string FirstName { get; set; }
        public string PhoneNumber { get; set; }
        public string Email { get; set; }
        public IList<string> Roles { get; set; }
        public bool EmailConfirmed { get; set; }
    }
}

================
File: AutoPile.DOMAIN/DTOs/Responses/UserResponseDTO.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.DTOs.Responses
{
    public class UserResponseDTO
    {
        public UserResponseDTO()
        {
            Roles = new List<string>();
        }

        public string UserName { get; set; }
        public string Email { get; set; }

        public string Id { get; set; }
        public IList<string> Roles { get; set; }
        public bool EmailConfirmed { get; set; }
    }
}

================
File: AutoPile.DOMAIN/Enum/Category.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Enum
{
    public enum Category
    {
        Accessories,
        VehicleBodyParts,
        WheelsAndRims,
        Engine
    }
}

================
File: AutoPile.DOMAIN/Enum/OrderStatus.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Enum
{
    public enum OrderStatus
    {
        Pending = 1, Success = 2
    }
}

================
File: AutoPile.DOMAIN/Enum/PaymentStatus.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Enum
{
    public enum PaymentStatus
    {
        Pending, Completed, Declined, Refunded, Cancelled
    }
}

================
File: AutoPile.DOMAIN/Enum/Ribbon.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Enum
{
    public enum Ribbon
    {
        Sale, BestSeller, None
    }
}

================
File: AutoPile.DOMAIN/Interface/IAuthService.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.AspNetCore.Mvc;

namespace AutoPile.SERVICE.Services
{
    public interface IAuthService
    {
        Task<(UserResponseDTO, string, string)> SignupAdminAsync(UserSignupDTO userSignupDTO);

        Task<(UserResponseDTO, string, string)> SignupUserAsync([FromBody] UserSignupDTO userSignupDTO);

        Task<(UserResponseDTO, string, string)> SigninAsync(UserSigninDTO userSigninDTO);

        Task<UserInfoResponseDTO> GetUserInfoAsync(string userId);

        Task<string> SendEmailConfirmationTokenAsync(string email, string userId);

        Task<bool> VerifyEmailConfirmationTokenAsync(string email, string token);

        Task UpdateUserInfoAsync(UserUpdateInfoDTO userUpdateInfoDTO, string userId);

        Task<string> SendResetPasswordTokenAsync(string email);

        Task ResetPasswordAsync(UserResetPasswordDTO userResetPasswordDTO);

        Task ValidatePasswordResetTokenAsync(string email, string token);

        Task RevokeRefreshTokenAsync(string userId);

        Task<TokenRefreshResponse> RefreshTokenAsync(string refreshToken);

        Task UpdateUserRefreshTokenAsync(ApplicationUser user, string refreshToken);
    }
}

================
File: AutoPile.DOMAIN/Interface/IBlobService.cs
================
using Microsoft.AspNetCore.Http;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Interface
{
    public interface IBlobService
    {
        Task<string> UploadImageAsync(IFormFile file);

        Task DeleteImageAsync(string imageUrl);

        Task<string> UpdateImageAsync(string oldImageUrl, IFormFile newFile);
    }
}

================
File: AutoPile.DOMAIN/Interface/IEmailQueueService.cs
================
using AutoPile.DOMAIN.Models.MessageQueue;

namespace AutoPile.SERVICE.Services
{
    public interface IEmailQueueService
    {
        Task QueueEmailMessage(EmailMessage message);
    }
}

================
File: AutoPile.DOMAIN/Interface/IExceptionHandler.cs
================
using Microsoft.AspNetCore.Http;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Interface
{
    public interface IExceptionHandler
    {
        public Task HandleExceptionAsync(HttpContext context);
    }
}

================
File: AutoPile.DOMAIN/Interface/IInventoryQueueService.cs
================
using AutoPile.DOMAIN.Models.Entities;

namespace AutoPile.SERVICE.Services
{
    public interface IInventoryQueueService
    {
        Task QueueOrderItemMessage(ICollection<OrderItem> orderItems);
    }
}

================
File: AutoPile.DOMAIN/Interface/IJwtTokenGenerator.cs
================
using AutoPile.DOMAIN.Models.Entities;

namespace AutoPile.SERVICE.Utilities
{
    public interface IJwtTokenGenerator
    {
        string GenerateJwtToken(ApplicationUser user);
    }
}

================
File: AutoPile.DOMAIN/Interface/IOrderCache.cs
================
using AutoPile.DOMAIN.DTOs.Responses;

namespace AutoPile.DATA.Cache
{
    public interface IOrderCache
    {
        Task DeleteOrderAsync(string applicationUserId);
        Task<IEnumerable<OrderResponseDTO>?> GetOrderAsync(string applicationUserId);
        Task SetOrderAsync(string applicationUserId, IEnumerable<OrderResponseDTO> orderResponseDTOs);
        Task UpdateOrderAsync(OrderResponseDTO orderResponseDTO);
    }
}

================
File: AutoPile.DOMAIN/Interface/IOrderItemService.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;

namespace AutoPile.SERVICE.Services
{
    public interface IOrderItemService
    {
        Task<OrderItemResponseDTO> CreateOrderItemAsync(OrderItemCreateDTO orderItemCreateDTO);
        Task DeleteOrderItem(string id);
        Task<OrderItemResponseDTO> GetOrderItemById(string id);
        Task<OrderItemResponseDTO> UpdateOrderItem(OrderItemUpdateDTO orderItemUpdateDTO, string id);
    }
}

================
File: AutoPile.DOMAIN/Interface/IOrderService.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;

public interface IOrderService
{
    Task<OrderResponseDTO> CreateOrderAsync(OrderCreateDTO orderCreateDTO, string applicationUserId);

    Task<OrderResponseDTO> GetOrderByIdAsync(int orderId, string applicationUserId);

    Task<IEnumerable<OrderResponseDTO>> GetUserOrdersAsync(string applicationUserId);

    Task<OrderResponseDTO> UpdateOrderAsync(OrderUpdateDTO orderUpdateDTO, int orderId, string userId);

    Task DeleteOrderAsync(int orderId, string userId);

    Task<OrderResponseDTO> GetOrderByOrderIdAsync(string orderId, string applicationUserId);

    Task CompleteOrderAsync(string applicationUserId, int orderId);
}

================
File: AutoPile.DOMAIN/Interface/IPaymentService.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using Stripe;

namespace AutoPile.SERVICE.Services
{
    public interface IPaymentService
    {
        Task<PaymentIntent> PaymentIntentCreateAsync(PaymentIntentCreate paymentIntentCreate);
    }
}

================
File: AutoPile.DOMAIN/Interface/IProductCache.cs
================
using AutoPile.DOMAIN.DTOs.Responses;

namespace AutoPile.DATA.Cache
{
    public interface IProductCache
    {
        Task DeleteProductAsync(string productId);
        Task<ProductResponseDTO?> GetProductAsync(string productId);
        Task SetProductAsync(string productId, ProductResponseDTO productResponseDTO);
    }
}

================
File: AutoPile.DOMAIN/Interface/IProductService.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;

namespace AutoPile.SERVICE.Services
{
    public interface IProductService
    {
        Task<ProductResponseDTO> CreateProductAsync(ProductCreateDTO productCreateDTO);

        Task<ProductResponseDTO> GetProductByIdAsync(string id);

        Task DeleteProductByIdAsync(string id);

        Task<ProductResponseDTO> UpdateProductByIdAsync(ProductUpdateDTO productUpdateDTO, string id);

        Task<IEnumerable<ProductResponseDTO>> GetProductsListAsync();
    }
}

================
File: AutoPile.DOMAIN/Interface/IRedisCache.cs
================
using Microsoft.Extensions.Caching.Distributed;

namespace AutoPile.DATA.Cache
{
    public interface IRedisCache<T> where T : class
    {
        Task<T?> GetAsync(string key);

        Task RemoveAsync(string key);

        Task SetAsync(string key, T item, DistributedCacheEntryOptions cacheOptions);

        Task SetAsyncToList(string key, IEnumerable<T> item, DistributedCacheEntryOptions cacheOptions);

        Task<IEnumerable<T>?> GetAsyncToList(string key);

        Task RemoveAsyncToList(string key);
    }
}

================
File: AutoPile.DOMAIN/Interface/IRedisShoppingCartCache.cs
================
using AutoPile.DOMAIN.Models.Entities;

namespace AutoPile.DATA.Cache
{
    public interface IRedisShoppingCartCache
    {
        Task ClearCartAsync(string userId);
        Task<ShoppingCartItem?> GetItemAsync(string userId, int itemId);
        Task<List<ShoppingCartItem>> GetUserCartAsync(string userId);
        Task RemoveItemAsync(string userId, int itemId);
        Task SetItemAsync(ShoppingCartItem shoppingCartItem);
    }
}

================
File: AutoPile.DOMAIN/Interface/IReviewsCache.cs
================
using AutoPile.DOMAIN.DTOs.Responses;

namespace AutoPile.DATA.Cache
{
    public interface IReviewsCache
    {
        Task DeleteReviewAsync(string productId, string reviewId);

        Task<IEnumerable<ReviewResponseDTO>?> GetReviewAsync(string productId);

        Task SetReviewAsync(string productId, IEnumerable<ReviewResponseDTO> reviewResponseDTO);

        Task UpdateReviewAsync(ReviewResponseDTO reviewResponseDTO);
    }
}

================
File: AutoPile.DOMAIN/Interface/IReviewService.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using MongoDB.Bson;

namespace AutoPile.SERVICE.Services
{
    public interface IReviewService
    {
        Task<ReviewResponseDTO> CreateReviewAsync(ReviewCreateDTO reviewCreateDTO, string applicationUserId);

        Task<ReviewResponseDTO> GetReviewByIdAsync(string ReviewId);

        Task<IEnumerable<ReviewResponseDTO>> GetReviewsByProductIdAsync(string ProductId);

        Task<ReviewResponseDTO> UpdateReviewAsync(ReviewUpdateDTO reviewUpdateDTO, string reviewId, string applicationUserId);

        Task DeleteReviewAsync(string reviewId, string applicationUserId);
    }
}

================
File: AutoPile.DOMAIN/Interface/IShoppingCartItemService.cs
================
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;

namespace AutoPile.SERVICE.Services
{
    public interface IShoppingCartItemService
    {
        Task<ShoppingCartItemResponseDTO> CreateShoppingCartItemAsync(ShoppingCartItemRequestDto shoppingCartItemRequest, string applicationUserId);

        Task DeleteShoppingCartItemAsync(int shoppingCartItemId, string applicationUserId);

        Task<ShoppingCartItemResponseDTO> GetShoppingCartItemById(int shoppingCartItemId, string applicationUserId);

        Task UpdateShoppingCartItemAsync(UpdateShoppingCartItemDto updateShoppingCartItemDto, int shoppingCartItemId, string? applicationUserId);

        Task DeleteAllShoppingCartItemsAsync(string applicationUserId);

        Task<IEnumerable<ShoppingCartItemResponseDTO>> GetShoppingCartItemByUserId(string applicationUserId);
    }
}

================
File: AutoPile.DOMAIN/Interface/IStripeService.cs
================
using Stripe;

namespace AutoPile.SERVICE.Services
{
    public interface IStripeService
    {
        Task<PaymentIntent> CreatePaymentIntentAsync(long amount, string currency);
    }
}

================
File: AutoPile.DOMAIN/Interface/IUserInfoCache.cs
================
using AutoPile.DOMAIN.DTOs.Responses;

namespace AutoPile.DATA.Cache
{
    public interface IUserInfoCache
    {
        Task SetUserAsync(string applicationUserId, UserInfoResponseDTO userInfoResponseDTO);

        Task<UserInfoResponseDTO?> GetUserAsync(string applicationUserId);
    }
}

================
File: AutoPile.DOMAIN/Models/ApiResponse.cs
================
using Microsoft.AspNetCore.Mvc;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.Json.Serialization;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Models
{
    public static class ApiResponse
    {
        public static IActionResult OkResult(string message = "OK")
        {
            var response = new ApiResponse<object>
            {
                Code = 200,
                Message = message,
                Success = true,
            };
            return new OkObjectResult(response);
        }

        public static IActionResult FailResult(int code = 500, string message = "Failure")
        {
            var response = new ApiResponse<object>
            {
                Code = code,
                Message = message,
                Success = false,
            };
            return new ObjectResult(response);
        }
    }

    public class ApiResponse<T>
    {
        public int Code { get; set; }
        public string Message { get; set; }

        [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]
        public T? Data { get; set; }

        public bool Success { get; set; }

        public static IActionResult OkResult(T data, string message = "OK")
        {
            var response = new ApiResponse<T>
            {
                Code = 200,
                Message = message,
                Success = true,
                Data = data,
            };
            return new OkObjectResult(response);
        }

        public static IActionResult OkResult(string message = "OK")
        {
            var response = new ApiResponse<T>
            {
                Code = 200,
                Message = message,
                Success = true,
            };
            return new OkObjectResult(response);
        }

        public static IActionResult FailResult(int code = 500, string message = "Failure")
        {
            var response = new ApiResponse<T>
            {
                Code = code,
                Message = message,
                Success = false
            };
            return new ObjectResult(response) { StatusCode = code };
        }
    }
}

================
File: AutoPile.DOMAIN/Models/Entities/ApplicationRole.cs
================
using Microsoft.AspNetCore.Identity;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Models.Entities
{
    public class ApplicationRole : IdentityRole
    {
    }
}

================
File: AutoPile.DOMAIN/Models/Entities/ApplicationUser.cs
================
using Microsoft.AspNetCore.Identity;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Models.Entities
{
    public class ApplicationUser : IdentityUser
    {
        public ApplicationUser()
        {
            Orders = new List<Order>();
            ShoppingCartItems = new List<ShoppingCartItem>();
        }

        public string? EmailVerifyToken { get; set; }
        public DateTime? EmailVerifyTokenCreatedAt { get; set; }
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
        public ICollection<Order> Orders { get; set; }
        public ICollection<ShoppingCartItem> ShoppingCartItems { get; set; }
        public string? RefreshToken { get; set; }
        public DateTime? RefreshTokenExpiryTime { get; set; }
    }
}

================
File: AutoPile.DOMAIN/Models/Entities/Order.cs
================
using AutoPile.DOMAIN.Enum;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.Json.Serialization;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Models.Entities
{
    public class Order
    {
        public Order()
        {
            OrderItems = new List<OrderItem>();
        }

        public int Id { get; set; }
        public string UserId { get; set; }
        public string OrderNumber { get; set; }
        public DateTime OrderDate { get; set; }
        public OrderStatus Status { get; set; }
        public decimal SubTotal { get; set; }
        public decimal DeliveryFee { get; set; }
        public decimal TotalAmount { get; set; }
        public PaymentStatus PaymentStatus { get; set; }
        public string PaymentMethod { get; set; }
        public string? StripeSessionId { get; set; }
        public string ShippingAddress_Line1 { get; set; }
        public string ShippingAddress_Line2 { get; set; }
        public string ShippingAddress_City { get; set; }
        public string ShippingAddress_Country { get; set; }
        public string ShippingAddress_State { get; set; }
        public string ShippingAddress_PostalCode { get; set; }

        [JsonIgnore]
        public ApplicationUser User { get; set; }

        public ICollection<OrderItem> OrderItems { get; set; }
    }
}

================
File: AutoPile.DOMAIN/Models/Entities/OrderItem.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.Json.Serialization;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Models.Entities
{
    public class OrderItem
    {
        public int Id { get; set; }
        public int OrderId { get; set; }
        public string ProductId { get; set; }
        public string ProductName { get; set; }
        public decimal ProductPrice { get; set; }
        public int Quantity { get; set; }
        public decimal TotalPrice { get; set; }

        [JsonIgnore]
        public Order Order { get; set; }
    }
}

================
File: AutoPile.DOMAIN/Models/Entities/Product.cs
================
using AutoPile.DOMAIN.Enum;
using MongoDB.Bson;
using MongoDB.Bson.Serialization.Attributes;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Models.Entities
{
    public class Product
    {
        public Product()
        {
            ProductMedias = new List<ProductMedia>();
        }

        [BsonId]
        [BsonRepresentation(BsonType.ObjectId)]
        public ObjectId Id { get; set; }

        [BsonElement("name")]
        [BsonRequired]
        public string Name { get; set; }

        [BsonElement("productDescription")]
        [BsonRequired]
        public string productDescription { get; set; }

        [BsonElement("productInfo")]
        [BsonRequired]
        public string ProductInfo { get; set; }

        [BsonElement("sku")]
        [BsonRequired]
        public string SKU { get; set; }

        [BsonElement("price")]
        [BsonRequired]
        public decimal Price { get; set; }

        [BsonElement("comparePrice")]
        public decimal? ComparePrice { get; set; }

        [BsonElement("isInStock")]
        [BsonRequired]
        public bool IsInStock { get; set; }

        [BsonElement("stockQuantity")]
        [BsonRequired]
        public int StockQuantity { get; set; }

        [BsonElement("ribbon")]
        [BsonRequired]
        public Ribbon Ribbon { get; set; }

        [BsonElement("createdAt")]
        [BsonRequired]
        public DateTime CreatedAt { get; set; }

        [BsonElement("updatedAt")]
        [BsonRequired]
        public DateTime UpdatedAt { get; set; }

        [BsonElement("productMedias")]
        [BsonRequired]
        public List<ProductMedia> ProductMedias { get; set; }

        [BsonElement("category")]
        [BsonRequired]
        public Category Category { get; set; }
    }
}

================
File: AutoPile.DOMAIN/Models/Entities/ProductMedia.cs
================
using MongoDB.Bson.Serialization.Attributes;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Models.Entities
{
    public class ProductMedia
    {
        [BsonElement("url")]
        [BsonRequired]
        public string Url { get; set; }

        [BsonElement("fullUrl")]
        [BsonRequired]
        public string FullUrl { get; set; }

        [BsonElement("mediaType")]
        [BsonRequired]
        public string MediaType { get; set; }

        [BsonElement("altText")]
        [BsonRequired]
        public string AltText { get; set; }

        [BsonElement("title")]
        [BsonRequired]
        public string Title { get; set; }

        [BsonElement("width")]
        [BsonRequired]
        public int Width { get; set; }

        [BsonElement("height")]
        [BsonRequired]
        public int Height { get; set; }
    }
}

================
File: AutoPile.DOMAIN/Models/Entities/Review.cs
================
using MongoDB.Bson;
using MongoDB.Bson.Serialization.Attributes;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Models.Entities
{
    public class Review
    {
        [BsonId]
        [BsonRepresentation(BsonType.ObjectId)]
        public ObjectId Id { get; set; }

        public string UserId { get; set; }
        public ObjectId ProductId { get; set; }
        public string Title { get; set; }
        public string Subtitle { get; set; }
        public string Content { get; set; }
        public int Rating { get; set; }

        //public byte[] Image { get; set; }
        //public string ImageContentType { get; set; }
        public string? ImageUrl { get; set; }

        public DateTime CreatedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
    }
}

================
File: AutoPile.DOMAIN/Models/Entities/ShoppingCartItem.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.Json.Serialization;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Models.Entities
{
    public class ShoppingCartItem
    {
        public int Id { get; set; }
        public string UserId { get; set; }
        public string ProductId { get; set; }
        public int Quantity { get; set; }
        public DateTime CreatedAt { get; set; }

        [JsonIgnore]
        public ApplicationUser User { get; set; }
    }
}

================
File: AutoPile.DOMAIN/Models/MessageQueue/EmailMessage.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.DOMAIN.Models.MessageQueue
{
    public class EmailMessage
    {
        public string To { get; set; }
        public string Subject { get; set; }
        public string Body { get; set; }
        public string MessageType { get; set; }
        public Dictionary<string, string>? AdditionalData { get; set; }
    }
}

================
File: AutoPile.SERVICE/AutoPile.SERVICE.csproj
================
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="AutoMapper" Version="13.0.1" />
    <PackageReference Include="Azure.Storage.Blobs" Version="12.23.0" />
    <PackageReference Include="Azure.Storage.Queues" Version="12.21.0" />
    <PackageReference Include="Resend" Version="0.0.10" />
    <PackageReference Include="Stripe.net" Version="47.2.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\AutoPile.DATA\AutoPile.DATA.csproj" />
  </ItemGroup>

</Project>

================
File: AutoPile.SERVICE/Services/AuthService.cs
================
using AutoMapper;
using AutoPile.DATA.Cache;
using AutoPile.DATA.Exceptions;
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models.Entities;
using AutoPile.DOMAIN.Models.MessageQueue;
using AutoPile.SERVICE.Utilities;
using DnsClient.Internal;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using Resend;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.SERVICE.Services
{
    public class AuthService : IAuthService
    {
        private const int TOKEN_EXPIRY_MINUTES = 15;
        private readonly UserManager<ApplicationUser> _userManager;
        private readonly IMapper _mapper;
        private readonly IJwtTokenGenerator _jwtTokenGenerator;
        private readonly IResend _resend;
        private readonly IConfiguration _configuration;
        private readonly IEmailQueueService _emailQueueService;
        private readonly IUserInfoCache _userInfoCache;
        private readonly ILogger<IAuthService> _logger;

        public AuthService(UserManager<ApplicationUser> userManager, ILogger<IAuthService> logger, IEmailQueueService emailQueueService, IConfiguration configuration, IMapper mapper, IUserInfoCache userInfoCache, IJwtTokenGenerator jwtTokenGenerator, IResend resend)
        {
            _userManager = userManager;
            _mapper = mapper;
            _jwtTokenGenerator = jwtTokenGenerator;
            _resend = resend;
            _configuration = configuration;
            _emailQueueService = emailQueueService;
            _userInfoCache = userInfoCache;
            _logger = logger;
        }

        public async Task<(UserResponseDTO, string, string)> SignupAdminAsync(UserSignupDTO userSignupDTO)
        {
            var existingUser = await _userManager.FindByEmailAsync(userSignupDTO.Email);
            if (existingUser != null)
            {
                throw new BadRequestException("Email already registered");
            }

            var existUserWithPhone = await _userManager.Users.AnyAsync(u => u.PhoneNumber == userSignupDTO.PhoneNumber);
            if (existUserWithPhone)
            {
                throw new BadRequestException("Phone number already registered");
            }

            var user = new ApplicationUser
            {
                UserName = userSignupDTO.UserName,
                Email = userSignupDTO.Email,
                FirstName = userSignupDTO.FirstName,
                LastName = userSignupDTO.LastName,
                PhoneNumber = userSignupDTO.PhoneNumber,
                EmailConfirmed = true,
                PhoneNumberConfirmed = true
            };

            var result = await _userManager.CreateAsync(user, userSignupDTO.Password);
            if (!result.Succeeded)
            {
                var errors = result.Errors.Select(e => e.Description);
                throw new BadRequestException($"Failed to create user: {string.Join(", ", errors)}");
            }

            var addToAdminResult = await _userManager.AddToRoleAsync(user, "Admin");
            if (!addToAdminResult.Succeeded)
            {
                var errors = addToAdminResult.Errors.Select(e => e.Description);
                throw new BadRequestException($"Failed to add user to role: {string.Join(", ", errors)}");
            }

            //var addToUserResult = await _userManager.AddToRoleAsync(user, "User");
            //if (!addToUserResult.Succeeded)
            //{
            //    var errors = addToUserResult.Errors.Select(e => e.Description);
            //    throw new BadRequestException($"Failed to add user to role: {string.Join(", ", errors)}");
            //}

            var accessToken = _jwtTokenGenerator.GenerateJwtToken(user);
            var refreshToken = RefreshTokenGenerator.GenerateRefreshToken();
            await UpdateUserRefreshTokenAsync(user, refreshToken);

            var responseDTO = new UserResponseDTO
            {
                Id = user.Id,
                UserName = user.UserName,
                Email = user.Email,

                Roles = await _userManager.GetRolesAsync(user)
            };

            return (responseDTO, accessToken, refreshToken);
        }

        public async Task<(UserResponseDTO, string, string)> SignupUserAsync(UserSignupDTO userSignupDTO)
        {
            var existingUser = await _userManager.FindByEmailAsync(userSignupDTO.Email);
            if (existingUser != null)
            {
                throw new BadRequestException("Email already registered");
            }

            var existUserWithPhone = _userManager.Users.Any(u => u.PhoneNumber == userSignupDTO.PhoneNumber);
            if (existUserWithPhone)
            {
                throw new BadRequestException("Phone number already registered");
            }

            var user = _mapper.Map<ApplicationUser>(userSignupDTO);

            var result = await _userManager.CreateAsync(user, userSignupDTO.Password);
            if (!result.Succeeded)
            {
                var errors = result.Errors.Select(e => e.Description);
                throw new BadRequestException($"Failed to create user: {string.Join(", ", errors)}");
            }

            var addToRoleResult = await _userManager.AddToRoleAsync(user, "User");
            if (!addToRoleResult.Succeeded)
            {
                var errors = addToRoleResult.Errors.Select(e => e.Description);
                throw new BadRequestException($"Failed to add user to role: {string.Join(", ", errors)}");
            }

            var accessToken = _jwtTokenGenerator.GenerateJwtToken(user);
            var refreshToken = RefreshTokenGenerator.GenerateRefreshToken();
            await UpdateUserRefreshTokenAsync(user, refreshToken);

            var responseDTO = _mapper.Map<UserResponseDTO>(user);
            responseDTO.Roles = await _userManager.GetRolesAsync(user);

            return (responseDTO, accessToken, refreshToken);
        }

        public async Task<(UserResponseDTO, string, string)> SigninAsync(UserSigninDTO userSigninDTO)
        {
            var user = await _userManager.FindByEmailAsync(userSigninDTO.Email);

            if (user != null && await _userManager.CheckPasswordAsync(user, userSigninDTO.Password))
            {
                var accessToken = _jwtTokenGenerator.GenerateJwtToken(user);
                var refreshToken = RefreshTokenGenerator.GenerateRefreshToken();
                await UpdateUserRefreshTokenAsync(user, refreshToken);

                UserResponseDTO userResponseDTO = _mapper.Map<UserResponseDTO>(user);

                userResponseDTO.Roles = await _userManager.GetRolesAsync(user);
                //var userResponseInfoDTO = _mapper.Map<UserInfoResponseDTO>(user);
                //userResponseInfoDTO.Roles = userResponseDTO.Roles;
                //await _userInfoCache.SetUserAsync(user.Id, userResponseInfoDTO);
                _logger.LogInformation("Successfully cached user info for user {UserId}", user.Id);
                return (userResponseDTO, accessToken, refreshToken);
            }

            throw new NotFoundException("Email does not exist or incorrect password");
        }

        public async Task<UserInfoResponseDTO> GetUserInfoAsync(string userId)
        {
            if (string.IsNullOrEmpty(userId))
            {
                throw new BadRequestException("user id is not found");
            }

            //var userCached = await _userInfoCache.GetUserAsync(userId);
            //if (userCached != null)
            //{
            //    return userCached;
            //}

            var user = await _userManager.FindByIdAsync(userId) ?? throw new NotFoundException($"User with ID {userId} not found");
            UserInfoResponseDTO userInfoResponseDTO = _mapper.Map<UserInfoResponseDTO>(user);
            userInfoResponseDTO.Roles = await _userManager.GetRolesAsync(user);
            return userInfoResponseDTO;
        }

        public async Task<string> SendEmailConfirmationTokenAsync(string email, string userId)
        {
            if (string.IsNullOrEmpty(email))
            {
                throw new BadRequestException("Email is required");
            }
            var user = await _userManager.FindByEmailAsync(email) ?? throw new NotFoundException($"User with email {email} not found");
            if (user.Id != userId)
            {
                throw new ForbiddenException();
            }
            var isConfirmed = await _userManager.IsEmailConfirmedAsync(user);
            if (isConfirmed)
            {
                throw new BadRequestException("This email is already confirmed");
            }
            if (user.EmailVerifyTokenCreatedAt.HasValue &&
        DateTime.UtcNow < user.EmailVerifyTokenCreatedAt.Value.AddMinutes(TOKEN_EXPIRY_MINUTES))
            {
                throw new BadRequestException($"A confirmation link has already been sent. Please wait {TOKEN_EXPIRY_MINUTES} minutes before requesting a new one.");
            }
            var token = await _userManager.GenerateEmailConfirmationTokenAsync(user);

            user.EmailVerifyToken = token;
            user.EmailVerifyTokenCreatedAt = DateTime.UtcNow;
            await _userManager.UpdateAsync(user);

            var emailConfirmationUrl = $"{Environment.GetEnvironmentVariable("DOMAIN") ?? _configuration["Domain"]}/Auth/VerifyEmailConfirmationLink?token={Uri.EscapeDataString(token)}&email={Uri.EscapeDataString(email)}";
            //var message = new EmailMessage();
            //message.From = "Emailconfirm@autopile.store";
            //message.To.Add(email);
            //message.Subject = "Email Confirmation Link";
            //message.HtmlBody = $@"
            //    <p>Hello,</p>
            //    <p>Please click the link below to verify your email:</p>
            //    <p><a href='{emailConfirmationUrl}'>Email confirmation link</a></p>
            //    <p>If you did not sign up, please ignore this email.</p>"; ;

            //await _resend.EmailSendAsync(message);
            var emailMessage = new DOMAIN.Models.MessageQueue.EmailMessage
            {
                To = email,
                Subject = "Email Confirmation Link",
                MessageType = "EmailConfirmation",
                Body = $@"<p>Hello,</p><p>Please click the link below to verify your email:</p>
                     <p><a href='{emailConfirmationUrl}'>Email confirmation link</a></p>",
                AdditionalData = new Dictionary<string, string>
                {
                    ["UserId"] = userId,
                    ["Token"] = token
                }
            };

            await _emailQueueService.QueueEmailMessage(emailMessage);
            return token.ToString();
        }

        public async Task<bool> VerifyEmailConfirmationTokenAsync(string token, string email)
        {
            if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(token))
            {
                return false;
            }
            var user = await _userManager.FindByEmailAsync(email) ?? throw new NotFoundException($"User with email {email} not found");

            if (await _userManager.IsEmailConfirmedAsync(user))
            {
                return false;
            }
            if (user.EmailVerifyToken != token)
            {
                return false;
            }

            if (!user.EmailVerifyTokenCreatedAt.HasValue ||
        DateTime.UtcNow > user.EmailVerifyTokenCreatedAt.Value.AddMinutes(TOKEN_EXPIRY_MINUTES))
            {
                return false;
            }

            var result = await _userManager.ConfirmEmailAsync(user, token);
            if (result.Succeeded)
            {
                user.EmailVerifyToken = null;
                user.EmailVerifyTokenCreatedAt = null;
                await _userManager.UpdateAsync(user);
            }

            return result.Succeeded;
        }

        public async Task UpdateUserInfoAsync(UserUpdateInfoDTO userUpdateInfoDTO, string userId)
        {
            if (userId == null)
            {
                throw new NotFoundException("User ID not found in token.");
            }

            var user = await _userManager.FindByIdAsync(userId) ?? throw new NotFoundException("User not found");
            _mapper.Map(userUpdateInfoDTO, user);

            await _userInfoCache.SetUserAsync(userId, _mapper.Map<UserInfoResponseDTO>(user));
            await _userManager.UpdateAsync(user);
        }

        public async Task<string> SendResetPasswordTokenAsync(string email)
        {
            if (string.IsNullOrEmpty(email))
            {
                throw new BadRequestException("email is required");
            }
            var user = await _userManager.FindByEmailAsync(email) ?? throw new NotFoundException($"User with email {email} not found");
            var token = await _userManager.GeneratePasswordResetTokenAsync(user);

            var emailResetUrl = $"https://www.autopile.store/reset-password?token={Uri.EscapeDataString(token)}&email={Uri.EscapeDataString(email)}";
            //var message = new Resend.EmailMessage();
            //message.From = "PasswordReset@autopile.store";
            //message.To.Add(email);
            //message.Subject = "Password Reset Link";
            //message.HtmlBody = $@"
            //    <p>Hello,</p>
            //    <p>Please click the link below to Reset your password:</p>
            //    <p><a href='{emailConfirmationUrl}'>Password Reset link</a></p>
            //    <p>If you did not request password reset, please ignore this email.</p>"; ;

            //await _resend.EmailSendAsync(message);

            var emailMessage = new DOMAIN.Models.MessageQueue.EmailMessage
            {
                To = email,
                Subject = "Password Reset Link",
                MessageType = "PasswordReset",
                Body = $@"<p>Hello,</p><p>Please click the link below to Reset your password:</p>
                     <p><a href='{emailResetUrl}'>Password Reset link</a></p>
                     <p>If you did not request password reset, please ignore this email.</p>"
            };

            await _emailQueueService.QueueEmailMessage(emailMessage);
            return token.ToString();
        }

        public async Task ResetPasswordAsync(UserResetPasswordDTO userResetPasswordDTO)
        {
            var user = await _userManager.FindByEmailAsync(userResetPasswordDTO.Email) ?? throw new NotFoundException($"User with email {userResetPasswordDTO.Email} not found");

            var result = await _userManager.ResetPasswordAsync(user, userResetPasswordDTO.EmailVerifyToken, userResetPasswordDTO.NewPassword);
            if (!result.Succeeded)
            {
                var errors = string.Join(", ", result.Errors.Select(e => e.Description));
                throw new BadRequestException($"Password reset failed: {errors}");
            }
        }

        public async Task ValidatePasswordResetTokenAsync(string email, string token)
        {
            if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(token))
            {
                throw new BadRequestException("Email and token are required");
            }

            var user = await _userManager.FindByEmailAsync(email)
                ?? throw new NotFoundException($"User with email {email} not found");

            bool isValid = await _userManager.VerifyUserTokenAsync(
                user,
                _userManager.Options.Tokens.PasswordResetTokenProvider,
                UserManager<IdentityUser>.ResetPasswordTokenPurpose,
                token
            );
            if (!isValid)
            {
                throw new BadRequestException("Token expired or invalid");
            }
        }

        public async Task UpdateUserRefreshTokenAsync(ApplicationUser user, string refreshToken)
        {
            user.RefreshToken = refreshToken;
            user.RefreshTokenExpiryTime = DateTime.UtcNow.AddDays(7);
            await _userManager.UpdateAsync(user);
        }

        public async Task<TokenRefreshResponse> RefreshTokenAsync(string refreshToken)
        {
            var user = await _userManager.Users
                .FirstOrDefaultAsync(u => u.RefreshToken == refreshToken);

            if (user == null)
                throw new NotFoundException("Invalid refresh token");

            if (user.RefreshTokenExpiryTime <= DateTime.UtcNow)
                throw new BadRequestException("Refresh token expired");

            var newAccessToken = _jwtTokenGenerator.GenerateJwtToken(user);
            var newRefreshToken = RefreshTokenGenerator.GenerateRefreshToken();

            await UpdateUserRefreshTokenAsync(user, newRefreshToken);

            return new TokenRefreshResponse
            {
                AccessToken = newAccessToken,
                RefreshToken = newRefreshToken
            };
        }

        public async Task RevokeRefreshTokenAsync(string userId)
        {
            var user = await _userManager.FindByIdAsync(userId);
            if (user == null)
                throw new NotFoundException($"User with ID {userId} not found");

            user.RefreshToken = null;
            user.RefreshTokenExpiryTime = null;
            await _userManager.UpdateAsync(user);
        }
    }
}

================
File: AutoPile.SERVICE/Services/BlobService.cs
================
using AutoPile.DATA.Exceptions;
using AutoPile.DOMAIN.Interface;
using Azure.Storage.Blobs;
using Azure.Storage.Blobs.Models;
using Azure.Storage.Sas;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Configuration;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.SERVICE.Services
{
    public class BlobService : IBlobService
    {
        private readonly BlobServiceClient _blobServiceClient;
        private readonly string _containerName = "reviews";

        public BlobService(IConfiguration configuration)
        {
            string connectionString = Environment.GetEnvironmentVariable("BlobStorage") ?? configuration["Azure:BlobStorage:ConnectionString"]
        ?? throw new InvalidOperationException("Blob storage connection string not configured");
            _blobServiceClient = new BlobServiceClient(connectionString);
        }

        public async Task<string> UploadImageAsync(IFormFile file)
        {
            var containerClient = _blobServiceClient.GetBlobContainerClient(_containerName);
            await containerClient.CreateIfNotExistsAsync();

            // Create unique blob name
            string blobName = $"{Guid.NewGuid()}{Path.GetExtension(file.FileName)}";
            var blobClient = containerClient.GetBlobClient(blobName);

            // Upload the file
            using var stream = file.OpenReadStream();
            await blobClient.UploadAsync(stream, new BlobHttpHeaders { ContentType = file.ContentType });

            // Generate SAS token
            var sasBuilder = new BlobSasBuilder
            {
                BlobContainerName = _containerName,
                BlobName = blobName,
                Resource = "b", // b for blob
                StartsOn = DateTimeOffset.UtcNow,
                ExpiresOn = DateTimeOffset.UtcNow.AddYears(1), // Or your preferred expiration
            };
            sasBuilder.SetPermissions(BlobSasPermissions.Read); // Only allow read

            var sasToken = blobClient.GenerateSasUri(sasBuilder).ToString();
            return sasToken; // This will return the full URL with SAS token
        }

        public async Task DeleteImageAsync(string imageUrl)
        {
            var containerClient = _blobServiceClient.GetBlobContainerClient(_containerName);
            var uri = new Uri(imageUrl);
            string blobName = Path.GetFileName(uri.LocalPath);
            var blobClient = containerClient.GetBlobClient(blobName);
            await blobClient.DeleteIfExistsAsync();
        }

        public async Task<string> UpdateImageAsync(string oldImageUrl, IFormFile newFile)
        {
            if (newFile == null)
            {
                throw new BadRequestException("Empty file");
            }

            if (!string.IsNullOrEmpty(oldImageUrl))
            {
                await DeleteImageAsync(oldImageUrl);
            }

            return await UploadImageAsync(newFile);
        }
    }
}

================
File: AutoPile.SERVICE/Services/EmailProcessingService.cs
================
// EmailProcessingService.cs
using Azure.Storage.Queues;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using Resend;
using System.Text.Json;
using System.Text;

public class EmailProcessingService : BackgroundService
{
    private readonly QueueClient _queueClient;
    private readonly IResend _resend;
    private readonly ILogger<EmailProcessingService> _logger;
    private const string QUEUE_NAME = "email-queue";

    private static readonly JsonSerializerOptions _jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true,
        WriteIndented = true
    };

    public EmailProcessingService(QueueClient queueClient, IResend resend, ILogger<EmailProcessingService> logger)
    {
        _logger = logger;
        _logger.LogInformation("Initializing EmailProcessingService - {Time}", DateTime.UtcNow);

        try
        {
            _queueClient = queueClient;
            _logger.LogInformation("Queue client injected successfully");

            _resend = resend;
            _logger.LogInformation("EmailProcessingService initialization complete");
        }
        catch (Exception ex)
        {
            _logger.LogCritical(ex, "EmailProcessingService initialization failed");
            throw;
        }
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("EmailProcessingService background task starting - {Time}", DateTime.UtcNow);

        try
        {
            while (!stoppingToken.IsCancellationRequested)
            {
                _logger.LogDebug("Polling for messages - {Time}", DateTime.UtcNow);
                var messages = await _queueClient.ReceiveMessagesAsync(maxMessages: 32, cancellationToken: stoppingToken);

                _logger.LogInformation("Received {Count} messages", messages.Value.Count());

                foreach (var message in messages.Value)
                {
                    try
                    {
                        var decodedString = Encoding.UTF8.GetString(Convert.FromBase64String(message.MessageText));
                        _logger.LogDebug("Processing message: {MessageId}", message.MessageId);

                        var emailMessage = JsonSerializer.Deserialize<AutoPile.DOMAIN.Models.MessageQueue.EmailMessage>(decodedString, _jsonOptions);
                        if (emailMessage == null)
                        {
                            _logger.LogWarning("Failed to deserialize message {MessageId}", message.MessageId);
                            continue;
                        }

                        var resendMessage = new Resend.EmailMessage
                        {
                            From = $"{emailMessage.MessageType}@autopile.store",
                            To = { emailMessage.To },
                            Subject = emailMessage.Subject,
                            HtmlBody = emailMessage.Body
                        };

                        await _resend.EmailSendAsync(resendMessage);
                        _logger.LogInformation("Successfully sent email to {Recipient}", emailMessage.To);

                        await _queueClient.DeleteMessageAsync(message.MessageId, message.PopReceipt, stoppingToken);
                        _logger.LogInformation("Deleted processed message {MessageId}", message.MessageId);
                    }
                    catch (Exception ex)
                    {
                        _logger.LogError(ex, "Error processing message {MessageId}", message.MessageId);
                    }
                }

                await Task.Delay(TimeSpan.FromSeconds(10), stoppingToken);
            }
        }
        catch (Exception ex)
        {
            _logger.LogCritical(ex, "Fatal error in EmailProcessingService");
            throw;
        }
    }
}

================
File: AutoPile.SERVICE/Services/EmailQueueService.cs
================
using AutoPile.DOMAIN.Models.MessageQueue;
using Azure.Storage.Queues;
using MongoDB.Driver.Core.Configuration;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;

namespace AutoPile.SERVICE.Services
{
    public class EmailQueueService : IEmailQueueService
    {
        private readonly QueueClient _queueClient;

        public EmailQueueService()
        {
            _queueClient = new QueueClient(Environment.GetEnvironmentVariable("BlobStorage"), "email-queue");
            _queueClient.CreateIfNotExists();
        }

        public async Task QueueEmailMessage(EmailMessage message)
        {
            var messageJson = JsonSerializer.Serialize(message);
            await _queueClient.SendMessageAsync(Convert.ToBase64String(
                Encoding.UTF8.GetBytes(messageJson)));
        }
    }
}

================
File: AutoPile.SERVICE/Services/InventoryProcessingService.cs
================
using AutoPile.DATA.Data;
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.Models.Entities;
using Azure.Storage.Queues;
using Microsoft.Extensions.Azure;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using MongoDB.Bson;
using System.Text;
using System.Text.Json;

public class InventoryProcessingService : BackgroundService
{
    private readonly IServiceScopeFactory _serviceScopeFactory;
    private readonly QueueClient _queueClient;
    private readonly ILogger<InventoryProcessingService> _logger;
    private const string QUEUE_NAME = "inventory-queue";

    public InventoryProcessingService(IServiceScopeFactory serviceScopeFactory, ILogger<InventoryProcessingService> logger)
    {
        _serviceScopeFactory = serviceScopeFactory;
        _logger = logger;
        _logger.LogInformation("Initializing InventoryProcessingService with queue: {QueueName}", QUEUE_NAME);
        _queueClient = new QueueClient(Environment.GetEnvironmentVariable("BlobStorage"), QUEUE_NAME);
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("Starting InventoryProcessingService background task");

        while (!stoppingToken.IsCancellationRequested)
        {
            _logger.LogDebug("InventoryProcessingService: Checking for messages in {QueueName}", QUEUE_NAME);
            var messages = await _queueClient.ReceiveMessagesAsync(maxMessages: 32, cancellationToken: stoppingToken);

            if (messages.Value.Any())
            {
                _logger.LogInformation("InventoryProcessingService: Found {MessageCount} messages in {QueueName}",
                    messages.Value.Count(), QUEUE_NAME);

                foreach (var message in messages.Value)
                {
                    _logger.LogInformation("InventoryProcessingService: Received message {MessageId} from {QueueName}",
                        message.MessageId, QUEUE_NAME);

                    var decodedString = Encoding.UTF8.GetString(Convert.FromBase64String(message.MessageText));
                    _logger.LogInformation("InventoryProcessingService: Decoded message content: {DecodedMessage}", decodedString);
                    var orderItems = JsonSerializer.Deserialize<List<OrderItem>>(decodedString);
                    _logger.LogInformation("InventoryProcessingService: Successfully deserialized message {MessageId}", message.MessageId);

                    using (var scope = _serviceScopeFactory.CreateScope())
                    {
                        var mongoContext = scope.ServiceProvider.GetRequiredService<AutoPileMongoDbContext>();
                        foreach (var item in orderItems)
                        {
                            _logger.LogInformation("Processing Item: {Id}, {ProductName}, {Quantity}", item.Id, item.ProductName, item.Quantity);
                            if (!ObjectId.TryParse(item.ProductId, out ObjectId productObjectId))
                            {
                                _logger.LogError("Invalid product ID format: {ProductId}", item.ProductId);
                                continue;
                            }

                            var product = await mongoContext.Products.FindAsync(productObjectId);
                            if (product == null)
                            {
                                _logger.LogError("Product not found: {ProductId}", item.ProductId);
                                continue;
                            }
                            if (product.StockQuantity > item.Quantity)
                            {
                                product.StockQuantity -= item.Quantity;
                                product.IsInStock = product.StockQuantity > 0;
                                product.UpdatedAt = DateTime.UtcNow;
                                mongoContext.Update(product);
                                await mongoContext.SaveChangesAsync(stoppingToken);
                                _logger.LogInformation(
                   "Successfully updated inventory for product {ProductId}. New stock: {StockQuantity}",
                   item.ProductId, product.StockQuantity);
                            }
                        }
                    }

                    await _queueClient.DeleteMessageAsync(message.MessageId, message.PopReceipt, stoppingToken);
                    _logger.LogInformation("InventoryProcessingService: Deleted message {MessageId} from {QueueName}",
                        message.MessageId, QUEUE_NAME);
                }

                await Task.Delay(TimeSpan.FromSeconds(10), stoppingToken);
            }
        }
    }
}

================
File: AutoPile.SERVICE/Services/InventoryQueueService.cs
================
using AutoPile.DOMAIN.Models.Entities;
using AutoPile.SERVICE.Services;
using Azure.Storage.Queues;
using Microsoft.Extensions.Logging;
using System.Text;
using System.Text.Json;

public class InventoryQueueService : IInventoryQueueService
{
    private readonly QueueClient _queueClient;
    private readonly ILogger<InventoryQueueService> _logger;
    private const string QUEUE_NAME = "inventory-queue";

    public InventoryQueueService(ILogger<InventoryQueueService> logger)
    {
        _logger = logger;
        _queueClient = new QueueClient(Environment.GetEnvironmentVariable("BlobStorage"), QUEUE_NAME);
        _queueClient.CreateIfNotExists();
        _logger.LogInformation("Initialized InventoryQueueService with queue: {QueueName}", QUEUE_NAME);
    }

    public async Task QueueOrderItemMessage(ICollection<OrderItem> orderItems)
    {
        var messageJson = JsonSerializer.Serialize(orderItems);
        _logger.LogInformation("Queueing inventory message with content: {MessageContent}", messageJson);

        var base64Message = Convert.ToBase64String(Encoding.UTF8.GetBytes(messageJson));
        _logger.LogInformation("Base64 encoded message: {Base64Message}", base64Message);

        await _queueClient.SendMessageAsync(base64Message);
        _logger.LogInformation("Successfully queued inventory message to {QueueName}", QUEUE_NAME);
    }
}

================
File: AutoPile.SERVICE/Services/OrderItemService.cs
================
using AutoMapper;
using AutoPile.DATA.Data;
using AutoPile.DATA.Exceptions;
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models.Entities;
using MongoDB.Bson;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.SERVICE.Services
{
    public class OrderItemService : IOrderItemService
    {
        private readonly AutoPileManagementDbContext _autoPileManagementDbContext;
        private readonly AutoPileMongoDbContext _autoPileMongoDbContext;
        private readonly IMapper _mapper;

        public OrderItemService(AutoPileManagementDbContext autoPileManagementDbContext, AutoPileMongoDbContext autoPileMongoDbContext, IMapper mapper)
        {
            _autoPileManagementDbContext = autoPileManagementDbContext;
            _autoPileMongoDbContext = autoPileMongoDbContext;
            _mapper = mapper;
        }

        public async Task<OrderItemResponseDTO> CreateOrderItemAsync(OrderItemCreateDTO orderItemCreateDTO)
        {
            if (!ObjectId.TryParse(orderItemCreateDTO.ProductId, out ObjectId productObjectId))
            {
                throw new BadRequestException("Invalid product ID format");
            }
            var product = await _autoPileMongoDbContext.Products.FindAsync(productObjectId) ?? throw new NotFoundException($"Product with Id {orderItemCreateDTO.ProductId} not found");
            var orderItem = _mapper.Map<OrderItem>(orderItemCreateDTO);
            orderItem.TotalPrice = orderItem.ProductPrice * orderItem.Quantity;
            await _autoPileManagementDbContext.OrderItems.AddAsync(orderItem);
            await _autoPileManagementDbContext.SaveChangesAsync();
            return _mapper.Map<OrderItemResponseDTO>(orderItem);
        }

        public async Task<OrderItemResponseDTO> GetOrderItemById(string id)
        {
            var orderItem = await _autoPileManagementDbContext.OrderItems.FindAsync(id) ?? throw new NotFoundException($"OrderItem with id {id} is not found");
            var orderItemResponse = _mapper.Map<OrderItemResponseDTO>(orderItem);
            return orderItemResponse;
        }

        public async Task<OrderItemResponseDTO> UpdateOrderItem(OrderItemUpdateDTO orderItemUpdateDTO, string id)
        {
            var orderItem = await _autoPileManagementDbContext.OrderItems.FindAsync(id) ?? throw new NotFoundException($"OrderItem with id {id} is not found");
            _mapper.Map(orderItemUpdateDTO, orderItem);
            _autoPileManagementDbContext.OrderItems.Update(orderItem);
            await _autoPileManagementDbContext.SaveChangesAsync();
            return _mapper.Map<OrderItemResponseDTO>(orderItem);
        }

        public async Task DeleteOrderItem(string id)
        {
            var orderItem = await _autoPileManagementDbContext.OrderItems.FindAsync(id) ?? throw new NotFoundException($"OrderItem with id {id} is not found");
            _autoPileManagementDbContext.OrderItems.Remove(orderItem);
            await _autoPileManagementDbContext.SaveChangesAsync();
        }
    }
}

================
File: AutoPile.SERVICE/Services/OrderService.cs
================
using AutoMapper;
using AutoPile.DATA.Cache;
using AutoPile.DATA.Data;
using AutoPile.DATA.Exceptions;
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Enum;
using AutoPile.DOMAIN.Models.Entities;
using AutoPile.SERVICE.Services;
using Microsoft.EntityFrameworkCore;
using MongoDB.Bson;

public class OrderService : IOrderService
{
    private readonly AutoPileManagementDbContext _autoPileManagementDbContext;
    private readonly AutoPileMongoDbContext _autoPileMongoDbContext;
    private readonly IMapper _mapper;
    private readonly IInventoryQueueService _inventoryQueueService;
    private readonly IOrderCache _orderCache;

    public OrderService(AutoPileManagementDbContext autoPileManagementDbContext, IOrderCache orderCache, AutoPileMongoDbContext autoPileMongoDbContext, IMapper mapper, IInventoryQueueService inventoryQueueService)
    {
        _autoPileManagementDbContext = autoPileManagementDbContext;
        _autoPileMongoDbContext = autoPileMongoDbContext;
        _mapper = mapper;
        _inventoryQueueService = inventoryQueueService;
        _orderCache = orderCache;
    }

    public async Task<OrderResponseDTO> CreateOrderAsync(OrderCreateDTO orderCreateDTO, string applicationUserId)
    {
        using var transaction = await _autoPileManagementDbContext.Database.BeginTransactionAsync();
        try
        {
            var user = await _autoPileManagementDbContext.Users.FindAsync(applicationUserId)
                ?? throw new NotFoundException($"User with ID {applicationUserId} not found");

            var orderItems = new List<OrderItem>();
            decimal subtotal = 0;

            foreach (var itemDTO in orderCreateDTO.OrderItems)
            {
                if (!ObjectId.TryParse(itemDTO.ProductId, out ObjectId productObjectId))
                {
                    throw new BadRequestException("Invalid product ID format");
                }

                var product = await _autoPileMongoDbContext.Products.FindAsync(productObjectId)
                    ?? throw new NotFoundException($"Product with Id {itemDTO.ProductId} not found");

                if (product.StockQuantity < itemDTO.Quantity)
                {
                    throw new BadRequestException($"Insufficient stock for product {product.Name}. Available: {product.StockQuantity}, Requested: {itemDTO.Quantity}");
                }

                decimal productPrice = product.Price;
                if (product.ComparePrice.HasValue && product.ComparePrice.Value > 0)
                {
                    productPrice = product.ComparePrice.Value;
                }

                var itemTotal = productPrice * itemDTO.Quantity;

                var orderItem = new OrderItem
                {
                    ProductId = itemDTO.ProductId,
                    ProductName = product.Name,
                    ProductPrice = productPrice,
                    Quantity = itemDTO.Quantity,
                    TotalPrice = itemTotal
                };

                orderItems.Add(orderItem);
                subtotal += itemTotal;
            }

            var order = new Order
            {
                UserId = applicationUserId,
                OrderNumber = OrderNumberGenerator.GenerateSequentialOrderNumber(),
                OrderDate = DateTime.UtcNow,
                Status = OrderStatus.Pending,
                PaymentStatus = PaymentStatus.Pending,
                PaymentMethod = orderCreateDTO.PaymentMethod,
                ShippingAddress_Line1 = orderCreateDTO.ShippingAddress_Line1,
                ShippingAddress_Line2 = orderCreateDTO.ShippingAddress_Line2,
                ShippingAddress_City = orderCreateDTO.ShippingAddress_City,
                ShippingAddress_Country = orderCreateDTO.ShippingAddress_Country,
                ShippingAddress_State = orderCreateDTO.ShippingAddress_State,
                ShippingAddress_PostalCode = orderCreateDTO.ShippingAddress_PostalCode,
                DeliveryFee = orderCreateDTO.DeliveryFee,
                SubTotal = subtotal,
                TotalAmount = subtotal + orderCreateDTO.DeliveryFee,
                StripeSessionId = null,
                OrderItems = orderItems
            };

            await _autoPileManagementDbContext.Orders.AddAsync(order);
            await _autoPileManagementDbContext.SaveChangesAsync();
            await transaction.CommitAsync();

            await _inventoryQueueService.QueueOrderItemMessage(order.OrderItems);

            return _mapper.Map<OrderResponseDTO>(order);
        }
        catch
        {
            await transaction.RollbackAsync();
            throw;
        }
    }

    public async Task<OrderResponseDTO> GetOrderByIdAsync(int orderId, string applicationUserId)
    {
        _ = await _autoPileManagementDbContext.Users.FindAsync(applicationUserId)
                ?? throw new NotFoundException($"User with ID {applicationUserId} not found");
        var order = await _autoPileManagementDbContext.Orders.Include(o => o.OrderItems).FirstOrDefaultAsync(o => o.Id == orderId)
            ?? throw new NotFoundException($"Order with ID {orderId} not found");
        if (order.UserId != applicationUserId)
        {
            throw new ForbiddenException("You are not authorized to view this order");
        }

        return _mapper.Map<OrderResponseDTO>(order);
    }

    public async Task<OrderResponseDTO> GetOrderByOrderIdAsync(string orderId, string applicationUserId)
    {
        _ = await _autoPileManagementDbContext.Users.FindAsync(applicationUserId)
                ?? throw new NotFoundException($"User with ID {applicationUserId} not found");
        var order = await _autoPileManagementDbContext.Orders.Include(o => o.OrderItems).FirstOrDefaultAsync(o => o.OrderNumber == orderId)
            ?? throw new NotFoundException($"Order with ID {orderId} not found");
        if (order.UserId != applicationUserId)
        {
            throw new ForbiddenException("You are not authorized to view this order");
        }
        return _mapper.Map<OrderResponseDTO>(order);
    }

    public async Task DeleteOrderAsync(int orderId, string userId)
    {
        using var transaction = await _autoPileManagementDbContext.Database.BeginTransactionAsync();
        try
        {
            var order = await _autoPileManagementDbContext.Orders
                .Include(o => o.OrderItems)
                .FirstOrDefaultAsync(o => o.Id == orderId)
                ?? throw new NotFoundException($"Order with ID {orderId} not found");

            if (order.UserId != userId)
            {
                throw new ForbiddenException("You are not authorized to delete this order");
            }

            if (order.Status == OrderStatus.Success)
            {
                throw new BadRequestException("Cannot delete a completed order");
            }

            _autoPileManagementDbContext.OrderItems.RemoveRange(order.OrderItems);
            _autoPileManagementDbContext.Orders.Remove(order);

            await _autoPileManagementDbContext.SaveChangesAsync();
            await transaction.CommitAsync();
        }
        catch
        {
            await transaction.RollbackAsync();
            throw;
        }
    }

    public async Task CompleteOrderAsync(string applicationUserId, int orderId)
    {
        _ = await _autoPileManagementDbContext.Users.FindAsync(applicationUserId)
               ?? throw new NotFoundException($"User with ID {applicationUserId} not found");
        var order = await _autoPileManagementDbContext.Orders.Include(o => o.OrderItems).FirstOrDefaultAsync(o => o.Id == orderId)
            ?? throw new NotFoundException($"Order with ID {orderId} not found");
        if (order.UserId != applicationUserId)
        {
            throw new ForbiddenException("You are not authorized to modify this order");
        }
        order.Status = OrderStatus.Success;
        order.PaymentStatus = PaymentStatus.Completed;
        await _autoPileManagementDbContext.SaveChangesAsync();
    }

    public async Task<IEnumerable<OrderResponseDTO>> GetUserOrdersAsync(string applicationUserId)
    {
        //var ordercache = await _orderCache.GetOrderAsync(applicationUserId);
        //if (ordercache != null)
        //{
        //    return ordercache;
        //}

        var orders = await _autoPileManagementDbContext.Orders.Include(o => o.OrderItems)
            .Where(o => o.UserId == applicationUserId)
            .OrderByDescending(o => o.OrderDate)
            .ToListAsync();

        //await _orderCache.SetOrderAsync(applicationUserId, _mapper.Map<IEnumerable<OrderResponseDTO>>(orders));

        return _mapper.Map<IEnumerable<OrderResponseDTO>>(orders);
    }

    public async Task<OrderResponseDTO> UpdateOrderAsync(OrderUpdateDTO orderUpdateDTO, int orderId, string userId)
    {
        using var transaction = await _autoPileManagementDbContext.Database.BeginTransactionAsync();
        try
        {
            var order = await _autoPileManagementDbContext.Orders
                .Include(o => o.OrderItems)
                .FirstOrDefaultAsync(o => o.Id == orderId)
                ?? throw new NotFoundException($"Order with ID {orderId} not found");

            if (order.UserId != userId)
            {
                throw new ForbiddenException("You are not authorized to update this order");
            }

            if (order.Status == OrderStatus.Success)
            {
                throw new BadRequestException("Cannot update a completed order");
            }

            if (orderUpdateDTO.Status.HasValue)
                order.Status = orderUpdateDTO.Status.Value;

            if (!string.IsNullOrWhiteSpace(orderUpdateDTO.PaymentMethod))
                order.PaymentMethod = orderUpdateDTO.PaymentMethod;

            if (!string.IsNullOrWhiteSpace(orderUpdateDTO.ShippingAddress_Line1))
                order.ShippingAddress_Line1 = orderUpdateDTO.ShippingAddress_Line1;

            if (!string.IsNullOrWhiteSpace(orderUpdateDTO.ShippingAddress_Line2))
                order.ShippingAddress_Line2 = orderUpdateDTO.ShippingAddress_Line2;

            if (!string.IsNullOrWhiteSpace(orderUpdateDTO.ShippingAddress_City))
                order.ShippingAddress_City = orderUpdateDTO.ShippingAddress_City;

            if (!string.IsNullOrWhiteSpace(orderUpdateDTO.ShippingAddress_Country))
                order.ShippingAddress_Country = orderUpdateDTO.ShippingAddress_Country;

            if (!string.IsNullOrWhiteSpace(orderUpdateDTO.ShippingAddress_State))
                order.ShippingAddress_State = orderUpdateDTO.ShippingAddress_State;

            if (!string.IsNullOrWhiteSpace(orderUpdateDTO.ShippingAddress_PostalCode))
                order.ShippingAddress_PostalCode = orderUpdateDTO.ShippingAddress_PostalCode;

            if (orderUpdateDTO.OrderItems != null && orderUpdateDTO.OrderItems.Any())
            {
                decimal subtotal = 0;

                foreach (var itemDTO in orderUpdateDTO.OrderItems)
                {
                    if (!ObjectId.TryParse(itemDTO.ProductId, out ObjectId productObjectId))
                    {
                        throw new BadRequestException($"Invalid product ID format: {itemDTO.ProductId}");
                    }

                    var product = await _autoPileMongoDbContext.Products.FindAsync(productObjectId)
                        ?? throw new NotFoundException($"Product with Id {itemDTO.ProductId} not found");

                    decimal productPrice = product.Price;
                    if (product.ComparePrice.HasValue && product.ComparePrice.Value > 0)
                    {
                        productPrice = product.ComparePrice.Value;
                    }

                    var existingItem = order.OrderItems.FirstOrDefault(item => item.ProductId == itemDTO.ProductId);
                    if (existingItem != null)
                    {
                        if (itemDTO.Quantity > product.StockQuantity)
                        {
                            throw new BadRequestException($"Insufficient stock for product {product.Name}. Available: {product.StockQuantity}, Requested: {itemDTO.Quantity}");
                        }

                        existingItem.Quantity = itemDTO.Quantity;
                        existingItem.ProductName = product.Name;
                        existingItem.ProductPrice = productPrice;
                        existingItem.TotalPrice = productPrice * itemDTO.Quantity;

                        subtotal += existingItem.TotalPrice;
                    }
                    else
                    {
                        if (itemDTO.Quantity > product.StockQuantity)
                        {
                            throw new BadRequestException($"Insufficient stock for product {product.Name}. Available: {product.StockQuantity}, Requested: {itemDTO.Quantity}");
                        }

                        var newOrderItem = new OrderItem
                        {
                            OrderId = order.Id,
                            ProductId = itemDTO.ProductId,
                            ProductName = product.Name,
                            ProductPrice = productPrice,
                            Quantity = itemDTO.Quantity,
                            TotalPrice = productPrice * itemDTO.Quantity
                        };
                        order.OrderItems.Add(newOrderItem);

                        subtotal += newOrderItem.TotalPrice;
                    }
                }

                var itemsToRemove = order.OrderItems.Where(item => item.Quantity <= 0).ToList();
                foreach (var item in itemsToRemove)
                {
                    order.OrderItems.Remove(item);
                }

                var unchangedItems = order.OrderItems.Where(item => !orderUpdateDTO.OrderItems.Any(dto => dto.ProductId == item.ProductId));
                subtotal += unchangedItems.Sum(item => item.TotalPrice);

                order.SubTotal = subtotal;
                order.TotalAmount = subtotal + order.DeliveryFee;
            }

            await _autoPileManagementDbContext.SaveChangesAsync();

            var orderResponse = _mapper.Map<OrderResponseDTO>(order);
            await _orderCache.UpdateOrderAsync(orderResponse);

            await transaction.CommitAsync();

            return orderResponse;
        }
        catch
        {
            await transaction.RollbackAsync();
            throw;
        }
    }
}

================
File: AutoPile.SERVICE/Services/PaymentService.cs
================
using AutoPile.DATA.Data;
using AutoPile.DATA.Exceptions;
using AutoPile.DOMAIN.DTOs.Requests;
using MongoDB.Bson;
using Stripe;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace AutoPile.SERVICE.Services
{
    public class PaymentService : IPaymentService
    {
        private readonly AutoPileMongoDbContext _autoPileMongoDbContext;
        private readonly IStripeService _stripeService;

        public PaymentService(AutoPileMongoDbContext autoPileMongoDbContext, IStripeService stripeService)
        {
            _autoPileMongoDbContext = autoPileMongoDbContext;
            _stripeService = stripeService;
        }

        public async Task<PaymentIntent> PaymentIntentCreateAsync(PaymentIntentCreate paymentIntentCreate)
        {
            if (paymentIntentCreate == null)
            {
                throw new BadRequestException("No products");
            }

            var totalAmount = await CalculateTotalAmountAsync(paymentIntentCreate.Items);
            return await _stripeService.CreatePaymentIntentAsync((long)(totalAmount * 100), "aud");
        }

        private async Task<decimal> CalculateTotalAmountAsync(Item[] items)
        {
            decimal totalAmount = 0;
            foreach (var item in items)
            {
                var productId = item.ProductId;
                var quantity = item.Quantity;

                if (!ObjectId.TryParse(productId, out ObjectId productObjectId))
                {
                    throw new BadRequestException("Invalid product ID format");
                }

                var product = await _autoPileMongoDbContext.Products.FindAsync(productObjectId)
                    ?? throw new NotFoundException($"Product with Id {productId} not found");

                decimal price = (product.ComparePrice ?? product.Price) * quantity;
                totalAmount += price;
            }
            return totalAmount + 10;
        }
    }
}

================
File: AutoPile.SERVICE/Services/ProductService.cs
================
using AutoMapper;
using AutoPile.DATA.Cache;
using AutoPile.DATA.Data;
using AutoPile.DATA.Exceptions;
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.EntityFrameworkCore;
using MongoDB.Bson;

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.SERVICE.Services
{
    public class ProductService : IProductService
    {
        private readonly AutoPileMongoDbContext _autoPileMongoDbContext;
        private readonly IMapper _mapper;
        private readonly IProductCache _productCache;

        public ProductService(AutoPileMongoDbContext autoPileMongoDbContext, IMapper mapper, IProductCache productCache)
        {
            _autoPileMongoDbContext = autoPileMongoDbContext;
            _mapper = mapper;
            _productCache = productCache;
        }

        public async Task<ProductResponseDTO> CreateProductAsync(ProductCreateDTO productCreateDTO)
        {
            var existingProduct = _autoPileMongoDbContext.Products.FirstOrDefault(p => p.SKU == productCreateDTO.SKU);
            if (existingProduct != null)
            {
                throw new BadRequestException($"Product with SKU {productCreateDTO.SKU} already exists");
            }
            var product = _mapper.Map<Product>(productCreateDTO);
            product.CreatedAt = DateTime.UtcNow;
            product.UpdatedAt = DateTime.UtcNow;

            await _autoPileMongoDbContext.Products.AddAsync(product);
            await _autoPileMongoDbContext.SaveChangesAsync();
            return _mapper.Map<ProductResponseDTO>(product);
        }

        public async Task<ProductResponseDTO> GetProductByIdAsync(string id)
        {
            if (!ObjectId.TryParse(id, out ObjectId productObjectId))
            {
                throw new BadRequestException("Invalid product ID format");
            }

            var cachedProduct = await _productCache.GetProductAsync(id);
            if (cachedProduct != null)
            {
                return cachedProduct;
            }

            var product = await _autoPileMongoDbContext.Products.FindAsync(productObjectId) ?? throw new NotFoundException($"Product with Id {id} not found");
            var productResponseDTO = _mapper.Map<ProductResponseDTO>(product);
            await _productCache.SetProductAsync(id, productResponseDTO);
            return productResponseDTO;
        }

        public async Task<IEnumerable<ProductResponseDTO>> GetProductsListAsync()
        {
            var products = await _autoPileMongoDbContext.Products.OrderBy(p => p.Name).ToListAsync();
            if (products.Count == 0)
            {
                throw new NotFoundException("No products found");
            }

            return _mapper.Map<IEnumerable<ProductResponseDTO>>(products);
        }

        public async Task DeleteProductByIdAsync(string id)
        {
            if (!ObjectId.TryParse(id, out ObjectId productObjectId))
            {
                throw new BadRequestException("Invalid product ID format");
            }
            var product = await _autoPileMongoDbContext.Products.FindAsync(productObjectId) ?? throw new NotFoundException($"Product with Id {id} not found");
            _autoPileMongoDbContext.Remove(product);
            await _autoPileMongoDbContext.SaveChangesAsync();

            await _productCache.DeleteProductAsync(id);
        }

        public async Task<ProductResponseDTO> UpdateProductByIdAsync(ProductUpdateDTO productUpdateDTO, string id)
        {
            if (!ObjectId.TryParse(id, out ObjectId productObjectId))
            {
                throw new BadRequestException("Invalid product ID format");
            }

            var product = await _autoPileMongoDbContext.Products.FindAsync(productObjectId)
                ?? throw new NotFoundException($"Product with Id {id} not found");

            if (productUpdateDTO.Name != null)
                product.Name = productUpdateDTO.Name;
            if (productUpdateDTO.Description != null)
                product.productDescription = productUpdateDTO.Description;
            if (productUpdateDTO.ProductInfo != null)
                product.ProductInfo = productUpdateDTO.ProductInfo;
            if (productUpdateDTO.SKU != null)
                product.SKU = productUpdateDTO.SKU;
            if (productUpdateDTO.Price.HasValue)
                product.Price = productUpdateDTO.Price.Value;
            if (productUpdateDTO.ComparePrice.HasValue)
                product.ComparePrice = productUpdateDTO.ComparePrice.Value;
            if (productUpdateDTO.IsInStock.HasValue)
                product.IsInStock = productUpdateDTO.IsInStock.Value;
            if (productUpdateDTO.StockQuantity.HasValue)
                product.StockQuantity = productUpdateDTO.StockQuantity.Value;
            if (productUpdateDTO.Ribbon.HasValue)
                product.Ribbon = productUpdateDTO.Ribbon.Value;
            if (productUpdateDTO.Category.HasValue)
                product.Category = productUpdateDTO.Category.Value;
            if (productUpdateDTO.ProductMedias != null)
                product.ProductMedias = _mapper.Map<List<ProductMedia>>(productUpdateDTO.ProductMedias);

            product.UpdatedAt = DateTime.UtcNow;

            _autoPileMongoDbContext.Update(product);
            await _autoPileMongoDbContext.SaveChangesAsync();
            await _productCache.SetProductAsync(id, _mapper.Map<ProductResponseDTO>(product));
            return _mapper.Map<ProductResponseDTO>(product);
        }
    }
}

================
File: AutoPile.SERVICE/Services/ReviewService.cs
================
using AutoMapper;
using AutoPile.DATA.Cache;
using AutoPile.DATA.Data;
using AutoPile.DATA.Exceptions;
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Interface;
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.EntityFrameworkCore;
using MongoDB.Bson;

namespace AutoPile.SERVICE.Services
{
    public class ReviewService : IReviewService
    {
        private readonly IMapper _mapper;
        private readonly AutoPileMongoDbContext _autoPileMongoDbContext;
        private readonly AutoPileManagementDbContext _autoPileManagementDbContext;
        private readonly IBlobService _blobService;
        private readonly IReviewsCache _reviewsCache;

        public ReviewService(IMapper mapper, IBlobService blobService, AutoPileMongoDbContext autoPileMongoDbContext, AutoPileManagementDbContext autoPileManagementDbContext, IReviewsCache reviewsCache)
        {
            _mapper = mapper;
            _autoPileMongoDbContext = autoPileMongoDbContext;
            _autoPileManagementDbContext = autoPileManagementDbContext;
            _blobService = blobService;
            _reviewsCache = reviewsCache;
        }

        public async Task<ReviewResponseDTO> CreateReviewAsync(ReviewCreateDTO reviewCreateDTO, string applicationUserId)
        {
            if (string.IsNullOrEmpty(applicationUserId))
            {
                throw new BadRequestException("User Id is null");
            }

            var user = await _autoPileManagementDbContext.Users.FindAsync(applicationUserId);
            if (user == null)
            {
                throw new NotFoundException($"User with ID {applicationUserId} not found");
            }

            if (!ObjectId.TryParse(reviewCreateDTO.ProductId, out ObjectId productObjectId))
            {
                throw new BadRequestException("Invalid product ID format");
            }

            var product = await _autoPileMongoDbContext.Products.FindAsync(productObjectId);
            if (product == null)
            {
                throw new NotFoundException($"Product with ID {reviewCreateDTO.ProductId} not found");
            }

            var review = _mapper.Map<Review>(reviewCreateDTO);
            review.UserId = user.Id;

            if (reviewCreateDTO.Image != null)
            {
                review.ImageUrl = await _blobService.UploadImageAsync(reviewCreateDTO.Image);
            }

            await _autoPileMongoDbContext.Reviews.AddAsync(review);
            await _autoPileMongoDbContext.SaveChangesAsync();

            var reviewResponseDto = _mapper.Map<ReviewResponseDTO>(review);

            return reviewResponseDto;
        }

        public async Task<ReviewResponseDTO> GetReviewByIdAsync(string ReviewId)
        {
            if (!ObjectId.TryParse(ReviewId, out ObjectId reviewObjectId))
            {
                throw new BadRequestException("Invalid product ID format");
            }

            var review = await _autoPileMongoDbContext.Reviews.FindAsync(reviewObjectId) ?? throw new NotFoundException($"Review with ID {ReviewId} not found");
            return _mapper.Map<ReviewResponseDTO>(review);
        }

        public async Task<IEnumerable<ReviewResponseDTO>> GetReviewsByProductIdAsync(string ProductId)
        {
            if (!ObjectId.TryParse(ProductId, out ObjectId productObjectId))
            {
                throw new BadRequestException("Invalid product ID format");
            }
            _ = await _autoPileMongoDbContext.Products.FindAsync(productObjectId) ?? throw new NotFoundException($"Product with ID {ProductId} not found");

            //var reviewCache = await _reviewsCache.GetReviewAsync(ProductId);
            //if (reviewCache != null)
            //{
            //    return reviewCache;
            //}

            var reviews = await _autoPileMongoDbContext.Reviews.Where(r => r.ProductId == productObjectId).ToListAsync();

            //if (reviews.Any())
            //{
            //    await _reviewsCache.SetReviewAsync(ProductId, _mapper.Map<IEnumerable<ReviewResponseDTO>>(reviews));
            //}

            return _mapper.Map<IEnumerable<ReviewResponseDTO>>(reviews);
        }

        public async Task<ReviewResponseDTO> UpdateReviewAsync(ReviewUpdateDTO reviewUpdateDTO, string reviewId, string applicationUserId)
        {
            _ = await _autoPileManagementDbContext.Users.FindAsync(applicationUserId)
                ?? throw new NotFoundException($"User with ID {applicationUserId} not found");

            if (!ObjectId.TryParse(reviewId, out ObjectId reviewObjectId))
            {
                throw new BadRequestException("Invalid product ID format");
            }

            var review = await _autoPileMongoDbContext.Reviews.FindAsync(reviewObjectId)
                ?? throw new NotFoundException($"Review with ID {reviewId} not found");

            if (review.UserId != applicationUserId)
            {
                throw new ForbiddenException("You are not authorized to update this review");
            }

            if (reviewUpdateDTO.Title != null)
                review.Title = reviewUpdateDTO.Title;
            if (reviewUpdateDTO.Subtitle != null)
                review.Subtitle = reviewUpdateDTO.Subtitle;
            if (reviewUpdateDTO.Content != null)
                review.Content = reviewUpdateDTO.Content;
            if (reviewUpdateDTO.Rating.HasValue)
                review.Rating = reviewUpdateDTO.Rating.Value;

            if (reviewUpdateDTO.Image != null)
            {
                var oldImageUrl = review.ImageUrl;
                if (string.IsNullOrEmpty(oldImageUrl))
                {
                    review.ImageUrl = await _blobService.UploadImageAsync(reviewUpdateDTO.Image);
                }
                else
                {
                    review.ImageUrl = await _blobService.UpdateImageAsync(oldImageUrl, reviewUpdateDTO.Image);
                }
            }
            review.UpdatedAt = DateTime.UtcNow;
            _autoPileMongoDbContext.Update(review);
            await _autoPileMongoDbContext.SaveChangesAsync();

            //await _reviewsCache.UpdateReviewAsync(_mapper.Map<ReviewResponseDTO>(review));
            return _mapper.Map<ReviewResponseDTO>(review);
        }

        public async Task DeleteReviewAsync(string reviewId, string applicationUserId)
        {
            _ = await _autoPileManagementDbContext.Users.FindAsync(applicationUserId)
                ?? throw new NotFoundException($"User with ID {applicationUserId} not found");
            if (!ObjectId.TryParse(reviewId, out ObjectId reviewObjectId))
            {
                throw new BadRequestException("Invalid product ID format");
            }
            var review = await _autoPileMongoDbContext.Reviews.FindAsync(reviewObjectId)
               ?? throw new NotFoundException($"Review with ID {reviewId} not found");
            if (review.UserId != applicationUserId)
            {
                throw new ForbiddenException("You are not authorized to delete this review");
            }
            if (review.ImageUrl != null) { await _blobService.DeleteImageAsync(review.ImageUrl); }
            _autoPileMongoDbContext.Remove(review);
            await _autoPileMongoDbContext.SaveChangesAsync();

            //await _reviewsCache.DeleteReviewAsync(review.ProductId.ToString(), reviewId);
        }
    }
}

================
File: AutoPile.SERVICE/Services/ShoppingCartItemService.cs
================
using AutoMapper;
using AutoPile.DATA.Cache;
using AutoPile.DATA.Data;
using AutoPile.DATA.Exceptions;
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.EntityFrameworkCore;
using MongoDB.Bson;

namespace AutoPile.SERVICE.Services
{
    public class ShoppingCartItemService : IShoppingCartItemService
    {
        private readonly IMapper _mapper;
        private readonly AutoPileManagementDbContext _context;
        private readonly AutoPileMongoDbContext _mongoContext;
        private readonly IRedisShoppingCartCache _redisShoppingCartCache;

        public ShoppingCartItemService(IMapper mapper, AutoPileManagementDbContext context, AutoPileMongoDbContext mongoContext, IRedisShoppingCartCache redisShoppingCartCache)
        {
            _mapper = mapper;
            _context = context;
            _mongoContext = mongoContext;
            _redisShoppingCartCache = redisShoppingCartCache;
        }

        public async Task<ShoppingCartItemResponseDTO> CreateShoppingCartItemAsync(ShoppingCartItemRequestDto shoppingCartItemRequest, string applicationUserId)
        {
            if (string.IsNullOrEmpty(applicationUserId))
            {
                throw new BadRequestException("User Id is null");
            }
            var user = await _context.Users.FindAsync(applicationUserId) ?? throw new NotFoundException($"User with ID {applicationUserId} not found");
            if (!ObjectId.TryParse(shoppingCartItemRequest.ProductId, out ObjectId productObjectId))
            {
                throw new BadRequestException("Invalid product ID format");
            }
            _ = await _mongoContext.Products.FindAsync(productObjectId)
                ?? throw new NotFoundException($"Product with ID {shoppingCartItemRequest.ProductId} not found");

            var existedCartItem = await _context.ShoppingCartItems.FirstOrDefaultAsync(s => s.ProductId == shoppingCartItemRequest.ProductId && s.UserId == applicationUserId);
            if (existedCartItem != null)
            {
                if (existedCartItem.Quantity == 10)
                {
                    return _mapper.Map<ShoppingCartItemResponseDTO>(existedCartItem);
                }
                existedCartItem.Quantity += shoppingCartItemRequest.Quantity;
                if (existedCartItem.Quantity <= 0)
                {
                    // Directly remove from database
                    _context.ShoppingCartItems.Remove(existedCartItem);
                    await _context.SaveChangesAsync();

                    // Remove from Redis cache
                    await _redisShoppingCartCache.RemoveItemAsync(applicationUserId, existedCartItem.Id);

                    // Check if cart is empty and clear Redis cache if needed
                    var cart = await _redisShoppingCartCache.GetUserCartAsync(applicationUserId);
                    if (cart.Count == 0)
                    {
                        await _redisShoppingCartCache.ClearCartAsync(applicationUserId);
                    }

                    return _mapper.Map<ShoppingCartItemResponseDTO>(existedCartItem);
                }

                await _context.SaveChangesAsync();
                await _redisShoppingCartCache.SetItemAsync(existedCartItem);
                return _mapper.Map<ShoppingCartItemResponseDTO>(existedCartItem);
            }
            else
            {
                // Add validation for negative quantity when creating new cart item
                if (shoppingCartItemRequest.Quantity <= 0)
                {
                    throw new BadRequestException("Cannot add item with zero or negative quantity");
                }

                var shoppingCartItem = _mapper.Map<ShoppingCartItem>(shoppingCartItemRequest);
                shoppingCartItem.UserId = applicationUserId;
                shoppingCartItem.CreatedAt = DateTime.UtcNow;
                await _context.ShoppingCartItems.AddAsync(shoppingCartItem);
                await _context.SaveChangesAsync();
                await _redisShoppingCartCache.SetItemAsync(shoppingCartItem);
                var shoppingCartItemDTO = _mapper.Map<ShoppingCartItemResponseDTO>(shoppingCartItem);
                return shoppingCartItemDTO;
            }
        }

        public async Task DeleteShoppingCartItemAsync(int shoppingCartItemId, string applicationUserId)
        {
            var shopppingCartCachedItem = await _redisShoppingCartCache.GetItemAsync(applicationUserId, shoppingCartItemId);
            ShoppingCartItem shoppingCartItem;
            if (shopppingCartCachedItem != null)
            {
                shoppingCartItem = shopppingCartCachedItem;
            }
            else
            {
                shoppingCartItem = await _context.ShoppingCartItems.FindAsync(shoppingCartItemId) ?? throw new NotFoundException($"Shopping cart item with Id {shoppingCartItemId} is not found");
            }

            if (shoppingCartItem.UserId != applicationUserId)
            {
                throw new ForbiddenException("You are not authorized to delete this shopping cart item");
            }
            _context.ShoppingCartItems.Remove(shoppingCartItem);
            await _context.SaveChangesAsync();

            await _redisShoppingCartCache.RemoveItemAsync(applicationUserId, shoppingCartItemId);

            var shoppingCart = await _redisShoppingCartCache.GetUserCartAsync(applicationUserId);
            if (shoppingCart.Count == 0)
            {
                await _redisShoppingCartCache.ClearCartAsync(applicationUserId);
            }
            return;
        }

        public async Task DeleteAllShoppingCartItemsAsync(string applicationUserId)
        {
            var user = await _context.Users.FindAsync(applicationUserId) ?? throw new NotFoundException($"User with ID {applicationUserId} not found");
            var userShoppingCartItems = _context.ShoppingCartItems.Where(item => item.UserId == applicationUserId);

            if (userShoppingCartItems.Count() == 0)
            {
                throw new BadRequestException($"User {applicationUserId}'s Shopping Cart is already emmpty");
            }

            if (userShoppingCartItems.Any(item => item.UserId != applicationUserId))
            {
                throw new ForbiddenException("You are not authorized to delete some of these shopping cart items");
            }

            _context.RemoveRange(userShoppingCartItems);
            await _context.SaveChangesAsync(true);

            var cart = await _redisShoppingCartCache.GetUserCartAsync(applicationUserId);
            if (cart.Count == 0)
            {
                return;
            }
            await _redisShoppingCartCache.ClearCartAsync(applicationUserId);
        }

        public async Task<ShoppingCartItemResponseDTO> GetShoppingCartItemById(int shoppingCartItemId, string applicationUserId)
        {
            var shopppingCartCachedItem = await _redisShoppingCartCache.GetItemAsync(applicationUserId, shoppingCartItemId);
            ShoppingCartItem shoppingCartItem;
            if (shopppingCartCachedItem != null)
            {
                shoppingCartItem = shopppingCartCachedItem;
            }
            else
            {
                shoppingCartItem = await _context.ShoppingCartItems.FindAsync(shoppingCartItemId) ?? throw new NotFoundException($"Shopping cart item with Id {shoppingCartItemId} is not found");
            }

            if (shoppingCartItem.UserId != applicationUserId)
            {
                throw new ForbiddenException("You are not authorized to see this shopping cart item");
            }

            await _redisShoppingCartCache.SetItemAsync(shoppingCartItem);
            return _mapper.Map<ShoppingCartItemResponseDTO>(shoppingCartItem);
        }

        public async Task UpdateShoppingCartItemAsync(UpdateShoppingCartItemDto updateShoppingCartItemDto, int shoppingCartItemId, string? applicationUserId)
        {
            if (string.IsNullOrEmpty(applicationUserId))
            {
                throw new BadRequestException("User Id is null");
            }
            var user = await _context.Users.FindAsync(applicationUserId) ?? throw new NotFoundException($"User with ID {applicationUserId} not found");

            var shoppingCartCachedItem = await _redisShoppingCartCache.GetItemAsync(applicationUserId, shoppingCartItemId);
            ShoppingCartItem shoppingCartItem;
            if (shoppingCartCachedItem != null)
            {
                shoppingCartItem = shoppingCartCachedItem;
            }
            else
            {
                shoppingCartItem = await _context.ShoppingCartItems.FindAsync(shoppingCartItemId) ?? throw new NotFoundException($"Shopping cart item with Id {shoppingCartItemId} is not found");
            }

            if (shoppingCartItem.UserId != applicationUserId)
            {
                throw new ForbiddenException("You are not authorized to modify this shopping cart item");
            }
            _mapper.Map(updateShoppingCartItemDto, shoppingCartItem);
            _context.ShoppingCartItems.Update(shoppingCartItem);
            await _context.SaveChangesAsync();

            await _redisShoppingCartCache.SetItemAsync(shoppingCartItem);
        }

        public async Task<IEnumerable<ShoppingCartItemResponseDTO>> GetShoppingCartItemByUserId(string applicationUserId)
        {
            var shoppingCartItemList = await _context.ShoppingCartItems.Where(s => s.UserId == applicationUserId).ToListAsync();
            return _mapper.Map<IEnumerable<ShoppingCartItemResponseDTO>>(shoppingCartItemList);
        }
    }
}

================
File: AutoPile.SERVICE/Services/StripeService.cs
================
using Stripe;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.SERVICE.Services
{
    public class StripeService : IStripeService
    {
        public async Task<PaymentIntent> CreatePaymentIntentAsync(long amount, string currency)
        {
            var options = new PaymentIntentCreateOptions
            {
                Amount = amount,
                Currency = currency,
                AutomaticPaymentMethods = new PaymentIntentAutomaticPaymentMethodsOptions
                {
                    Enabled = true,
                },
            };
            var service = new PaymentIntentService();
            return await service.CreateAsync(options);
        }
    }
}

================
File: AutoPile.SERVICE/Utilities/EmailConfirmationHtmlTemplates.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.SERVICE.Utilities
{
    public static class EmailConfirmationHtmlTemplates
    {
        public static string GetEmailConfirmationHtml(bool isConfirmed) => isConfirmed
            ? SuccessTemplate
            : ErrorTemplate;

        private static string SuccessTemplate => @"
        <!DOCTYPE html>
        <html>
        <head>
            <title>Email Confirmation</title>
            <style>
                body {
                    margin: 0;
                    padding: 0;
                    min-height: 100vh;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }
                .container {
                    background: rgba(255, 255, 255, 0.95);
                    padding: 2.5rem 3rem;
                    border-radius: 20px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                    text-align: center;
                    max-width: 500px;
                    width: 90%;
                    transform: translateY(-20px);
                    animation: slideUp 0.5s ease forwards;
                }
                @keyframes slideUp {
                    to {
                        transform: translateY(0);
                        opacity: 1;
                    }
                }
                .icon {
                    width: 80px;
                    height: 80px;
                    background: #4CAF50;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 1.5rem;
                }
                .icon svg {
                    width: 40px;
                    height: 40px;
                    fill: white;
                }
                h1 {
                    color: #2d3748;
                    margin: 0 0 1rem;
                    font-size: 1.8rem;
                    font-weight: 600;
                }
                p {
                    color: #718096;
                    line-height: 1.6;
                    margin: 0;
                    font-size: 1.1rem;
                }
            </style>
        </head>
        <body>
            <div class='container'>
                <div class='icon'>
                    <svg viewBox='0 0 24 24'>
                        <path d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z'/>
                    </svg>
                </div>
                <h1>Email Verified!</h1>
                <p>Your email address has been successfully verified.</p>
                <p>You can now close this window and continue using AutoPile.</p>
            </div>
        </body>
        </html>";

        private static string ErrorTemplate => @"
        <!DOCTYPE html>
        <html>
        <head>
            <title>Email Confirmation Failed</title>
            <style>
                body {
                    margin: 0;
                    padding: 0;
                    min-height: 100vh;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }
                .container {
                    background: rgba(255, 255, 255, 0.95);
                    padding: 2.5rem 3rem;
                    border-radius: 20px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                    text-align: center;
                    max-width: 450px;
                    width: 90%;
                    transform: translateY(-20px);
                    animation: slideUp 0.5s ease forwards;
                }
                @keyframes slideUp {
                    to {
                        transform: translateY(0);
                        opacity: 1;
                    }
                }
                .icon {
                    width: 80px;
                    height: 80px;
                    background: #f56565;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 1.5rem;
                }
                .icon svg {
                    width: 40px;
                    height: 40px;
                    fill: white;
                }
                h1 {
                    color: #2d3748;
                    margin: 0 0 1rem;
                    font-size: 1.8rem;
                    font-weight: 600;
                }
                p {
                    color: #718096;
                    line-height: 1.6;
                    margin: 0;
                    font-size: 1.1rem;
                }
            </style>
        </head>
        <body>
            <div class='container'>
                <div class='icon'>
                    <svg viewBox='0 0 24 24'>
                        <path d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z'/>
                    </svg>
                </div>
                <h1>Verification Failed</h1>
                <p>The verification link appears to be invalid or has expired.</p>
                <p>Please request a new verification email and try again.</p>
                <p>Alternatively, you might have already verified your email.</p>
            </div>
        </body>
        </html>";
    }
}

================
File: AutoPile.SERVICE/Utilities/JwtTokenGenerator.cs
================
using AutoPile.DOMAIN.Models.Entities;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.Configuration;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace AutoPile.SERVICE.Utilities
{
    public class JwtTokenGenerator : IJwtTokenGenerator
    {
        private readonly IConfiguration _configuration;
        private readonly UserManager<ApplicationUser> _userManager;

        public JwtTokenGenerator(IConfiguration configuration, UserManager<ApplicationUser> userManager)
        {
            _configuration = configuration;
            _userManager = userManager;
        }

        public string GenerateJwtToken(ApplicationUser user)
        {
            var claims = new List<Claim>
            {
                new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString()),
                new Claim(ClaimTypes.NameIdentifier, user.Id),
            };
            var roles = _userManager.GetRolesAsync(user).Result;
            foreach (var role in roles)
            {
                claims.Add(new Claim(ClaimTypes.Role, role));
            }
            string scope = roles.Contains("Admin") ? "admin" : "user";
            claims.Add(new Claim("scope", scope));
            var jwtKey = Environment.GetEnvironmentVariable("JWTKEY") ?? _configuration["Jwt:Key"];
            if (string.IsNullOrWhiteSpace(jwtKey))
            {
                throw new InvalidOperationException("JWT Key is not configured. Please set the 'JWTKEY' environment variable or provide a valid key in appsettings.json.");
            }
            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtKey));
            var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

            var token = new JwtSecurityToken(
                issuer: Environment.GetEnvironmentVariable("ISSUER") ?? _configuration["Jwt:Issuer"],
                audience: Environment.GetEnvironmentVariable("AUDIENCE") ?? _configuration["Jwt:Audience"],
                claims: claims,
                expires: DateTime.Now.AddMinutes(30),
                signingCredentials: creds
            );
            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}

================
File: AutoPile.SERVICE/Utilities/OrderNumberGenerator.cs
================
using System;

public class OrderNumberGenerator
{
    /// <summary>
    /// Generates a sequential order number using GUID and timestamp
    /// </summary>
    /// <param name="prefix">Optional prefix for the order number</param>
    /// <returns>A timestamp-based order number with GUID portion</returns>
    public static string GenerateSequentialOrderNumber(string prefix = "ORD-")
    {
        // Get current timestamp
        string timestamp = DateTime.UtcNow.ToString("yyyyMMddHHmmss");

        // Get last 6 digits of GUID for uniqueness
        string guidPart = Guid.NewGuid().ToString("N").Substring(0, 6);

        return $"{prefix}{timestamp}-{guidPart}";
    }
}

================
File: AutoPile.SERVICE/Utilities/RefreshTokenGenerator.cs
================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.SERVICE.Utilities
{
    public class RefreshTokenGenerator
    {
        public static string GenerateRefreshToken()
        {
            var randomNumber = new byte[64];
            using var rng = RandomNumberGenerator.Create();
            rng.GetBytes(randomNumber);
            return Convert.ToBase64String(randomNumber);
        }
    }
}

================
File: AutoPile.sln
================
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.12.35527.113
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "AutoPile.DATA", "AutoPile.DATA\AutoPile.DATA.csproj", "{533EABB9-3898-4040-925E-17DD47E8F5D5}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "AutoPile.DOMAIN", "AutoPile.DOMAIN\AutoPile.DOMAIN.csproj", "{CA080B5B-82EF-47AC-BC4C-B798D3FBFD7B}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "AutoPile.SERVICE", "AutoPile.SERVICE\AutoPile.SERVICE.csproj", "{2FB5F0EF-1D1E-472D-B0B1-4C5B5005E239}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "AutoPile.API", "AutoPile.API\AutoPile.API.csproj", "{3DDF33AA-990E-4BA9-AC47-29E2EB706D0C}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "AutoPile.UnitTests", "AutoPile.UnitTests\AutoPile.UnitTests.csproj", "{D8051ACC-12FD-4ED0-BE59-5D937D0A1A84}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{533EABB9-3898-4040-925E-17DD47E8F5D5}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{533EABB9-3898-4040-925E-17DD47E8F5D5}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{533EABB9-3898-4040-925E-17DD47E8F5D5}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{533EABB9-3898-4040-925E-17DD47E8F5D5}.Release|Any CPU.Build.0 = Release|Any CPU
		{CA080B5B-82EF-47AC-BC4C-B798D3FBFD7B}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{CA080B5B-82EF-47AC-BC4C-B798D3FBFD7B}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{CA080B5B-82EF-47AC-BC4C-B798D3FBFD7B}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{CA080B5B-82EF-47AC-BC4C-B798D3FBFD7B}.Release|Any CPU.Build.0 = Release|Any CPU
		{2FB5F0EF-1D1E-472D-B0B1-4C5B5005E239}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{2FB5F0EF-1D1E-472D-B0B1-4C5B5005E239}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{2FB5F0EF-1D1E-472D-B0B1-4C5B5005E239}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{2FB5F0EF-1D1E-472D-B0B1-4C5B5005E239}.Release|Any CPU.Build.0 = Release|Any CPU
		{3DDF33AA-990E-4BA9-AC47-29E2EB706D0C}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{3DDF33AA-990E-4BA9-AC47-29E2EB706D0C}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{3DDF33AA-990E-4BA9-AC47-29E2EB706D0C}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{3DDF33AA-990E-4BA9-AC47-29E2EB706D0C}.Release|Any CPU.Build.0 = Release|Any CPU
		{D8051ACC-12FD-4ED0-BE59-5D937D0A1A84}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{D8051ACC-12FD-4ED0-BE59-5D937D0A1A84}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{D8051ACC-12FD-4ED0-BE59-5D937D0A1A84}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{D8051ACC-12FD-4ED0-BE59-5D937D0A1A84}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
EndGlobal

================
File: AutoPile.UnitTests/AuthServiceTests.cs
================
using AutoMapper;
using AutoPile.DATA.Cache;
using AutoPile.DATA.Exceptions;
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Models.Entities;
using AutoPile.SERVICE.Services;
using AutoPile.SERVICE.Utilities;
using FluentAssertions;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using Moq;
using Resend;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AutoPile.UnitTests
{
    public class AuthServiceTests
    {
        private readonly Mock<UserManager<ApplicationUser>> _userManagerMock;
        private readonly Mock<IMapper> _mapperMock;
        private readonly Mock<IJwtTokenGenerator> _jwtTokenGeneratorMock;
        private readonly Mock<IResend> _resendMock;
        private readonly Mock<IConfiguration> _configurationMock;
        private readonly Mock<IEmailQueueService> _emailQueueServiceMock;
        private readonly Mock<IUserInfoCache> _userInfoCacheMock;
        private readonly Mock<ILogger<IAuthService>> _loggerMock;
        private readonly AuthService _authServiceMock;

        public AuthServiceTests()
        {
            var storeMock = new Mock<IUserStore<ApplicationUser>>();
            _userManagerMock = new Mock<UserManager<ApplicationUser>>(
           storeMock.Object,
           null, // IOptions<IdentityOptions>
           null, // IPasswordHasher<ApplicationUser>
           null, // IEnumerable<IUserValidator<ApplicationUser>>
           null, // IEnumerable<IPasswordValidator<ApplicationUser>>
           null, // ILookupNormalizer
           null, // IdentityErrorDescriber
           null, // IServiceProvider
           null  // ILogger<UserManager<ApplicationUser>>
       );
            _mapperMock = new Mock<IMapper>();
            _userInfoCacheMock = new Mock<IUserInfoCache>();
            _jwtTokenGeneratorMock = new Mock<IJwtTokenGenerator>();
            _configurationMock = new Mock<IConfiguration>();
            _resendMock = new Mock<IResend>();
            _emailQueueServiceMock = new Mock<IEmailQueueService>();
            _loggerMock = new Mock<ILogger<IAuthService>>();
            _authServiceMock = new AuthService(_userManagerMock.Object, _loggerMock.Object, _emailQueueServiceMock.Object,
                _configurationMock.Object, _mapperMock.Object, _userInfoCacheMock.Object, _jwtTokenGeneratorMock.Object, _resendMock.Object);
        }

        [Fact]
        public async Task SignUpUser_ValidInput_ReturnUserResponseDTO()
        {
            // Arrange
            var password = "TestPassword";
            var userSignUpDTO = new UserSignupDTO()
            {
                FirstName = "firstName",
                LastName = "lastName",
                UserName = "TestUserName",
                PhoneNumber = "TestPhoneNumber",
                Email = "TestEmail",
                Password = password
            };

            _mapperMock.Setup(m => m.Map<ApplicationUser>(It.IsAny<UserSignupDTO>()))
                .Returns(new ApplicationUser
                {
                    UserName = userSignUpDTO.UserName,
                    Email = userSignUpDTO.Email,
                    FirstName = userSignUpDTO.FirstName,
                    LastName = userSignUpDTO.LastName,
                    PhoneNumber = userSignUpDTO.PhoneNumber,
                    Id = "TestId"
                });

            _mapperMock.Setup(m => m.Map<UserResponseDTO>(It.IsAny<ApplicationUser>()))
                .Returns(new UserResponseDTO
                {
                    UserName = userSignUpDTO.UserName,
                    Email = userSignUpDTO.Email,
                    Id = "TestId"
                });

            _userManagerMock.Setup(u => u.FindByEmailAsync(userSignUpDTO.Email))
                .ReturnsAsync(null as ApplicationUser);

            _userManagerMock.Setup(u => u.Users)
                .Returns(new List<ApplicationUser>().AsQueryable());

            _userManagerMock.Setup(u => u.CreateAsync(It.IsAny<ApplicationUser>(), password))
                .ReturnsAsync(IdentityResult.Success);

            _userManagerMock.Setup(u => u.AddToRoleAsync(It.IsAny<ApplicationUser>(), "User"))
                .ReturnsAsync(IdentityResult.Success);

            _userManagerMock.Setup(u => u.GetRolesAsync(It.IsAny<ApplicationUser>()))
                .ReturnsAsync(["User"]);

            _jwtTokenGeneratorMock.Setup(t => t.GenerateJwtToken(It.IsAny<ApplicationUser>()))
                .Returns("test_access_token");

            // Act
            var result = await _authServiceMock.SignupUserAsync(userSignUpDTO);

            // Assert
            result.Should().NotBeNull();
            var (userResponse, accessToken, refreshToken) = result;

            userResponse.Should().NotBeNull();
            userResponse.Should().BeOfType<UserResponseDTO>();
            userResponse.UserName.Should().Be(userSignUpDTO.UserName);
            userResponse.Email.Should().Be(userSignUpDTO.Email);
            userResponse.Roles.Should().Contain("User");

            accessToken.Should().Be("test_access_token");
            refreshToken.Should().NotBeNull();

            _userManagerMock.Verify(u => u.CreateAsync(It.IsAny<ApplicationUser>(), password), Times.Once);
            _userManagerMock.Verify(u => u.AddToRoleAsync(It.IsAny<ApplicationUser>(), "User"), Times.Once);
            _jwtTokenGeneratorMock.Verify(t => t.GenerateJwtToken(It.IsAny<ApplicationUser>()), Times.Once);
        }

        [Fact]
        public async Task SignInUser_ValidInput_ReturnUserResponseDTO()
        {
            //Arrange
            var password = "TestPassword";
            var userSignUpDTO = new UserSignupDTO()
            {
                FirstName = "firstName",
                LastName = "lastName",
                UserName = "TestUserName",
                PhoneNumber = "TestPhoneNumber",
                Email = "TestEmail",
                Password = password
            };

            var userSigninDTO = new UserSigninDTO()
            {
                Email = "TestEmail",
                Password = password
            };

            var user = new ApplicationUser
            {
                UserName = userSignUpDTO.UserName,
                Email = userSignUpDTO.Email,
                FirstName = userSignUpDTO.FirstName,
                LastName = userSignUpDTO.LastName,
                PhoneNumber = userSignUpDTO.PhoneNumber,
                Id = "TestId"
            };
            _userManagerMock.Setup(u => u.FindByEmailAsync(userSignUpDTO.Email)).ReturnsAsync(user);
            _userManagerMock.Setup(u => u.CheckPasswordAsync(It.IsAny<ApplicationUser>(), password)).ReturnsAsync(true);
            _jwtTokenGeneratorMock.Setup(t => t.GenerateJwtToken(It.IsAny<ApplicationUser>())).Returns("test_access_token");

            _mapperMock.Setup(m => m.Map<UserResponseDTO>(user)).Returns(new UserResponseDTO
            {
                UserName = userSignUpDTO.UserName,
                Email = userSignUpDTO.Email,
                Id = "TestId",
            });

            _userManagerMock.Setup(u => u.GetRolesAsync(It.IsAny<ApplicationUser>()))
                .ReturnsAsync(["User"]);

            //Act
            var result = await _authServiceMock.SigninAsync(userSigninDTO);

            //Assert
            result.Should().NotBeNull();
            var (userResponse, accessToken, refreshToken) = result;

            userResponse.Should().NotBeNull();
            userResponse.Should().BeOfType<UserResponseDTO>();
            userResponse.UserName.Should().Be(userSignUpDTO.UserName);
            userResponse.Email.Should().Be(userSignUpDTO.Email);
            userResponse.Roles.Should().Contain("User");

            accessToken.Should().Be("test_access_token");
            refreshToken.Should().NotBeNull();

            _userManagerMock.Verify(u => u.CheckPasswordAsync(It.IsAny<ApplicationUser>(), password), Times.Once);
            _jwtTokenGeneratorMock.Verify(t => t.GenerateJwtToken(It.IsAny<ApplicationUser>()), Times.Once);
            _userManagerMock.Verify(u => u.GetRolesAsync(It.IsAny<ApplicationUser>()), Times.Once);
        }

        [Fact]
        public async Task SigninUser_WrongCredentialInput_ReturnNoFoundException()
        {
            //Arrange
            var password = "TestPassword";
            var userSignUpDTO = new UserSignupDTO()
            {
                FirstName = "firstName",
                LastName = "lastName",
                UserName = "TestUserName",
                PhoneNumber = "TestPhoneNumber",
                Email = "TestEmail",
                Password = password
            };
            var userSignInDTO = new UserSigninDTO()
            {
                Email = "TestEmail",
                Password = password
            };
            var user = new ApplicationUser
            {
                UserName = userSignUpDTO.UserName,
                Email = userSignUpDTO.Email,
                FirstName = userSignUpDTO.FirstName,
                LastName = userSignUpDTO.LastName,
                PhoneNumber = userSignUpDTO.PhoneNumber,
                Id = "TestId"
            };
            _userManagerMock.Setup(u => u.FindByEmailAsync(userSignUpDTO.Email)).ReturnsAsync(user);
            _userManagerMock.Setup(u => u.CheckPasswordAsync(user, password)).ReturnsAsync(false);

            //Act & Assert
            await _authServiceMock.Invoking(x => x.SigninAsync(userSignInDTO))
                .Should().ThrowAsync<NotFoundException>()
                .WithMessage("Email does not exist or incorrect password");
        }
    }
}

================
File: AutoPile.UnitTests/AutoPile.UnitTests.csproj
================
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <IsPackable>false</IsPackable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="coverlet.collector" Version="6.0.2" />
    <PackageReference Include="FluentAssertions" Version="8.0.1" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.InMemory" Version="9.0.2" />
    <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.11.1" />
    <PackageReference Include="Moq" Version="4.20.72" />
    <PackageReference Include="xunit" Version="2.9.2" />
    <PackageReference Include="xunit.runner.visualstudio" Version="2.8.2" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\AutoPile.API\AutoPile.API.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Using Include="Xunit" />
  </ItemGroup>

</Project>

================
File: AutoPile.UnitTests/PaymentServiceTests.cs
================
using AutoPile.DATA.Data;
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.Models.Entities;
using AutoPile.SERVICE.Services;
using Microsoft.EntityFrameworkCore;
using MongoDB.Bson;
using Moq;
using Stripe;
using FluentAssertions;
using Xunit;

namespace AutoPile.UnitTests
{
    public class PaymentServiceTests
    {
        private readonly Mock<AutoPileMongoDbContext> _mongoDbContextMock;
        private readonly Mock<IStripeService> _stripeServiceMock;
        private readonly PaymentService _paymentService;

        public PaymentServiceTests()
        {
            _mongoDbContextMock = new Mock<AutoPileMongoDbContext>(new DbContextOptionsBuilder<AutoPileMongoDbContext>().Options);
            _stripeServiceMock = new Mock<IStripeService>();
            _paymentService = new PaymentService(_mongoDbContextMock.Object, _stripeServiceMock.Object);
        }

        [Fact]
        public async Task CreatePaymentIntent_ValidItemListInput_ReturnSecretObject()
        {
            // Arrange
            var productId = ObjectId.GenerateNewId();
            var product = new DOMAIN.Models.Entities.Product { Id = productId, Price = 100 };
            var item = new Item { ProductId = productId.ToString(), Quantity = 2 };
            var itemList = new PaymentIntentCreate { Items = [item] };

            _mongoDbContextMock.Setup(x => x.Products.FindAsync(productId))
                .ReturnsAsync(product);

            var mockPaymentIntent = new PaymentIntent
            {
                ClientSecret = "mock_client_secret_test"
            };

            _stripeServiceMock.Setup(x => x.CreatePaymentIntentAsync(It.IsAny<long>(), It.IsAny<string>()))
                .ReturnsAsync(mockPaymentIntent);

            // Act
            var result = await _paymentService.PaymentIntentCreateAsync(itemList);

            // Assert
            Assert.NotNull(result);
            result.ClientSecret.Should().Be("mock_client_secret_test");
        }
    }
}

================
File: AutoPile.UnitTests/ReviewServiceTests.cs
================
using AutoMapper;
using AutoPile.DATA.Cache;
using AutoPile.DATA.Data;
using AutoPile.DOMAIN.DTOs.Requests;
using AutoPile.DOMAIN.DTOs.Responses;
using AutoPile.DOMAIN.Interface;
using AutoPile.DOMAIN.Models.Entities;
using AutoPile.SERVICE.Services;
using FluentAssertions;
using Microsoft.EntityFrameworkCore;
using MongoDB.Bson;
using MongoDB.Driver;
using Moq;
using System.Linq.Expressions;
using Xunit;

namespace AutoPile.UnitTests
{
    public class ReviewServiceTests
    {
        private readonly Mock<IMapper> _mapperMock;
        private readonly Mock<IBlobService> _blobServiceMock;
        private readonly Mock<AutoPileMongoDbContext> _mongoDbContextMock;
        private readonly Mock<AutoPileManagementDbContext> _managementDbContextMock;
        private readonly Mock<IReviewsCache> _reviewsCacheMock;
        private readonly ReviewService _reviewService;
        private readonly Mock<DbSet<Review>> _reviewsDbSetMock;
        private readonly Mock<DbSet<Product>> _productsDbSetMock;
        private readonly Mock<DbSet<ApplicationUser>> _usersDbSetMock;

        public ReviewServiceTests()
        {
            _mapperMock = new Mock<IMapper>();
            _blobServiceMock = new Mock<IBlobService>();
            _mongoDbContextMock = new Mock<AutoPileMongoDbContext>(new DbContextOptionsBuilder<AutoPileMongoDbContext>().Options);
            _managementDbContextMock = new Mock<AutoPileManagementDbContext>(new DbContextOptions<AutoPileManagementDbContext>());
            _reviewsCacheMock = new Mock<IReviewsCache>();
            _reviewsDbSetMock = new Mock<DbSet<Review>>();
            _productsDbSetMock = new Mock<DbSet<Product>>();
            _usersDbSetMock = new Mock<DbSet<ApplicationUser>>();

            _mongoDbContextMock.Setup(x => x.Reviews).Returns(_reviewsDbSetMock.Object);
            _mongoDbContextMock.Setup(x => x.Products).Returns(_productsDbSetMock.Object);
            _managementDbContextMock.Setup(x => x.Users).Returns(_usersDbSetMock.Object);

            _reviewService = new ReviewService(
                _mapperMock.Object,
                _blobServiceMock.Object,
                _mongoDbContextMock.Object,
                _managementDbContextMock.Object,
                _reviewsCacheMock.Object
            );
            var userId = "testUserId";
            var user = new ApplicationUser { Id = userId };
            _managementDbContextMock.Setup(x => x.Users.FindAsync(userId))
                .ReturnsAsync(user);
        }

        [Fact]
        public async Task CreateReviewAsync_ValidInput_ReturnsReviewResponseDTO()
        {
            // Arrange

            var productId = ObjectId.GenerateNewId().ToString();

            var reviewCreateDto = new ReviewCreateDTO
            {
                ProductId = productId,
                Title = "Test Review",
                Content = "Test Content",
                Subtitle = "Test Subtitle",
                Rating = 5
            };

            var product = new Product { Id = ObjectId.Parse(productId) };

            var review = new Review
            {
                Id = ObjectId.GenerateNewId(),
                Title = reviewCreateDto.Title,
                Content = reviewCreateDto.Content,
                Subtitle = reviewCreateDto.Subtitle,
                Rating = reviewCreateDto.Rating,
                UserId = "testUserId",
                ProductId = ObjectId.Parse(productId)
            };

            var reviewResponseDto = new ReviewResponseDTO
            {
                Id = review.Id.ToString(),
                Title = review.Title,
                Content = review.Content,
                Subtitle = review.Subtitle,
                Rating = review.Rating,
                UserId = review.UserId,
                ProductId = review.ProductId.ToString(),
                CreatedAt = review.CreatedAt,
                UpdatedAt = review.CreatedAt
            };

            _mongoDbContextMock.Setup(x => x.Products.FindAsync(ObjectId.Parse(productId)))
                .ReturnsAsync(product);

            _mapperMock.Setup(x => x.Map<Review>(reviewCreateDto))
                .Returns(review);

            _mapperMock.Setup(x => x.Map<ReviewResponseDTO>(review))
                .Returns(reviewResponseDto);

            // Act
            var result = await _reviewService.CreateReviewAsync(reviewCreateDto, "testUserId");

            // Assert
            Assert.NotNull(result);
            result.Should().BeEquivalentTo(reviewResponseDto);

            _mongoDbContextMock.Verify(x => x.Reviews.AddAsync(review, default), Times.Once);
            _mongoDbContextMock.Verify(x => x.SaveChangesAsync(default), Times.Once);
        }

        [Fact]
        public async Task GetReview_ValidInput_ReturnResponseDTO()
        {
            //Arrange
            var productId = ObjectId.GenerateNewId();
            var review = new Review
            {
                Id = ObjectId.GenerateNewId(),
                ProductId = productId,
                Title = "Test Review",
                Content = "Test Content",
                Subtitle = "Test Subtitle",
                UserId = "testUserId",
                Rating = 5
            };

            var reviewResponseDto = new ReviewResponseDTO
            {
                Id = review.Id.ToString(),
                Title = review.Title,
                Content = review.Content,
                Subtitle = review.Subtitle,
                Rating = review.Rating,
                UserId = review.UserId,
                ProductId = review.ProductId.ToString(),
                CreatedAt = review.CreatedAt,
                UpdatedAt = review.CreatedAt
            };
            _mongoDbContextMock.Setup(x => x.Reviews.FindAsync(review.Id)).ReturnsAsync(review);
            _mapperMock.Setup(x => x.Map<ReviewResponseDTO>(review))
        .Returns(reviewResponseDto);

            //Act
            var result = await _reviewService.GetReviewByIdAsync(review.Id.ToString());

            //Assert
            result.Should().NotBeNull();
            result.Should().BeEquivalentTo(reviewResponseDto);
        }

        [Fact]
        public async Task DeleteReview_ValidInput_NoReturn()
        {
            //Arrange
            var productId = ObjectId.GenerateNewId();
            var review = new Review
            {
                Id = ObjectId.GenerateNewId(),
                ProductId = productId,
                Title = "Test Review",
                Content = "Test Content",
                Subtitle = "Test Subtitle",
                UserId = "testUserId",
                Rating = 5,
                ImageUrl = "test-image.jpg"
            };

            var reviewResponseDto = new ReviewResponseDTO
            {
                Id = review.Id.ToString(),
                Title = review.Title,
                Content = review.Content,
                Subtitle = review.Subtitle,
                Rating = review.Rating,
                UserId = review.UserId,
                ProductId = review.ProductId.ToString(),
                CreatedAt = review.CreatedAt,
                UpdatedAt = review.CreatedAt
            };
            _mongoDbContextMock.Setup(x => x.Reviews.FindAsync(review.Id)).ReturnsAsync(review);
            _mapperMock.Setup(x => x.Map<ReviewResponseDTO>(review))
        .Returns(reviewResponseDto);
            //Act
            await _reviewService.DeleteReviewAsync(review.Id.ToString(), "testUserId");

            //Assert
            _mongoDbContextMock.Verify(x => x.Remove(review), Times.Once);
            _blobServiceMock.Verify(x => x.DeleteImageAsync(review.ImageUrl), Times.Once);
        }
    }
}
